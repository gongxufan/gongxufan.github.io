<?xml version="1.0" encoding="utf-8"?>
<search> 
  
    
    <entry>
      <title><![CDATA[hexo使用next主题统计文章字符和阅读时长]]></title>
      <url>/2017/11/10/hexo-word-count/</url>
      <content type="html"><![CDATA[<p>next主题已经集成了字数统计和阅读时长功能，只是默认没有开启。打开主题的配置文件_config.yml,更改以下配置：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">post_wordcount:</span><br><span class="line">  item_text: true</span><br><span class="line">  wordcount: true</span><br><span class="line">  min2read: true</span><br><span class="line">  totalcount: true</span><br><span class="line">  separated_meta: true</span><br></pre></td></tr></table></figure></p>
<p>然后安装hexo-wordcount插件，注意这里不能安装默认的3.x版本，不然编译会报错：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">ERROR Plugin load failed: hexo-wordcount</span><br><span class="line">SyntaxError: Unexpected token &#123;</span><br><span class="line">    at Object.exports.runInThisContext (vm.js:53:16)</span><br><span class="line">    at /home/gongxufan/project/github/hexo-site/node_modules/_hexo@3.4.0@hexo/lib/hexo/index.js:230:17</span><br><span class="line">    at tryCatcher (/home/gongxufan/project/github/hexo-site/node_modules/_bluebird@3.5.1@bluebird/js/release/util.js:16:23)</span><br><span class="line">    at Promise._settlePromiseFromHandler (/home/gongxufan/project/github/hexo-site/node_modules/_bluebird@3.5.1@bluebird/js/release/promise.js:512:31)</span><br><span class="line">    at Promise._settlePromise (/home/gongxufan/project/github/hexo-site/node_modules/_bluebird@3.5.1@bluebird/js/release/promise.js:569:18)</span><br><span class="line">    at Promise._settlePromise0 (/home/gongxufan/project/github/hexo-site/node_modules/_bluebird@3.5.1@bluebird/js/release/promise.js:614:10)</span><br><span class="line">    at Promise._settlePromises (/home/gongxufan/project/github/hexo-site/node_modules/_bluebird@3.5.1@bluebird/js/release/promise.js:693:18)</span><br><span class="line">    at Promise._fulfill (/home/gongxufan/project/github/hexo-site/node_modules/_bluebird@3.5.1@bluebird/js/release/promise.js:638:18)</span><br><span class="line">    at Promise._resolveCallback (/home/gongxufan/project/github/hexo-site/node_modules/_bluebird@3.5.1@bluebird/js/release/promise.js:432:57)</span><br><span class="line">    at Promise._settlePromiseFromHandler (/home/gongxufan/project/github/hexo-site/node_modules/_bluebird@3.5.1@bluebird/js/release/promise.js:524:17)</span><br><span class="line">    at Promise._settlePromise (/home/gongxufan/project/github/hexo-site/node_modules/_bluebird@3.5.1@bluebird/js/release/promise.js:569:18)</span><br><span class="line">    at Promise._settlePromise0 (/home/gongxufan/project/github/hexo-site/node_modules/_bluebird@3.5.1@bluebird/js/release/promise.js:614:10)</span><br><span class="line">    at Promise._settlePromises (/home/gongxufan/project/github/hexo-site/node_modules/_bluebird@3.5.1@bluebird/js/release/promise.js:693:18)</span><br><span class="line">    at Promise._fulfill (/home/gongxufan/project/github/hexo-site/node_modules/_bluebird@3.5.1@bluebird/js/release/promise.js:638:18)</span><br><span class="line">    at /home/gongxufan/project/github/hexo-site/node_modules/_bluebird@3.5.1@bluebird/js/release/nodeback.js:42:21</span><br><span class="line">    at /home/gongxufan/project/github/hexo-site/node_modules/_graceful-fs@4.1.11@graceful-fs/graceful-fs.js:78:16</span><br><span class="line">    at FSReqWrap.readFileAfterClose [as oncomplete] (fs.js:380:3)</span><br></pre></td></tr></table></figure></p>
<p>这应该是该插件和我的hexo版本不兼容，我的程序版本信息如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">gongxufan@gongxufan-ThinkPad-E460 ~/project/github/hexo-site $ hexo -v</span><br><span class="line">hexo: 3.4.0</span><br><span class="line">hexo-cli: 1.0.4</span><br><span class="line">os: Linux 4.8.0-53-generic linux x64</span><br><span class="line">http_parser: 2.5.0</span><br><span class="line">node: 4.2.6</span><br><span class="line">v8: 4.5.103.35</span><br><span class="line">uv: 1.8.0</span><br><span class="line">zlib: 1.2.8</span><br><span class="line">ares: 1.10.1-DEV</span><br><span class="line">icu: 55.1</span><br><span class="line">modules: 46</span><br><span class="line">openssl: 1.0.2g-fips</span><br></pre></td></tr></table></figure></p>
<p>指定老的版本即可：<code>cnpm install hexo-wordcount@2 --save</code>,查看package.json：<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"hexo-site"</span>,</span><br><span class="line">  <span class="attr">"version"</span>: <span class="string">"0.0.0"</span>,</span><br><span class="line">  <span class="attr">"private"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">"hexo"</span>: &#123;</span><br><span class="line">    <span class="attr">"version"</span>: <span class="string">"3.4.0"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"dependencies"</span>: &#123;</span><br><span class="line">    <span class="attr">"hexo"</span>: <span class="string">"^3.2.0"</span>,</span><br><span class="line">    <span class="attr">"hexo-deployer-git"</span>: <span class="string">"^0.3.1"</span>,</span><br><span class="line">    <span class="attr">"hexo-deployer-heroku"</span>: <span class="string">"^0.1.2"</span>,</span><br><span class="line">    <span class="attr">"hexo-generator-archive"</span>: <span class="string">"^0.1.4"</span>,</span><br><span class="line">    <span class="attr">"hexo-generator-category"</span>: <span class="string">"^0.1.3"</span>,</span><br><span class="line">    <span class="attr">"hexo-generator-index"</span>: <span class="string">"^0.2.0"</span>,</span><br><span class="line">    <span class="attr">"hexo-generator-search"</span>: <span class="string">"^2.1.1"</span>,</span><br><span class="line">    <span class="attr">"hexo-generator-tag"</span>: <span class="string">"^0.2.0"</span>,</span><br><span class="line">    <span class="attr">"hexo-renderer-ejs"</span>: <span class="string">"^0.3.0"</span>,</span><br><span class="line">    <span class="attr">"hexo-renderer-marked"</span>: <span class="string">"^0.3.0"</span>,</span><br><span class="line">    <span class="attr">"hexo-renderer-stylus"</span>: <span class="string">"^0.3.1"</span>,</span><br><span class="line">    <span class="attr">"hexo-server"</span>: <span class="string">"^0.2.0"</span>,</span><br><span class="line">    <span class="attr">"hexo-wordcount"</span>: <span class="string">"^2.0.1"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果需要增加具体的描述可以修改themes/next/layout/_macro/post.swig文件，增加具体的字数和时长单位。<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> <span class="tag">&lt;<span class="name">span</span> <span class="attr">title</span>=<span class="string">"&#123;&#123; __('post.wordcount') &#125;&#125;"</span>&gt;</span></span><br><span class="line">         &#123;&#123; wordcount(post.content) &#125;&#125; 字</span><br><span class="line">  <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">&#123;% if theme.post_wordcount.item_text %&#125;</span><br><span class="line">   <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"post-meta-item-text"</span>&gt;</span>&#123;&#123; __('post.min2read') &#125;&#125;≈<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">     &#123;% endif %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span> <span class="attr">title</span>=<span class="string">"&#123;&#123; __('post.min2read') &#125;&#125;"</span>&gt;</span></span><br><span class="line">     &#123;&#123; min2read(post.content) &#125;&#125; 分钟</span><br><span class="line">     <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>最后重新编译部署即可，效果如下：<br><img src="/upload/images/hexo/count.png" alt="img"></p>
]]></content>
      
        <categories>
            
            <category> 随笔 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> hexo </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[如何将hexo生成的文章置顶]]></title>
      <url>/2017/11/10/hexo-post-top/</url>
      <content type="html"><![CDATA[<p>关于hexo的安装和配置直接参考官方的文档：<a href="https://hexo.io/zh-cn/docs/" target="_blank" rel="external">https://hexo.io/zh-cn/docs/</a></p>
<h2 id="首页代码代码如何生成？"><a href="#首页代码代码如何生成？" class="headerlink" title="首页代码代码如何生成？"></a>首页代码代码如何生成？</h2><p>hexo使用nodejs开发的各种插件程序来实现静态网站的动态化操作，首页是通过插件hexo-generator-index进行数据处理的，在项目的node_modules下可以找到该程序。<br>我这边的位置是：<br>/home/gongxufan/project/github/hexo-site/node_modules/hexo-generator-index/lib/generator.js。其代码如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">'use strict'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> pagination = <span class="built_in">require</span>(<span class="string">'hexo-pagination'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">locals</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> config = <span class="keyword">this</span>.config;</span><br><span class="line">  <span class="keyword">var</span> posts = locals.posts.sort(config.index_generator.order_by);</span><br><span class="line">  <span class="keyword">var</span> paginationDir = config.pagination_dir || <span class="string">'page'</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> path = config.index_generator.path || <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> pagination(path, posts, &#123;</span><br><span class="line">    perPage: config.index_generator.per_page,</span><br><span class="line">    layout: [<span class="string">'index'</span>, <span class="string">'archive'</span>],</span><br><span class="line">    format: paginationDir + <span class="string">'/%d/'</span>,</span><br><span class="line">    data: &#123;</span><br><span class="line">      __index: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>这个脚本程序引入了分页的插件，从而实现在首页的文章列表分页。其中<br><code>var posts = locals.posts.sort(config.index_generator.order_by);</code><br>这行代码很关键，order_by字段就是首页文章生成的顺序，这个参数在_config.yml中有定义：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">index_generator:</span><br><span class="line">  path: ''</span><br><span class="line">  per_page: 5</span><br><span class="line">  order_by: -date</span><br></pre></td></tr></table></figure></p>
<p>-date表示按事件倒序，因此如果需要置顶我们可以通过自定义参数top然后在生成器中修改排序规则。</p>
<h2 id="Front-matter"><a href="#Front-matter" class="headerlink" title="Front-matter"></a>Front-matter</h2><p>我们可以在Front-matter中定义top字段，设置该字段为数字类型并且数字越大则排名靠前，比如：top: 999。如果你还不知道Front-matter是什么，那就赶紧搜索一番。</p>
<blockquote>
<p>Front-matter is a block of YAML or JSON at the beginning of the file that is used to configure settings for your writings. Front-matter is terminated by three dashes when written in YAML or three semicolons when written in JSON.</p>
</blockquote>
<p>简单的说就是我们在用md编辑器写文章的时候头部设置的meta信息。</p>
<h2 id="修改排序"><a href="#修改排序" class="headerlink" title="修改排序"></a>修改排序</h2><p>直接上代码：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//根据Front-matter定义的top值排序</span></span><br><span class="line">   <span class="keyword">var</span> posts = locals.posts.data.sort(<span class="function"><span class="keyword">function</span> (<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">       <span class="comment">//两个post都定义了top</span></span><br><span class="line">       <span class="keyword">if</span> (a.top &amp;&amp; b.top) &#123;</span><br><span class="line">           <span class="comment">//按日期将降序</span></span><br><span class="line">           <span class="keyword">if</span> (a.top == b.top) <span class="keyword">return</span> b.date - a.date;</span><br><span class="line">           <span class="comment">//按top排序</span></span><br><span class="line">           <span class="keyword">else</span> <span class="keyword">return</span> b.top - a.top;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//定义了top的排前面</span></span><br><span class="line">       <span class="keyword">else</span> <span class="keyword">if</span> (a.top &amp;&amp; !b.top) &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">else</span> <span class="keyword">if</span> (!a.top &amp;&amp; b.top) &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//没有定义top就按照日期降序</span></span><br><span class="line">       <span class="keyword">else</span> <span class="keyword">return</span> b.date - a.date;</span><br><span class="line">   &#125;);</span><br></pre></td></tr></table></figure></p>
<p>这里的逻辑也很简单，使用sort进行排序，根据文章的头部是否设置了top进行判断。如果没有设置top则默认按照发布日期进行排序。</p>
<h2 id="end"><a href="#end" class="headerlink" title="end"></a>end</h2><p>最后执行:<code>hexo d</code>重新部署即可查看效果</p>
]]></content>
      
        <categories>
            
            <category> 随笔 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> hexo </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[【python笔记】- 统计文件单词出现频次]]></title>
      <url>/2017/11/08/python-counting/</url>
      <content type="html"><![CDATA[<h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><p>统计一个文件的单词出现次数是分词工具所具备的基本能力，现在尝试使用python进行文件的读取和单词的处理。</p>
<h2 id="读取文件"><a href="#读取文件" class="headerlink" title="读取文件"></a>读取文件</h2><p>读取文件在python里简直轻而易举，直接使用open方法就可以拿到文件句柄。同时令人惊叹的是优雅的错误处理和文件关闭策略，基本代码如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> open(file, <span class="string">'r'</span>) <span class="keyword">as</span> f:  </span><br><span class="line">            content = f.read()</span><br></pre></td></tr></table></figure></p>
<p>使用with open as实现了文件的打开和异常处理以及句柄的关闭</p>
<h2 id="正则分割单词"><a href="#正则分割单词" class="headerlink" title="正则分割单词"></a>正则分割单词</h2><p>这里使用内置的re模块进行正则抽取，这里只是简单的按照\w分词</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> word <span class="keyword">in</span> re.findall(<span class="string">"\w+"</span>, content):</span><br><span class="line">    self.mapping[word] = self.mapping.get(word, <span class="number">0</span>) + <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>遍历正则结果同时统计单词的次数，这里使用dict的get方法，第一次调用将计数默认置为0</p>
<h2 id="按照出现次数排序"><a href="#按照出现次数排序" class="headerlink" title="按照出现次数排序"></a>按照出现次数排序</h2><p>使用python的内置函数sorted即可，只需要传入统计结果和key即可进行排序,其原型如下：</p>
<p>sorted(iterable, cmp=None, key=None, reverse=False)</p>
<ul>
<li>iterable：iteralbe指的是能够一次返回它的一个成员的对象。<br>iterable主要包括3类：<ol>
<li>第一类是所有的序列类型，比如list(列表)、str(字符串)、tuple(元组)。 </li>
<li>第二类是一些非序列类型，比如dict(字典)、file(文件)。</li>
<li>第三类是你定义的任何包含<strong>iter</strong>()或<strong>getitem</strong>()方法的类的对象。</li>
</ol>
</li>
<li>cmp：指定一个定制的比较函数，这个函数接收两个参数（iterable的元素），如果第一个参数小于第二个参数，返回一个负数；如果第一个参数等于第二个参数，返回零；如果第一个参数大于第二个参数，返回一个正数。默认值为None。</li>
<li>key：指定一个接收一个参数的函数，这个函数用于从每个元素中提取一个用于比较的关键字。默认值为None。</li>
<li>reverse：是一个布尔值。如果设置为True，列表元素将被降序排列，默认为升序排列。</li>
</ul>
<p>通常来说，key和reverse比一个等价的cmp函数处理速度要快。这是因为对于每个列表元素，cmp都会被调用多次，而key和reverse只被调用一次。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sorted(self.mapping.items(), key=<span class="keyword">lambda</span> item: item[<span class="number">1</span>], reverse=<span class="keyword">True</span>)[:n]</span><br></pre></td></tr></table></figure>
<p>这里调用字典数据类型的items方法获取key和value的元组，然后将元组的第二项作为key传给sorted从而实现按照出现次数进行排序</p>
<h2 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: UTF-8 -*-  </span></span><br><span class="line"><span class="keyword">import</span> collections  </span><br><span class="line"><span class="keyword">import</span> re  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Counter</span>:</span>  </span><br><span class="line">    <span class="string">'读取文本文件，并统计每个单词的出现频次'</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, file)</span>:</span>  </span><br><span class="line">        self.mapping = &#123;&#125;  </span><br><span class="line">        <span class="keyword">with</span> open(file, <span class="string">'r'</span>) <span class="keyword">as</span> f:  </span><br><span class="line">            content = f.read()  </span><br><span class="line">            <span class="comment"># 分割单词  </span></span><br><span class="line">            <span class="keyword">for</span> word <span class="keyword">in</span> re.findall(<span class="string">"\w+"</span>, content):  </span><br><span class="line">                self.mapping[word] = self.mapping.get(word, <span class="number">0</span>) + <span class="number">1</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">most_repeated</span><span class="params">(self, n)</span>:</span>  </span><br><span class="line">        <span class="keyword">return</span> sorted(self.mapping.items(), key=<span class="keyword">lambda</span> item: item[<span class="number">1</span>], reverse=<span class="keyword">True</span>)[:n]  </span><br><span class="line">        <span class="comment"># return collections.Counter(self.mapping).most_common(5)  </span></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">if</span> <span class="string">'__main__'</span> == __name__:  </span><br><span class="line">    counter = Counter(<span class="string">"/home/gongxufan/.m2/settings.xml"</span>)  </span><br><span class="line">    <span class="keyword">print</span> counter.most_repeated(<span class="number">5</span>)</span><br></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>Counter在构造方法中读取文件然后使用正则分割单词存到序列中，遍历的时候统计单词出现次数。这里使用了dict的get(key,defaultValue)方法，第一次出现设置初始值为0。最后在统计排名的时候使用sorted内置函数。其实这字典值的统计排名可以使用内置的collections模块进行操作，而且其实现更加高效和可靠。</p>
<p>比如most_common方法：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">most_common</span><span class="params">(self, n=None)</span>:</span>  </span><br><span class="line">    <span class="string">'''''List the n most common elements and their counts from the most </span></span><br><span class="line"><span class="string">    common to the least.  If n is None, then list all element counts. </span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">    &gt;&gt;&gt; Counter('abcdeabcdabcaba').most_common(3) </span></span><br><span class="line"><span class="string">    [('a', 5), ('b', 4), ('c', 3)] </span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">    '''</span>  </span><br><span class="line">    <span class="comment"># Emulate Bag.sortedByCount from Smalltalk  </span></span><br><span class="line">    <span class="keyword">if</span> n <span class="keyword">is</span> <span class="keyword">None</span>:  </span><br><span class="line">        <span class="keyword">return</span> sorted(self.iteritems(), key=_itemgetter(<span class="number">1</span>), reverse=<span class="keyword">True</span>)  </span><br><span class="line">    <span class="keyword">return</span> _heapq.nlargest(n, self.iteritems(), key=_itemgetter(<span class="number">1</span>))</span><br></pre></td></tr></table></figure></p>
<p>对指定的长度进行统计会针对各种情况进行优化处理：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">nlargest</span><span class="params">(n, iterable, key=None)</span>:</span>  </span><br><span class="line">    <span class="string">"""Find the n largest elements in a dataset. </span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">    Equivalent to:  sorted(iterable, key=key, reverse=True)[:n] </span></span><br><span class="line"><span class="string">    """</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="comment"># Short-cut for n==1 is to use max() when len(iterable)&gt;0  </span></span><br><span class="line">    <span class="keyword">if</span> n == <span class="number">1</span>:  </span><br><span class="line">        it = iter(iterable)  </span><br><span class="line">        head = list(islice(it, <span class="number">1</span>))  </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> head:  </span><br><span class="line">            <span class="keyword">return</span> []  </span><br><span class="line">        <span class="keyword">if</span> key <span class="keyword">is</span> <span class="keyword">None</span>:  </span><br><span class="line">            <span class="keyword">return</span> [max(chain(head, it))]  </span><br><span class="line">        <span class="keyword">return</span> [max(chain(head, it), key=key)]  </span><br><span class="line">  </span><br><span class="line">    <span class="comment"># When n&gt;=size, it's faster to use sorted()  </span></span><br><span class="line">    <span class="keyword">try</span>:  </span><br><span class="line">        size = len(iterable)  </span><br><span class="line">    <span class="keyword">except</span> (TypeError, AttributeError):  </span><br><span class="line">        <span class="keyword">pass</span>  </span><br><span class="line">    <span class="keyword">else</span>:  </span><br><span class="line">        <span class="keyword">if</span> n &gt;= size:  </span><br><span class="line">            <span class="keyword">return</span> sorted(iterable, key=key, reverse=<span class="keyword">True</span>)[:n]  </span><br><span class="line">  </span><br><span class="line">    <span class="comment"># When key is none, use simpler decoration  </span></span><br><span class="line">    <span class="keyword">if</span> key <span class="keyword">is</span> <span class="keyword">None</span>:  </span><br><span class="line">        it = izip(iterable, count(<span class="number">0</span>,<span class="number">-1</span>))                    <span class="comment"># decorate  </span></span><br><span class="line">        result = _nlargest(n, it)  </span><br><span class="line">        <span class="keyword">return</span> map(itemgetter(<span class="number">0</span>), result)                   <span class="comment"># undecorate  </span></span><br><span class="line">  </span><br><span class="line">    <span class="comment"># General case, slowest method  </span></span><br><span class="line">    in1, in2 = tee(iterable)  </span><br><span class="line">    it = izip(imap(key, in1), count(<span class="number">0</span>,<span class="number">-1</span>), in2)             <span class="comment"># decorate  </span></span><br><span class="line">    result = _nlargest(n, it)  </span><br><span class="line">    <span class="keyword">return</span> map(itemgetter(<span class="number">2</span>), result)                       <span class="comment"># undecorate</span></span><br></pre></td></tr></table></figure>
<p>python就是一门这么简洁优雅的开发工具，以前我比较抗拒这种动态语言，喜欢结构化和oop的开发模式，现在是越发欢这门语言了。</p>
<h2 id="end"><a href="#end" class="headerlink" title="end"></a>end</h2>]]></content>
      
        <categories>
            
            <category> 随笔 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> python2.x </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[tomcat和servlet以及jdk版本的对应关系]]></title>
      <url>/2017/11/07/tomcat-jdk-servlet/</url>
      <content type="html"><![CDATA[<p>最新的servlet规范是servlet4.0，然而很多项目在编译的时候用的servlet2.5，导致迁移到不同版本的tomcat启动发生错误。由于servlet3.0以后启用了nio以及对filter和servlet的注解支持，性能和使用上都得到了极大的提升。如果不是要兼容很老的系统，实在没必要使用2.5版本。</p>
<p>下面这个表格列出了所有tomcat和servlet版本以及jdk的对应关系：<br><img src="/upload/images/tomcat/tomcat-version.png" alt="img"><br>每个版本的Tomcat都支持满足上表中最后一列标明的java稳定版，可以在任何符合上表中最后一列要求的Java早期访问构建(比如Java9正式发布之前，tomcat9就可以在其早起构建版本上运行)上工作。但是不排除有bug和问题。</p>
<p>因此我们应该按照我们开发使用的jdk版本和tomcat版本对照，选择合适的稳定版本用于生产：</p>
<blockquote>
<p>Alpha版本可能包含大量未测试的/缺少规范和/或重大bug所需要的功能，不能指望它能稳定运行。<br>Beta版本可能包含一些未测试的功能和/或一些相对较小的bug,Beta版本不保证稳定运行。<br>Stable版本可能包含少量相对较小的bug，稳定的发行版是用于生产的，在很长一段时间内都能稳定运行。</p>
</blockquote>
<p>从上面的表可以看出：从tomcat7开始支持servlet3.0规范，而如果我们使用Java８进行开发最好使用8.5.23版本(稳定版),8.0.x是废弃的主线版本。</p>
<p>在servlet2.5中<code>request.getParameterMap()</code>方法返回<code>Map&lt;String, String&gt;</code>，而3.0以后返回的是<code>Map&lt;String, String[]&gt;</code>，这样升级会导致一些兼容性问题。</p>
<p>注意<br>另外使用JSP2.0的话JSTL标签应该写成下面的方式：<br><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ taglib uri=<span class="string">"http://java.sun.com/jsp/jstl/core"</span> prefix=<span class="string">"c"</span> %&gt;  </span><br><span class="line">&lt;%@ taglib prefix=<span class="string">"fmt"</span> uri=<span class="string">"http://java.sun.com/jsp/jstl/fmt"</span> %&gt;</span><br></pre></td></tr></table></figure></p>
<p>写成下面的方式是会报错的：<br><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ taglib uri=<span class="string">"http://java.sun.com/jstl/core"</span> prefix=<span class="string">"c"</span> %&gt;  </span><br><span class="line">&lt;%@ taglib prefix=<span class="string">"fmt"</span> uri=<span class="string">"http://java.sun.com/jstl/fmt"</span> %&gt;</span><br></pre></td></tr></table></figure></p>
<p>这样会出现下面的错误信息：</p>
<blockquote>
<p>According to TLD or attribute directive in tag file, attribute [value] does not accept any expressions</p>
</blockquote>
<p>也可以使用上边写法的_rt版本：<br><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ taglib uri=<span class="string">"http://java.sun.com/jstl/core_rt"</span> prefix=<span class="string">"c"</span> %&gt;  </span><br><span class="line">&lt;%@ taglib prefix=<span class="string">"fmt"</span> uri=<span class="string">"http://java.sun.com/jstl/fmt_rt"</span> %&gt;</span><br></pre></td></tr></table></figure></p>
<p>tomcat9.x是现在的主要开发版本，它是基于8.0.x和8.5x进行开发的。主要是实现servlet4.0规范，JSP2.3和EL3.0以及WebSocket1.1。另外9.x版本也添加了对Java9的支持，包括HTTP2.0。<br>最后在maven中引用如下：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.servlet-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
]]></content>
      
        <categories>
            
            <category> 随笔 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> tomcat </tag>
            
            <tag> servlet </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Efficient pagination of a table with 100M records]]></title>
      <url>/2017/11/06/mysql-pagination/</url>
      <content type="html"><![CDATA[<p>mysql物理分页的另一个视角，直接看原文更精彩。</p>
<p>This Chapter is focused on efficient scanning a large table using pagination with offset on the primary key. This is also known as keyset pagination.</p>
<h2 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h2><p>In the chapter, we use the following database structure for example. The canonical example about users should fit any domain.<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`users`</span> (</span><br><span class="line">  <span class="string">`user_id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`external_id`</span> <span class="built_in">varchar</span>(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`name`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">COLLATE</span> utf8_unicode_ci <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`metadata`</span> <span class="built_in">text</span> <span class="keyword">COLLATE</span> utf8_unicode_ci,</span><br><span class="line">  <span class="string">`date_created`</span> <span class="keyword">timestamp</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">CURRENT_TIMESTAMP</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`user_id`</span>),</span><br><span class="line">  <span class="keyword">UNIQUE</span> <span class="keyword">KEY</span> <span class="string">`uf_uniq_external_id`</span> (<span class="string">`external_id`</span>),</span><br><span class="line">  <span class="keyword">UNIQUE</span> <span class="keyword">KEY</span> <span class="string">`uf_uniq_name`</span> (<span class="string">`name`</span>),</span><br><span class="line">  <span class="keyword">KEY</span> <span class="string">`date_created`</span> (<span class="string">`date_created`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 <span class="keyword">COLLATE</span>=utf8_unicode_ci;</span><br></pre></td></tr></table></figure></p>
<p>A few comments about the structure:</p>
<ul>
<li>external_id column stores reference to the same user in other system in UUID format</li>
<li>name represents Firstname Lastname</li>
<li>metadata column contains JSON blob with all kinds of unstructured data</li>
</ul>
<p>The table is relatively large and contains around 100 000 000 records. Let’s start our learning journey.</p>
<h2 id="Scanning-a-Large-Table"><a href="#Scanning-a-Large-Table" class="headerlink" title="Scanning a Large Table"></a>Scanning a Large Table</h2><p>Problem: You need to walk thru the table, extract each record, transform it inside your application’s code and insert to another place. We focus on the first stage in the post - scanning the table.</p>
<h3 id="Obvious-and-wrong-solution"><a href="#Obvious-and-wrong-solution" class="headerlink" title="Obvious and wrong solution"></a>Obvious and wrong solution</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> user_id, external_id, <span class="keyword">name</span>, metadata, date_created</span><br><span class="line"><span class="keyword">FROM</span> <span class="keyword">users</span>;</span><br></pre></td></tr></table></figure>
<p>In my case with 100 000 000 records, the query is never finished. The DBMS just kills it. Why? Probably, because it led to the attempt to load the whole table into RAM. Before returning data to the client. Another assumption - it took too much time to pre-load the data before sending and the query was timed out. Anyway, our attempt to get all records in time failed. We need to find some other solution.</p>
<h3 id="Solution-2"><a href="#Solution-2" class="headerlink" title="Solution #2"></a>Solution #2</h3><p>We can try to get the data in pages. Since records are not guaranteed to be ordered in a table on physical or logical level - we need to sort them on the DBMS side with ORDER BY clause.<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> user_id, external_id, <span class="keyword">name</span>, metadata, date_created</span><br><span class="line"><span class="keyword">FROM</span> <span class="keyword">users</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> user_id <span class="keyword">ASC</span></span><br><span class="line"><span class="keyword">LIMIT</span> <span class="number">0</span>, <span class="number">10</span> <span class="number">000</span>;</span><br><span class="line"></span><br><span class="line">10 000 rows in <span class="keyword">set</span> (<span class="number">0.03</span> sec)</span><br></pre></td></tr></table></figure></p>
<p>Sweet. It worked. We asked the first page of 10 000 records, and it took only 0.03 sec to return it. However, how it would work for the 5000th page?<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> user_id, external_id, <span class="keyword">name</span>, metadata, date_created</span><br><span class="line"><span class="keyword">FROM</span> <span class="keyword">users</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> user_id <span class="keyword">ASC</span></span><br><span class="line"><span class="keyword">LIMIT</span> <span class="number">50</span> <span class="number">000</span> <span class="number">000</span>, <span class="number">10</span> <span class="number">000</span>; <span class="comment">--- 5 000th page * 10 000 page size</span></span><br><span class="line"></span><br><span class="line">10 000 rows in <span class="keyword">set</span> (<span class="number">40.81</span> sec)</span><br></pre></td></tr></table></figure></p>
<p>Indeed, this is very slow. Let’s see how much time is needed to get the data for the latest page.<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> user_id, external_id, <span class="keyword">name</span>, metadata, date_created</span><br><span class="line"><span class="keyword">FROM</span> <span class="keyword">users</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> user_id <span class="keyword">ASC</span></span><br><span class="line"><span class="keyword">LIMIT</span> <span class="number">99</span> <span class="number">990</span> <span class="number">000</span>, <span class="number">10</span> <span class="number">000</span>; <span class="comment">--- 9999th page * 10 000 page size</span></span><br><span class="line"></span><br><span class="line">10 000 rows in <span class="keyword">set</span> (<span class="number">1</span> <span class="keyword">min</span> <span class="number">20.61</span> sec)</span><br></pre></td></tr></table></figure></p>
<p>This is insane. However, can be OK for solutions that run in background. One more hidden problem with the approach can be revealed if you try to delete a record from the table in the middle of scanning it. </p>
<p>Say, you finished the 10th page (100 000 records are already visited), going to scan the records between 100 001 and 110 000. But records 99 998 and 99 999 are deleted before the next SELECT execution. In that case, the following query returns the unexpected result:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>N, id, …<br> 1, 100 003, …<br> 2, 100 004, …</p>
</blockquote>
<p>As you can see, the query skipped the records with ids 100 001 and 100 002. They will not be processed by application’s code with the approach because after the two delete operations they appear in the first 100 000 records. </p>
<p>Therefore, the method is unreliable if the dataset is mutable.</p>
<h2 id="Solution-3-the-final-one-for-today"><a href="#Solution-3-the-final-one-for-today" class="headerlink" title="Solution #3 - the final one for today"></a>Solution #3 - the final one for today</h2><p>The approach is very similar to the previous one because it still uses paging, but now instead of relying on the number of scanned records, we use the user_id of the latest visited record as the offset.<br>Simplified algorithm:</p>
<p>We get PAGE_SIZE number of records from the table. Starting offset value is 0.</p>
<p>Use the max returned value for user_id in the batch as the offset for the next page.</p>
<p>Get the next batch from the records which have user_id value higher than current offset.</p>
<p>The query in action for 5 000th page, each page contains data about 10 000 users:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> user_id, external_id, <span class="keyword">name</span>, metadata, date_created</span><br><span class="line"><span class="keyword">FROM</span> <span class="keyword">users</span></span><br><span class="line"><span class="keyword">WHERE</span> user_id &gt; <span class="number">51</span> <span class="number">234</span> <span class="number">123</span> <span class="comment">--- value of user_id for 50 000 000th record</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> user_id <span class="keyword">ASC</span></span><br><span class="line"><span class="keyword">LIMIT</span> <span class="number">10</span> <span class="number">000</span>;</span><br><span class="line"></span><br><span class="line">10 000 rows in <span class="keyword">set</span> (<span class="number">0.03</span> sec)</span><br></pre></td></tr></table></figure></p>
<p>Wow, it is significantly faster than the previous approach. More than 1000 times.</p>
<p>Note, that the values of user_id are not sequential and can have gaps like 25 348 is right after 25 345. The solution also works if any records from future pages are deleted - even in that case query does not skip records. Sweet, right?</p>
<h2 id="Explaining-performance"><a href="#Explaining-performance" class="headerlink" title="Explaining performance"></a>Explaining performance</h2><p>For further learning, I recommend investigating results of EXPLAIN EXTENDEDfor each version of the query to get the next 10 000 records after 50 000 000.</p>
<blockquote>
<p>Solution    Time    Type    Keys    Rows    Filtered    Extra<br> 1 Obvious    Never    ALL    NULL    100M    100.00    NULL<br> 2 Paging using number of records as offset    40.81 sec    index    NULL / PRIMARY    50M    200.00    NULL<br> 3 Keyset pagination using user_id as offset    0.03 sec    range    PRIMARY / PRIMARY    50M    100.00    Using where</p>
</blockquote>
<p>Let’s focus on the key difference between execution plans for 2nd and 3rd solutions since the 1st one is not practically useful for large tables.</p>
<p>Join type: index vs range. The first one means that whole index tree is scanned to find the records. range type tells us that index is used only to find matching rows within a specified range. So, range type is faster than index.</p>
<p>Possible keys: NULL vs PRIMARY. The column shows the keys that can be used by MySQL. BTW, looking into keys column, we can see that eventually PRIMARY key is used for the both queries.</p>
<p>Rows: 50 010 000 vs 50 000 000. The value displays a number of records analyzed before returning the result. For the 2nd query, the value depends on how deep is our scroll. For example, if we try to get the next 10 000 records after 9999th page then 99 990 000 records are examined. In opposite, the 3rd query has a constant value; it does not matter if we load data for the 1st page of the very last one. It is always half size of the table.</p>
<p>Filtered: 200.00 vs 100.00. The column indicates estimated the percentage of the table to be filtered before processing. Having the higher value is better. The value of 100.00 means that the query looks thru the whole table. For the 2nd query, the value is not constant and depends on the page number: if we ask 1st page the value of filtered column would be 1000000.00. For the very last page, it would be 100.00.</p>
<p>Extra: NULL vs Using where. Provides additional information about how MySQL resolves the query. Usage of WHERE on PRIMARY key make the query execution faster.</p>
<p>I suspect that join type is the parameter of the query that made the largest contribution to performance to make the 3rd query faster. Another important thing is that the 2nd query is extremely dependent on the number of the pages to scroll. More deep pagination is slower in that case.<br>More guidance about understaing output for EXPLAIN command can be found in the official documentation for your RDBMS.</p>
<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><p>The main topic for the blog post was related to scanning a large table with 100 000 000 records using offset with a primary key (keyset pagination).</p>
<p>Overall, 3 different approaches were reviewed and tested on the corresponding dataset. I recommend only one of them if you need to scan a mutable large table.<br>Also, we revised usage of EXPLAIN EXTENDED command to analyze execution plan of MySQL queries. I am sure that other RDBMS have analogs for the functionality.</p>
<p>原文地址：<a href="http://allyouneedisbackend.com/blog/2017/09/24/the-sql-i-love-part-1-scanning-large-table/" target="_blank" rel="external">http://allyouneedisbackend.com/blog/2017/09/24/the-sql-i-love-part-1-scanning-large-table/</a></p>
]]></content>
      
        <categories>
            
            <category> 转载 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[微信.公众平台开发模式配置管理系统]]></title>
      <url>/2017/11/06/weixin-manager-system/</url>
      <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>偶然发现磁盘中还有一个早期的关于微信后台管理的项目，闲来无事便在此廖记。</p>
<p>这个项目是使用SpringMvc+sqllite实现的仿微信官方公众号平台管理系统，实现了菜单管理、用户管理、消息管理、素材管理、消息群发，自动回复等基本功能，集成了ueditor和微信sdk，采用基于注解的SpringMVC模式开发：</p>
<h2 id="主要功能实现"><a href="#主要功能实现" class="headerlink" title="主要功能实现"></a>主要功能实现</h2><p>配置注解的包扫描路径：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.com.egova.wx.config.web;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ComponentScan;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.FilterType;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.EnableWebMvc;  </span><br><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> ** Created by gongxufan on 2016/7/30. </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="meta">@Configuration</span>  </span><br><span class="line"><span class="meta">@ComponentScan</span>(basePackages = &#123;<span class="string">"cn.com.egova.wx"</span>&#125;,  </span><br><span class="line">        excludeFilters = &#123;  </span><br><span class="line">                <span class="meta">@ComponentScan</span>.Filter(type = FilterType.ANNOTATION, value = EnableWebMvc.class)  </span><br><span class="line">        &#125;)  </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RootConfig</span> </span>&#123;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>基于WebMvcConfigureAdatper配置视图等web配置：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.com.egova.wx.config.web;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ComponentScan;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.ViewResolver;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.DefaultServletHandlerConfigurer;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.EnableWebMvc;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurerAdapter;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.view.InternalResourceViewResolver;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> ** SpringMVC组件配置，包括视图解析器、静态资源访问处理等等 </span></span><br><span class="line"><span class="comment"> ** &lt;p&gt; </span></span><br><span class="line"><span class="comment"> ** Created by gongxufan on 2016/7/30. </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="meta">@Configuration</span>  </span><br><span class="line"><span class="meta">@EnableWebMvc</span>  </span><br><span class="line"><span class="meta">@ComponentScan</span>(basePackages = &#123;<span class="string">"cn.com.egova.wx.web.controller"</span>, <span class="string">"cn.com.egova.wx.web.service"</span>&#125;)  </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebConfig</span> <span class="keyword">extends</span> <span class="title">WebMvcConfigurerAdapter</span> </span>&#123;  </span><br><span class="line">    <span class="meta">@Bean</span>  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> ViewResolver <span class="title">viewResolver</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">        <span class="comment">//定义标准的jsp视图解析器  </span></span><br><span class="line">        InternalResourceViewResolver resolver = <span class="keyword">new</span> InternalResourceViewResolver();  </span><br><span class="line">        resolver.setPrefix(<span class="string">"/WEB-INF/jsp/"</span>);  </span><br><span class="line">        resolver.setSuffix(<span class="string">".jsp"</span>);  </span><br><span class="line">        resolver.setExposeContextBeansAsAttributes(<span class="keyword">true</span>);  </span><br><span class="line">        <span class="keyword">return</span> resolver;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configureDefaultServletHandling</span><span class="params">(DefaultServletHandlerConfigurer configurer)</span> </span>&#123;  </span><br><span class="line">        <span class="comment">//静态资源访问交由容易默认的servlet处理  </span></span><br><span class="line">        configurer.enable();  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>配置过滤器：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.jfinal.core.JFinalFilter;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.web.filter.CharacterEncodingFilter;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.support.AbstractAnnotationConfigDispatcherServletInitializer;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.web.util.Log4jConfigListener;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.FilterRegistration;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletContext;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;  </span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;  </span><br><span class="line"><span class="keyword">import</span> java.util.Map;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> ** web.xml的编码方式，各种组件（监听器，过滤器等）在此初始化和注册 </span></span><br><span class="line"><span class="comment"> ** 注解方式的配置，需求容器支持Servlet3.0规范 </span></span><br><span class="line"><span class="comment"> ** Created by gongxufan on 2016/7/30. </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WxSetupWebAppInitializer</span> <span class="keyword">extends</span> <span class="title">AbstractAnnotationConfigDispatcherServletInitializer</span> </span>&#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStartup</span><span class="params">(ServletContext servletContext)</span> <span class="keyword">throws</span> ServletException </span>&#123;  </span><br><span class="line">        <span class="comment">//配置全局参数  </span></span><br><span class="line">        servletContext.setInitParameter(<span class="string">"log4jConfigLocation"</span>, <span class="string">"/WEB-INF/log4j.xml"</span>);  </span><br><span class="line">        servletContext.setInitParameter(<span class="string">"webAppRootKey"</span>, <span class="string">"com.egova.wx"</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">//添加编码过滤器  </span></span><br><span class="line">        FilterRegistration.Dynamic encodingFilter = servletContext.addFilter(<span class="string">"characterEncodingFilter"</span>,  </span><br><span class="line">                CharacterEncodingFilter.class);  </span><br><span class="line">        encodingFilter.addMappingForUrlPatterns(<span class="keyword">null</span>, <span class="keyword">false</span>, <span class="string">"/*"</span>);  </span><br><span class="line">        Map&lt;String, String&gt; params = <span class="keyword">new</span> HashMap&lt;String, String&gt;();  </span><br><span class="line">        params.put(<span class="string">"encoding"</span>, <span class="string">"UTF-8"</span>);  </span><br><span class="line">        params.put(<span class="string">"forceEncoding"</span>, <span class="string">"true"</span>);  </span><br><span class="line">        encodingFilter.setInitParameters(params);  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">//启动JFinal微信  </span></span><br><span class="line">        FilterRegistration.Dynamic wxFilter = servletContext.addFilter(<span class="string">"handler"</span>, JFinalFilter.class);  </span><br><span class="line">        wxFilter.addMappingForUrlPatterns(<span class="keyword">null</span>, <span class="keyword">false</span>, <span class="string">"/weixin/*"</span>);  </span><br><span class="line">        params = <span class="keyword">new</span> HashMap&lt;String, String&gt;();  </span><br><span class="line">        params.put(<span class="string">"configClass"</span>, <span class="string">"cn.com.egova.wx.config.wx.WeixinConfig"</span>);  </span><br><span class="line">        wxFilter.setInitParameters(params);  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">//log4j监听器  </span></span><br><span class="line">        servletContext.addListener(Log4jConfigListener.class);  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">super</span>.onStartup(servletContext);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt;[] getRootConfigClasses() &#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Class&lt;?&gt;[]&#123;RootConfig.class&#125;;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt;[] getServletConfigClasses() &#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Class&lt;?&gt;[]&#123;WebConfig.class&#125;;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">protected</span> String[] getServletMappings() &#123;  </span><br><span class="line">        <span class="comment">//DispatcherServlet映射到/请求地址  </span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> String[]&#123;<span class="string">"/"</span>&#125;;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="集成微信SDK"><a href="#集成微信SDK" class="headerlink" title="集成微信SDK"></a>集成微信SDK</h2><p>通过添加过滤器的方式集成jfinal的微信sdk,具体在<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">//启动JFinal微信</span></span><br><span class="line">FilterRegistration.Dynamic wxFilter = servletContext.addFilter(<span class="string">"handler"</span>, JFinalFilter.class);</span><br><span class="line">wxFilter.addMappingForUrlPatterns(<span class="keyword">null</span>, <span class="keyword">false</span>, <span class="string">"/weixin/*"</span>);</span><br><span class="line">params = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line">params.put(<span class="string">"configClass"</span>, <span class="string">"cn.com.egova.wx.config.wx.WeixinConfig"</span>);</span><br><span class="line">wxFilter.setInitParameters(params);</span><br></pre></td></tr></table></figure></p>
<p>此处对/weixin/开头的请求进行拦截，并配置了参数类WeixinConfig,其代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.com.egova.wx.config.wx;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 微信公众号相关配置</span></span><br><span class="line"><span class="comment"> * Created by gongxufan on 2016/8/2.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.com.egova.wx.web.handler.WeixinApiInvokeHandler;</span><br><span class="line"><span class="keyword">import</span> cn.com.egova.wx.web.handler.WeixinMsgMonitorHandler;</span><br><span class="line"><span class="keyword">import</span> cn.com.egova.wx.sdk.api.ApiConfigKit;</span><br><span class="line"><span class="keyword">import</span> com.jfinal.config.Constants;</span><br><span class="line"><span class="keyword">import</span> com.jfinal.config.Handlers;</span><br><span class="line"><span class="keyword">import</span> com.jfinal.config.Interceptors;</span><br><span class="line"><span class="keyword">import</span> com.jfinal.config.JFinalConfig;</span><br><span class="line"><span class="keyword">import</span> com.jfinal.config.Plugins;</span><br><span class="line"><span class="keyword">import</span> com.jfinal.config.Routes;</span><br><span class="line"><span class="keyword">import</span> com.jfinal.kit.PropKit;</span><br><span class="line"><span class="keyword">import</span> com.jfinal.render.ViewType;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WeixinConfig</span> <span class="keyword">extends</span> <span class="title">JFinalConfig</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 如果生产环境配置文件存在，则优先加载该配置，否则加载开发环境配置文件</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pro 生产环境配置文件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dev 开发环境配置文件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadProp</span><span class="params">(String pro, String dev)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            PropKit.use(pro);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            PropKit.use(dev);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configConstant</span><span class="params">(Constants me)</span> </span>&#123;</span><br><span class="line">        loadProp(<span class="string">"/sysinfo.properties"</span>, <span class="string">"/sysinfo.properties"</span>);</span><br><span class="line">        me.setDevMode(PropKit.getBoolean(<span class="string">"devMode"</span>, <span class="keyword">false</span>));</span><br><span class="line">        me.setEncoding(<span class="string">"utf-8"</span>);</span><br><span class="line">        me.setViewType(ViewType.JSP);</span><br><span class="line">        me.setError500View(<span class="string">"/500.html"</span>);</span><br><span class="line">        me.setError404View(<span class="string">"/404.html"</span>);</span><br><span class="line">        <span class="comment">// ApiConfigKit 设为开发模式可以在开发阶段输出请求交互的 xml 与 json 数据</span></span><br><span class="line">        ApiConfigKit.setDevMode(me.getDevMode());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configRoute</span><span class="params">(Routes me)</span> </span>&#123;</span><br><span class="line">        me.add(<span class="string">"/weixin/msg"</span>, WeixinMsgMonitorHandler.class,<span class="string">"/"</span>);</span><br><span class="line">        me.add(<span class="string">"/weixin/api"</span>, WeixinApiInvokeHandler.class,<span class="string">"/"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configPlugin</span><span class="params">(Plugins me)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configInterceptor</span><span class="params">(Interceptors me)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configHandler</span><span class="params">(Handlers me)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在这里配置msg和api的处理器，分别是处理微信消息和微信api调用的处理逻辑</p>
<h2 id="系统主要功能界面"><a href="#系统主要功能界面" class="headerlink" title="系统主要功能界面"></a>系统主要功能界面</h2><p><img src="/upload/images/weixin-manager/main-func.png" alt="img"><br>自定义菜单还是实现了跟官方一样的菜单排序，菜单的的图文消息编辑等<br><img src="/upload/images/weixin-manager/menu-manage.png" alt="img"><br>素材管理实现图文消息的编辑和新建，图片的管理和查看<br><img src="/upload/images/weixin-manager/muti-message.png" alt="img"><br><img src="/upload/images/weixin-manager/muti-message-mg.png" alt="img"><br>可以设置自动回复和消息群发<br><img src="/upload/images/weixin-manager/auto-reply.png" alt="img"><br>其他功能就不在此赘述，附上项目地址：<a href="https://github.com/gongxufan/wechat-conf/" target="_blank" rel="external">https://github.com/gongxufan/wechat-conf/</a></p>
<h2 id="end"><a href="#end" class="headerlink" title="end"></a>end</h2>]]></content>
      
        <categories>
            
            <category> 工作日志 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> java </tag>
            
            <tag> 前端 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Python2.7继承使用super初始化父类]]></title>
      <url>/2017/11/01/python-2.7-super/</url>
      <content type="html"><![CDATA[<p>本文只关注２.x的父类构造，因为3.0以后机制又变了。这里有两个class，Person和Student：<br>person.py<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python  </span></span><br><span class="line"><span class="comment"># -*- coding: UTF-8 -*-  </span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span><span class="params">(object)</span>:</span>  </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, sex)</span>:</span>  </span><br><span class="line">        self.sex = sex  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">showSex</span><span class="params">(self)</span>:</span>  </span><br><span class="line">        <span class="keyword">print</span> self.sex</span><br></pre></td></tr></table></figure></p>
<p>然后是stu.py继承Person<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># --*coding:utf8 *--  </span></span><br><span class="line"><span class="keyword">from</span> com.gxf.entity.person <span class="keyword">import</span> Person  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span><span class="params">(Person)</span>:</span>  </span><br><span class="line">    <span class="string">'提供对学生的操作'</span>  </span><br><span class="line">    stuCount = <span class="number">0</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name=<span class="string">"unkonwn"</span>, age=<span class="number">20</span>, sex=<span class="string">"男"</span>)</span>:</span>  </span><br><span class="line">        <span class="comment"># Person.__init__(self,sex)  </span></span><br><span class="line">        super(Student, self).__init__(sex)  </span><br><span class="line">        self.name = name  </span><br><span class="line">        self.age = age  </span><br><span class="line">        Student.stuCount += <span class="number">1</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">displayStuCount</span><span class="params">(self)</span>:</span>  </span><br><span class="line">        <span class="keyword">print</span> <span class="string">"Total student is :%d"</span> % Student.stuCount  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__test</span><span class="params">(self)</span>:</span>  </span><br><span class="line">        <span class="keyword">print</span> <span class="string">"inner method"</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">displayStu</span><span class="params">(self)</span>:</span>  </span><br><span class="line">        self.__test()  </span><br><span class="line">        <span class="keyword">print</span> <span class="string">"Name: "</span>, self.name, <span class="string">"age: "</span>, self.age  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:  </span><br><span class="line">    stu = Student(<span class="string">"gongxufan"</span>, <span class="number">30</span>, <span class="string">"男"</span>);  </span><br><span class="line">    stu.displayStu();  </span><br><span class="line">    stu.displayStuCount();  </span><br><span class="line">    stu.showSex()</span><br></pre></td></tr></table></figure></p>
<p>在子类的<strong>init</strong>中调用父类构造有两种方式：</p>
<ul>
<li><p>一种是用父类名去调用</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Person.__init__(self,sex)</span><br></pre></td></tr></table></figure>
</li>
<li><p>第二种是通过super去调用</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">super(Student, self).__init__(sex)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>但是这种情况必须继承object(子类继承object就行)否则会报错</p>
<blockquote>
<p>super(Student, self).<strong>init</strong>(sex)<br> TypeError: super() argument 1 must be type, not classobj</p>
</blockquote>
<p>这里的区别就是经典类和新式类，其看下边的栗子：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span>  </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">(self)</span>:</span>  </span><br><span class="line">        print(<span class="string">'called A.foo()'</span>)  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span><span class="params">(A)</span>:</span>  </span><br><span class="line">    <span class="keyword">pass</span>  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span><span class="params">(A)</span>:</span>  </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">(self)</span>:</span>  </span><br><span class="line">        print(<span class="string">'called C.foo()'</span>)  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">D</span><span class="params">(B, C)</span>:</span>  </span><br><span class="line">    <span class="keyword">pass</span>  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:  </span><br><span class="line">    d = D()  </span><br><span class="line">    d.foo()</span><br></pre></td></tr></table></figure></p>
<p>运行：called A.foo()<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span>  </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">(self)</span>:</span>  </span><br><span class="line">        print(<span class="string">'called A.foo()'</span>)  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span><span class="params">(A)</span>:</span>  </span><br><span class="line">    <span class="keyword">pass</span>  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span><span class="params">(A)</span>:</span>  </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">(self)</span>:</span>  </span><br><span class="line">        print(<span class="string">'called C.foo()'</span>)  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">D</span><span class="params">(B, C,object)</span>:</span>  </span><br><span class="line">    <span class="keyword">pass</span>  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:  </span><br><span class="line">    d = D()  </span><br><span class="line">    d.foo()</span><br></pre></td></tr></table></figure></p>
<p>运行：</p>
<blockquote>
<p>called C.foo()</p>
</blockquote>
<p>可见在调用父类方法查找的时候顺不一样。经典类会从根部开始，新式类从最接近子类的位置开始匹配。</p>
]]></content>
      
        <categories>
            
            <category> 随笔 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> python2.x </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[【基于Ijkplayer】安卓机顶盒电视播放器开发]]></title>
      <url>/2017/10/30/tv-player/</url>
      <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Ijkplayer是B站开源的一款多媒体播放引擎，其基于ffmpeg开并支持很多的在线媒体播放格式。本文实现了在安卓TV上播放各大电视台的直播，其格式是.m3u8。当然了只要是编译的Ijkplayer支持的格式这款播放器自然可以播放。</p>
<p>首先上界面：<br><img src="/upload/images/android/tv-player/1.jpeg" alt="img"><br><img src="/upload/images/android/tv-player/2.jpeg" alt="img"><br>播放器界面非常简单，因为是用电视遥控器操作，所以布局和操作力求简单易用。布局分为播放区域和左侧菜单，按遥控器的确定按钮调出菜单，可以选择界面确认后进入播放界面。下面开始讲如何实现：</p>
<h2 id="一，创建布局"><a href="#一，创建布局" class="headerlink" title="一，创建布局"></a>一，创建布局</h2><p>播放器主界面布局文件activity_play_rel.xml<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;  </span><br><span class="line"><span class="tag">&lt;<span class="name">RelativeLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span>  </span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span>  </span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span>  </span></span><br><span class="line"><span class="tag">    <span class="attr">android:orientation</span>=<span class="string">"vertical"</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="tag">&lt;<span class="name">LinearLayout</span>  </span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"fill_parent"</span>  </span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"fill_parent"</span>  </span></span><br><span class="line"><span class="tag">        <span class="attr">android:orientation</span>=<span class="string">"vertical"</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line">        <span class="tag">&lt;<span class="name">RelativeLayout</span>  </span></span><br><span class="line"><span class="tag">            <span class="attr">android:id</span>=<span class="string">"@+id/fl_videoview"</span>  </span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span>  </span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span>  </span></span><br><span class="line"><span class="tag">            <span class="attr">android:background</span>=<span class="string">"@color/colorBlack"</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line">            <span class="tag">&lt;<span class="name">com.gxf.liveplay.ijkplayer.media.IjkVideoView</span>  </span></span><br><span class="line"><span class="tag">                <span class="attr">android:id</span>=<span class="string">"@+id/videoview"</span>  </span></span><br><span class="line"><span class="tag">                <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span>  </span></span><br><span class="line"><span class="tag">                <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span>  </span></span><br><span class="line"><span class="tag">                <span class="attr">android:layout_centerInParent</span>=<span class="string">"true"</span>  </span></span><br><span class="line"><span class="tag">                <span class="attr">android:background</span>=<span class="string">"@color/colorBlack"</span>&gt;</span><span class="tag">&lt;/<span class="name">com.gxf.liveplay.ijkplayer.media.IjkVideoView</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line">            <span class="tag">&lt;<span class="name">RelativeLayout</span>  </span></span><br><span class="line"><span class="tag">                <span class="attr">android:id</span>=<span class="string">"@+id/rl_loading"</span>  </span></span><br><span class="line"><span class="tag">                <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span>  </span></span><br><span class="line"><span class="tag">                <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span>  </span></span><br><span class="line"><span class="tag">                <span class="attr">android:background</span>=<span class="string">"#de262a3b"</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line">                <span class="tag">&lt;<span class="name">TextView</span>  </span></span><br><span class="line"><span class="tag">                    <span class="attr">android:id</span>=<span class="string">"@+id/tv_load_msg"</span>  </span></span><br><span class="line"><span class="tag">                    <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span>  </span></span><br><span class="line"><span class="tag">                    <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span>  </span></span><br><span class="line"><span class="tag">                    <span class="attr">android:layout_below</span>=<span class="string">"@+id/pb_loading"</span>  </span></span><br><span class="line"><span class="tag">                    <span class="attr">android:layout_centerInParent</span>=<span class="string">"true"</span>  </span></span><br><span class="line"><span class="tag">                    <span class="attr">android:layout_marginTop</span>=<span class="string">"6dp"</span>  </span></span><br><span class="line"><span class="tag">                    <span class="attr">android:textColor</span>=<span class="string">"#ffffff"</span>  </span></span><br><span class="line"><span class="tag">                    <span class="attr">android:textSize</span>=<span class="string">"16sp"</span> /&gt;</span>  </span><br><span class="line">  </span><br><span class="line">                <span class="tag">&lt;<span class="name">ProgressBar</span>  </span></span><br><span class="line"><span class="tag">                    <span class="attr">android:id</span>=<span class="string">"@+id/pb_loading"</span>  </span></span><br><span class="line"><span class="tag">                    <span class="attr">android:layout_width</span>=<span class="string">"60dp"</span>  </span></span><br><span class="line"><span class="tag">                    <span class="attr">android:layout_height</span>=<span class="string">"60dp"</span>  </span></span><br><span class="line"><span class="tag">                    <span class="attr">android:layout_centerInParent</span>=<span class="string">"true"</span>  </span></span><br><span class="line"><span class="tag">                    <span class="attr">android:layout_marginTop</span>=<span class="string">"60dp"</span>  </span></span><br><span class="line"><span class="tag">                    <span class="attr">android:indeterminate</span>=<span class="string">"false"</span>  </span></span><br><span class="line"><span class="tag">                    <span class="attr">android:indeterminateDrawable</span>=<span class="string">"@drawable/video_loading"</span>  </span></span><br><span class="line"><span class="tag">                    <span class="attr">android:padding</span>=<span class="string">"5dp"</span> /&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;/<span class="name">RelativeLayout</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line">            <span class="comment">&lt;!-- &lt;LinearLayout  </span></span><br><span class="line"><span class="comment">                 android:layout_width="match_parent"  </span></span><br><span class="line"><span class="comment">                 android:layout_height="wrap_content"  </span></span><br><span class="line"><span class="comment">                 android:background="@color/player_panel_background_color"&gt;  </span></span><br><span class="line"><span class="comment">  </span></span><br><span class="line"><span class="comment">                 &lt;TextView  </span></span><br><span class="line"><span class="comment">                     android:id="@+id/tv_title"  </span></span><br><span class="line"><span class="comment">                     android:layout_width="wrap_content"  </span></span><br><span class="line"><span class="comment">                     android:layout_height="60dp"  </span></span><br><span class="line"><span class="comment">                     android:textSize="24dp"  </span></span><br><span class="line"><span class="comment">                     android:text=""  </span></span><br><span class="line"><span class="comment">                     android:layout_centerVertical="true"  </span></span><br><span class="line"><span class="comment">                     android:layout_marginTop="18dp"  </span></span><br><span class="line"><span class="comment">                     android:textColor="@color/white"/&gt;  </span></span><br><span class="line"><span class="comment">  </span></span><br><span class="line"><span class="comment">                 &lt;TextView  </span></span><br><span class="line"><span class="comment">                     android:id="@+id/tv_time"  </span></span><br><span class="line"><span class="comment">                     android:layout_width="wrap_content"  </span></span><br><span class="line"><span class="comment">                     android:layout_height="60dp"  </span></span><br><span class="line"><span class="comment">                     android:textSize="20dp"  </span></span><br><span class="line"><span class="comment">                     android:layout_toRightOf="@id/tv_title"  </span></span><br><span class="line"><span class="comment">                     android:layout_alignParentRight="true"  </span></span><br><span class="line"><span class="comment">                     android:layout_centerVertical="true"  </span></span><br><span class="line"><span class="comment">                     android:layout_marginLeft="60dp"  </span></span><br><span class="line"><span class="comment">                     android:layout_marginTop="20dp"  </span></span><br><span class="line"><span class="comment">                     android:textColor="@color/white"/&gt;  </span></span><br><span class="line"><span class="comment">             &lt;/LinearLayout&gt;--&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;/<span class="name">RelativeLayout</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="tag">&lt;<span class="name">include</span> <span class="attr">layout</span>=<span class="string">"@layout/layout_menu"</span> /&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">RelativeLayout</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>整体分为两部分：上边为播放器实现的界面布局，下边为左侧菜单布局。这里没有采用滑动调出左侧菜单的效果，只是采用相对布局通过设定菜单的宽带直接覆盖在播放器布局之上。IjkVidoView下边的是播放器的控制器布局，可以扩展实现进度音量等控制，本文尚未实现。</p>
<p>接下来看左侧菜单布局文件layout_menu.xml<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">LinearLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span>  </span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"360dp"</span>  </span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span>  </span></span><br><span class="line"><span class="tag">    <span class="attr">android:id</span>=<span class="string">"@+id/leftMenuCtrl"</span>  </span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_gravity</span>=<span class="string">"left"</span>  </span></span><br><span class="line"><span class="tag">    <span class="attr">android:visibility</span>=<span class="string">"gone"</span>  </span></span><br><span class="line"><span class="tag">    <span class="attr">android:background</span>=<span class="string">"@drawable/dark_no_shadow"</span>  </span></span><br><span class="line"><span class="tag">    <span class="attr">android:orientation</span>=<span class="string">"vertical"</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="tag">&lt;<span class="name">LinearLayout</span>  </span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span>  </span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span>  </span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_weight</span>=<span class="string">"1"</span>  </span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_gravity</span>=<span class="string">"center"</span>  </span></span><br><span class="line"><span class="tag">        <span class="attr">android:orientation</span>=<span class="string">"horizontal"</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line">        <span class="tag">&lt;<span class="name">ImageButton</span>  </span></span><br><span class="line"><span class="tag">            <span class="attr">android:id</span>=<span class="string">"@+id/turnLeft"</span>  </span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">"30px"</span>  </span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">"40px"</span>  </span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_gravity</span>=<span class="string">"center"</span>  </span></span><br><span class="line"><span class="tag">            <span class="attr">android:adjustViewBounds</span>=<span class="string">"false"</span>  </span></span><br><span class="line"><span class="tag">            <span class="attr">android:background</span>=<span class="string">"@drawable/tv_switch_bg_left"</span>  </span></span><br><span class="line"><span class="tag">            <span class="attr">android:onClick</span>=<span class="string">"turnLeft"</span> /&gt;</span>  </span><br><span class="line">  </span><br><span class="line">        <span class="tag">&lt;<span class="name">TextView</span>  </span></span><br><span class="line"><span class="tag">            <span class="attr">android:id</span>=<span class="string">"@+id/tvGroupTitle"</span>  </span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">"300px"</span>  </span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">"100px"</span>  </span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_gravity</span>=<span class="string">"center"</span>  </span></span><br><span class="line"><span class="tag">            <span class="attr">android:gravity</span>=<span class="string">"center"</span>  </span></span><br><span class="line"><span class="tag">            <span class="attr">android:text</span>=<span class="string">"我的频道"</span>  </span></span><br><span class="line"><span class="tag">            <span class="attr">android:textColor</span>=<span class="string">"@color/white"</span>  </span></span><br><span class="line"><span class="tag">            <span class="attr">android:textSize</span>=<span class="string">"24sp"</span>  </span></span><br><span class="line"><span class="tag">            <span class="attr">android:textStyle</span>=<span class="string">"bold"</span>  /&gt;</span>  </span><br><span class="line">  </span><br><span class="line">        <span class="tag">&lt;<span class="name">ImageButton</span>  </span></span><br><span class="line"><span class="tag">            <span class="attr">android:id</span>=<span class="string">"@+id/turnRight"</span>  </span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">"30px"</span>  </span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">"40px"</span>  </span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_gravity</span>=<span class="string">"center"</span>  </span></span><br><span class="line"><span class="tag">            <span class="attr">android:adjustViewBounds</span>=<span class="string">"false"</span>  </span></span><br><span class="line"><span class="tag">            <span class="attr">android:background</span>=<span class="string">"@drawable/tv_switch_bg_right"</span>  </span></span><br><span class="line"><span class="tag">            <span class="attr">android:onClick</span>=<span class="string">"turnRight"</span> /&gt;</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="tag">&lt;<span class="name">ListView</span>  </span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/listView"</span>  </span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span>  </span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span>  </span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_weight</span>=<span class="string">"9"</span>  </span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_gravity</span>=<span class="string">"center"</span>  </span></span><br><span class="line"><span class="tag">        <span class="attr">android:listSelector</span>=<span class="string">"@color/colorPrimaryDark"</span>/&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>上边的LinearLayout用于切换节目组，下边是ListView显示每个分组下的节目列表。这次布局就实现了，这是相当简单的。</p>
<h2 id="二，实现播放"><a href="#二，实现播放" class="headerlink" title="二，实现播放"></a>二，实现播放</h2><p>LiveActivityRel实现了播放功能，启动该Activity的时候传入媒体资源的地址mVideoUrl，然后启动Ijkplayer的播放功能<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initVideo</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">        <span class="comment">// init player`  </span></span><br><span class="line">        IjkMediaPlayer.loadLibrariesOnce(<span class="keyword">null</span>);  </span><br><span class="line">        IjkMediaPlayer.native_profileBegin(<span class="string">"libijkplayer.so"</span>);  </span><br><span class="line">        mVideoView.setVideoURI(Uri.parse(mVideoUrl));  </span><br><span class="line">        mVideoView.setOnPreparedListener(<span class="keyword">new</span> IMediaPlayer.OnPreparedListener() &#123;  </span><br><span class="line">            <span class="meta">@Override</span>  </span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPrepared</span><span class="params">(IMediaPlayer mp)</span> </span>&#123;  </span><br><span class="line">                mp.setVolume(<span class="number">100</span>, <span class="number">100</span>);  </span><br><span class="line">                mVideoView.start();  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;);  </span><br><span class="line">  </span><br><span class="line">        mVideoView.setOnInfoListener(<span class="keyword">new</span> IMediaPlayer.OnInfoListener() &#123;  </span><br><span class="line">            <span class="meta">@Override</span>  </span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onInfo</span><span class="params">(IMediaPlayer mp, <span class="keyword">int</span> what, <span class="keyword">int</span> extra)</span> </span>&#123;  </span><br><span class="line">                <span class="keyword">switch</span> (what) &#123;  </span><br><span class="line">                    <span class="keyword">case</span> IjkMediaPlayer.MEDIA_INFO_BUFFERING_START:  </span><br><span class="line">                        mLoadingLayout.setVisibility(View.VISIBLE);  </span><br><span class="line">                        <span class="keyword">break</span>;  </span><br><span class="line">                    <span class="keyword">case</span> IjkMediaPlayer.MEDIA_INFO_VIDEO_RENDERING_START:  </span><br><span class="line">                    <span class="keyword">case</span> IjkMediaPlayer.MEDIA_INFO_BUFFERING_END:  </span><br><span class="line">                        mLoadingLayout.setVisibility(View.GONE);  </span><br><span class="line">                        <span class="keyword">break</span>;  </span><br><span class="line">                &#125;  </span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;);  </span><br><span class="line">  </span><br><span class="line">        mVideoView.setOnCompletionListener(<span class="keyword">new</span> IMediaPlayer.OnCompletionListener() &#123;  </span><br><span class="line">            <span class="meta">@Override</span>  </span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompletion</span><span class="params">(IMediaPlayer mp)</span> </span>&#123;  </span><br><span class="line">                mLoadingLayout.setVisibility(View.VISIBLE);  </span><br><span class="line">                mVideoView.stopPlayback();  </span><br><span class="line">                mVideoView.release(<span class="keyword">true</span>);  </span><br><span class="line">                mVideoView.setVideoURI(Uri.parse(mVideoUrl));  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;);  </span><br><span class="line">  </span><br><span class="line">        mVideoView.setOnErrorListener(<span class="keyword">new</span> IMediaPlayer.OnErrorListener() &#123;  </span><br><span class="line">            <span class="meta">@Override</span>  </span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onError</span><span class="params">(IMediaPlayer mp, <span class="keyword">int</span> what, <span class="keyword">int</span> extra)</span> </span>&#123;  </span><br><span class="line">                <span class="keyword">if</span> (++mRetryTimes &gt; CONNECTION_TIMES) &#123;  </span><br><span class="line">                    <span class="keyword">new</span> AlertDialog.Builder(LiveActivityRel.<span class="keyword">this</span>)  </span><br><span class="line">                            .setMessage(<span class="string">"该频道媒体资源出现错误，节目暂时不能播放..."</span>)  </span><br><span class="line">                            .setPositiveButton(R.string.VideoView_error_button,  </span><br><span class="line">                                    <span class="keyword">new</span> DialogInterface.OnClickListener() &#123;  </span><br><span class="line">                                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(DialogInterface dialog, <span class="keyword">int</span> whichButton)</span> </span>&#123;  </span><br><span class="line">                                            dialog.dismiss();  </span><br><span class="line">                                            <span class="comment">//LiveActivityRel.this.finish();  </span></span><br><span class="line">                                        &#125;  </span><br><span class="line">                                    &#125;)  </span><br><span class="line">                            .setCancelable(<span class="keyword">false</span>)  </span><br><span class="line">                            .show();  </span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">                    mVideoView.stopPlayback();  </span><br><span class="line">                    mVideoView.release(<span class="keyword">true</span>);  </span><br><span class="line">                    mVideoView.setVideoURI(Uri.parse(mVideoUrl));  </span><br><span class="line">                &#125;  </span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;);  </span><br><span class="line">  </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>这里也是很简答的，首先进行库的加载和初始化，绑定各种事件，然后在setOnPreparedListener中启动播放。其余的功能主要是涉及到UI和数据解析。节目列表是一个JSON结构，在原来的项目是有API进行登录和节目列表获取的。为了方便本文直接把节目列表写死，同时启动的Activity设置为MainActivityOffline。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.gxf.liveplay;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> android.app.Activity;  </span><br><span class="line"><span class="keyword">import</span> android.content.Context;  </span><br><span class="line"><span class="keyword">import</span> android.content.Intent;  </span><br><span class="line"><span class="keyword">import</span> android.content.SharedPreferences;  </span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;  </span><br><span class="line"><span class="keyword">import</span> android.widget.Toast;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * splash </span></span><br><span class="line"><span class="comment"> * 启动登录检测 </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivityOffline</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> SPLASH_DISPLAY_LENGHT = <span class="number">1000</span>; <span class="comment">// 两秒后进入系统  </span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> isUpdateChecked = <span class="keyword">false</span>;  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkLogin</span><span class="params">()</span></span>&#123;  </span><br><span class="line">        SharedPreferences userSettings = getSharedPreferences(<span class="string">"auth"</span>, Context.MODE_PRIVATE);  </span><br><span class="line">        <span class="keyword">final</span> String lastVedioUrl = userSettings.getString(<span class="string">"lastVedioUrl"</span>, <span class="string">"none"</span>);  </span><br><span class="line">        <span class="keyword">final</span> Toast toast = Toast.makeText(MainActivityOffline.<span class="keyword">this</span>, <span class="string">"系统初始化失败..."</span>, Toast.LENGTH_SHORT);  </span><br><span class="line">        <span class="comment">// 开启一个子线程，进行网络操作，等待有返回结果，使用handler通知UI  </span></span><br><span class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;  </span><br><span class="line">            <span class="meta">@Override</span>  </span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">                <span class="keyword">try</span> &#123;  </span><br><span class="line">                    PlayListCache.initPlayInfo(<span class="keyword">null</span>,<span class="keyword">null</span>);  </span><br><span class="line">                    String url = lastVedioUrl;  </span><br><span class="line">                    <span class="keyword">if</span> (url.equals(<span class="string">"none"</span>))  </span><br><span class="line">                        url = PlayListCache.playListMap.get(PlayListCache.playListMap.keySet().iterator().next());  </span><br><span class="line">                    LiveActivityRel.activityStart(MainActivityOffline.<span class="keyword">this</span>, url);  </span><br><span class="line">                    MainActivityOffline.<span class="keyword">this</span>.finish();  </span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">                    toast.show();  </span><br><span class="line">                    e.printStackTrace();  </span><br><span class="line">                &#125;  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;).start();  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);  </span><br><span class="line">        setContentView(R.layout.activity_main);  </span><br><span class="line">        checkLogin();  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>启动App在一个线程里去获取节目列表并缓存起来放在PlayListCache中，然后调用LiveActivityRel并传入一个默认的播放地址(首次启动)或者上次播放的地址。至于登录和HttpUtils中的代码(主要用于节目列表和登录控制)就不在赘述了，因为不属于本文的重点。</p>
<h2 id="三，项目的代码"><a href="#三，项目的代码" class="headerlink" title="三，项目的代码"></a>三，项目的代码</h2><p><a href="https://github.com/gongxufan/TvPlayer" target="_blank" rel="external">https://github.com/gongxufan/TvPlayer</a></p>
<h2 id="THE-END"><a href="#THE-END" class="headerlink" title="THE END"></a>THE END</h2><p>PS：本项目中的播放源地址可能会失效，如需测试需要更改可用的播放源。</p>
<p>具体代码在com.gxf.liveplay.HttpUtils#getOfflinePlayList，数据格式如下：<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">[  </span><br><span class="line">  &#123;  </span><br><span class="line">    <span class="attr">"group"</span>: <span class="string">"省内频道"</span>,  </span><br><span class="line">    <span class="attr">"list"</span>: [  </span><br><span class="line">      &#123;  </span><br><span class="line">        <span class="attr">"湖南都市"</span>: <span class="string">"http://220.248.175.231:6610/001/2/ch00000090990000001049/index.m3u8?virtualDomain=001.live_hls.zte.com"</span>  </span><br><span class="line">      &#125;,  </span><br><span class="line">      &#123;  </span><br><span class="line">        <span class="attr">"湖南经视"</span>: <span class="string">"http://220.248.175.230:6610/001/2/ch00000090990000001052/index.m3u8?virtualDomain=001.live_hls.zte.com"</span>  </span><br><span class="line">      &#125;  </span><br><span class="line">    ]  </span><br><span class="line">  &#125;,  </span><br><span class="line">  &#123;  </span><br><span class="line">    <span class="attr">"group"</span>: <span class="string">"其他频道"</span>,  </span><br><span class="line">    <span class="attr">"list"</span>: [  </span><br><span class="line">      &#123;  </span><br><span class="line">        <span class="attr">"安徽卫视"</span>: <span class="string">"http://220.248.175.230:6610/001/2/ch00000090990000001024/index.m3u8?virtualDomain=001.live_hls.zte.com"</span>  </span><br><span class="line">      &#125;,  </span><br><span class="line">      &#123;  </span><br><span class="line">        <span class="attr">"北京卫视"</span>: <span class="string">"http://220.248.175.230:6610/001/2/ch00000090990000001025/index.m3u8?virtualDomain=001.live_hls.zte.com"</span>  </span><br><span class="line">      &#125;  </span><br><span class="line">    ]  </span><br><span class="line">  &#125;,  </span><br><span class="line">  &#123;  </span><br><span class="line">    <span class="attr">"group"</span>: <span class="string">"高清频道"</span>,  </span><br><span class="line">    <span class="attr">"list"</span>: [  </span><br><span class="line">      &#123;  </span><br><span class="line">        <span class="attr">"CCTV1综合HD"</span>: <span class="string">"http://220.248.175.230:6610/001/2/ch00000090990000001075/index.m3u8?virtualDomain=001.live_hls.zte.com"</span>  </span><br><span class="line">      &#125;,  </span><br><span class="line">      &#123;  </span><br><span class="line">        <span class="attr">"湖南经视HD"</span>: <span class="string">"http://220.248.175.230:6610/001/2/ch00000090990000001080/index.m3u8?virtualDomain=001.live_hls.zte.com"</span>  </span><br><span class="line">      &#125;  </span><br><span class="line">    ]  </span><br><span class="line">  &#125;,  </span><br><span class="line">  &#123;  </span><br><span class="line">    <span class="attr">"group"</span>: <span class="string">"央视频道"</span>,  </span><br><span class="line">    <span class="attr">"list"</span>: [  </span><br><span class="line">      &#123;  </span><br><span class="line">        <span class="attr">"CCTV1综合"</span>: <span class="string">"http://220.248.175.230:6610/001/2/ch00000090990000001075/index.m3u8?virtualDomain=001.live_hls.zte.com"</span>  </span><br><span class="line">      &#125;,  </span><br><span class="line">      &#123;  </span><br><span class="line">        <span class="attr">"CCTV证券"</span>: <span class="string">"http://220.248.175.230:6610/001/2/ch00000090990000001133/index.m3u8?virtualDomain=001.live_hls.zte.com"</span>  </span><br><span class="line">      &#125;  </span><br><span class="line">    ]  </span><br><span class="line">  &#125;  </span><br><span class="line">]</span><br></pre></td></tr></table></figure></p>
]]></content>
      
        <categories>
            
            <category> 随笔 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> java </tag>
            
            <tag> android </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Linux mint作为开发机的日常使用记录，持续更新]]></title>
      <url>/2017/10/26/linux-mint/</url>
      <content type="html"><![CDATA[<h2 id="配置软件源"><a href="#配置软件源" class="headerlink" title="配置软件源"></a>配置软件源</h2><p>更新系统：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt <span class="keyword">update</span>  </span><br><span class="line">sudo apt-<span class="keyword">get</span> <span class="keyword">upgrade</span></span><br></pre></td></tr></table></figure></p>
<p><img src="/upload/images/linux/source.png" alt="img"><br>这里选择网络连接最快的源</p>
<h2 id="中文输入法问题"><a href="#中文输入法问题" class="headerlink" title="中文输入法问题"></a>中文输入法问题</h2><p>作为开发机器装好系统第一件事就是中文输入法的配置，在安装的时候选择中文语言会自动下载相关的语言包。<br>1) 使用系统默认的fcitx的拼音输入法：<br>发现输入中文的时候根本看不到候选框。解决办法：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt <span class="keyword">purge</span> fcitx-ui-qimpanel  </span><br><span class="line">sudo apt-<span class="keyword">get</span>  <span class="keyword">install</span> fcitx-config-gtk</span><br></pre></td></tr></table></figure></p>
<p>在附加组件把qimpanel勾选去掉<br>原因是fcitx跟QT冲突<br>2) 使用sogou输入法：<br>下载地址：<a href="http://cdn2.ime.sogou.com/dl/index/1491565850/sogoupinyin_2.1.0.0086_amd64.deb?st=91JBmvFURKntLXuHf1VhkA&amp;e=1508982588&amp;fn=sogoupinyin_2.1.0.0086_amd64.deb" target="_blank" rel="external">http://cdn2.ime.sogou.com/dl/index/1491565850/sogoupinyin_2.1.0.0086_amd64.deb?st=91JBmvFURKntLXuHf1VhkA&amp;e=1508982588&amp;fn=sogoupinyin_2.1.0.0086_amd64.deb</a><br>安装：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt <span class="keyword">install</span> libopencc2 libopencc1 fcitx-libs fcitx-libs-qt  </span><br><span class="line">sudo dpkg -i sogoupinyin_2<span class="number">.1</span><span class="number">.0</span><span class="number">.0086</span>_amd64.deb</span><br></pre></td></tr></table></figure></p>
<p>安装之前需要安装依赖包，然后我们开始输入中文，发现候选框全是一堆乱七八糟的字母数字，原因是我们在第一步把qimpanel选项去掉了，在fcitx-config中重新启用然后注销登录之后发现可以正常使用了。<br>3)全新安装<br>如果系统装好后没有中文输入法，手动安装：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt <span class="keyword">install</span> fcitx fcitx-googlepinyin fcitx-config-gtk fcitx-frontend-all fcitx-<span class="keyword">module</span>-cloudpinyin fcitx-ui-classic</span><br></pre></td></tr></table></figure></p>
<p>完成后注销重新登录即可。</p>
<h2 id="安装java"><a href="#安装java" class="headerlink" title="安装java"></a>安装java</h2><p>Oracle Java 8</p>
<ol>
<li>sudo add-apt-repository ppa:webupd8team/java  </li>
<li>sudo apt-get update  </li>
<li>sudo apt-get install oracle-java8-installer <h2 id="安装网易云音乐"><a href="#安装网易云音乐" class="headerlink" title="安装网易云音乐"></a>安装网易云音乐</h2>下载地址：<a href="http://s1.music.126.net/download/pc/netease-cloud-music_1.0.0-2_amd64_ubuntu16.04.deb" target="_blank" rel="external">http://s1.music.126.net/download/pc/netease-cloud-music_1.0.0-2_amd64_ubuntu16.04.deb</a><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt <span class="keyword">install</span> libqt5multimediawidgets5  </span><br><span class="line">sudo dpkg -i netease-cloud-music_1<span class="number">.0</span><span class="number">.0</span><span class="number">-2</span>_amd64_ubuntu16<span class="number">.04</span>.deb</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="安装解码和flash插件"><a href="#安装解码和flash插件" class="headerlink" title="安装解码和flash插件"></a>安装解码和flash插件</h2><p><code>sudo apt install flashplugin-installer gstreamer1.0-fluendo-mp3 ttf-mscorefonts-installer</code></p>
<h2 id="安装MySQL"><a href="#安装MySQL" class="headerlink" title="安装MySQL"></a>安装MySQL</h2><p><code>sudo apt-get install mysql-server mysql-common</code><br>安装过程会提示输入root密码，使用sudo mysql -uroot -p测试安装结果</p>
<h2 id="安装chrome"><a href="#安装chrome" class="headerlink" title="安装chrome"></a>安装chrome</h2><p>下载地址：<a href="http://www.google.cn/chrome/browser/desktop/index.html?standalone=1" target="_blank" rel="external">http://www.google.cn/chrome/browser/desktop/index.html?standalone=1</a><br>访问不了可以下载这个：<a href="http://download.csdn.net/download/qq381332153/10039953" target="_blank" rel="external">http://download.csdn.net/download/qq381332153/10039953</a><br><code>sudo dpkg -i google-chrome-stable_current_amd64.deb</code></p>
<h2 id="安装Android-Studio"><a href="#安装Android-Studio" class="headerlink" title="安装Android Studio"></a>安装Android Studio</h2><p>开启32位包支持<br><code>sudo dpkg --add-architecture i386</code><br>下载地址：<a href="https://developer.android.google.cn/studio/install.html" target="_blank" rel="external">https://developer.android.google.cn/studio/install.html</a><br>启动过程中提示设置代理下载SDK，地址设置为：mirrors.neusoft.edu.cn，端口80</p>
<h2 id="开机挂在文件系统"><a href="#开机挂在文件系统" class="headerlink" title="开机挂在文件系统"></a>开机挂在文件系统</h2><p>在/etc/fstab可以配置系统启动的时候挂在指定文件系统。在双系统中我们一般会去挂载WIN下的磁盘：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"># /etc/fstab: static file system information.  </span><br><span class="line">#  </span><br><span class="line"># Use 'blkid' to print the universally unique identifier for a  </span><br><span class="line"># device; this may be used with UUID= as a more robust way to name devices  </span><br><span class="line"># that works even if disks are added and removed. See fstab(5).  </span><br><span class="line">#  </span><br><span class="line"># <span class="tag">&lt;<span class="name">file</span> <span class="attr">system</span>&gt;</span> <span class="tag">&lt;<span class="name">mount</span> <span class="attr">point</span>&gt;</span>   <span class="tag">&lt;<span class="name">type</span>&gt;</span>  <span class="tag">&lt;<span class="name">options</span>&gt;</span>       <span class="tag">&lt;<span class="name">dump</span>&gt;</span>  <span class="tag">&lt;<span class="name">pass</span>&gt;</span>  </span><br><span class="line"># / was on /dev/sdb7 during installation  </span><br><span class="line">UUID=d281aec2-a293-45e0-868b-546c763fbdd2 /               ext4    errors=remount-ro 0       1  </span><br><span class="line"># /boot/efi was on /dev/sdb2 during installation  </span><br><span class="line">UUID=861D-7C13  /boot/efi       vfat    umask=0077      0       1  </span><br><span class="line"># /home was on /dev/sdb8 during installation  </span><br><span class="line">UUID=e1bfa6c7-6a21-45c4-81c2-48ac209fc2c7 /home           ext4    defaults        0       2  </span><br><span class="line">#C  </span><br><span class="line">UUID=66CC2017CC1FDFDB    /media/C   ntfs  defaults,user,rw,iocharset=utf8,umask=000,nls=utf8    0    3  </span><br><span class="line">#D  </span><br><span class="line">UUID=503EC4343EC414BE    /media/D    ntfs  defaults,user,rw,iocharset=utf8,umask=000,nls=utf8    0    4 </span><br><span class="line">``` </span><br><span class="line">上边我配置了C和D盘的启动自动挂载，文件系统格式是NTFS，UUID可以通过命令查看。其中每项的说明如下：</span><br><span class="line"></span><br><span class="line">gongxufan@gongxufan-ThinkPad-E460 ~ $ blkid  </span><br><span class="line">```sql</span><br><span class="line">/dev/sda1: LABEL="M-fM-^AM-\"M-eM-$M-^M" UUID="92501C01501BEB2D" TYPE="ntfs" PARTLABEL="Basic data partition" PARTUUID="b50dc9c9-eb35-499d-b02c-ee8378a63282"  </span><br><span class="line">/dev/sda2: UUID="861D-7C13" TYPE="vfat" PARTLABEL="EFI system partition" PARTUUID="6ecc9e85-c8a0-4623-b6f6-94bef54c975d"  </span><br><span class="line">/dev/sda4: LABEL="C" UUID="66CC2017CC1FDFDB" TYPE="ntfs" PARTLABEL="Basic data partition" PARTUUID="cffc126d-484f-4b08-8462-c99f103a8175"  </span><br><span class="line">/dev/sda5: UUID="0E201336201323ED" TYPE="ntfs" PARTUUID="2a95117a-f37c-4034-b298-da7d57ed0985"  </span><br><span class="line">/dev/sda6: LABEL="D" UUID="503EC4343EC414BE" TYPE="ntfs" PARTLABEL="Basic data partition" PARTUUID="8fcb1827-9fed-4c71-9a82-f524d973c8ad"  </span><br><span class="line">/dev/sda7: UUID="d281aec2-a293-45e0-868b-546c763fbdd2" TYPE="ext4" PARTUUID="ecd02f18-c001-4b32-888b-f2e28515116c"  </span><br><span class="line">/dev/sda8: UUID="e1bfa6c7-6a21-45c4-81c2-48ac209fc2c7" TYPE="ext4" PARTUUID="6c2cbde7-ac4e-4beb-a863-958f5cb2bbf7"</span><br></pre></td></tr></table></figure></p>
<p>接着是挂载点，需要自己在系统预先创建好目录<br>第三项是目标文件系统的格式<br>接着是参数，一般中文的要设置UTF8，还有读写权限等<br>再接着是否备份，一般设置为0就可以<br>最后是fsck磁盘自检顺序，设置0表示不进行自检<br>最后可以通过sudo mount -a测试配置正确。</p>
<h2 id="home目录下模板目录的管理"><a href="#home目录下模板目录的管理" class="headerlink" title="home目录下模板目录的管理"></a>home目录下模板目录的管理</h2><p>默认情况下会有Downloads,Docments等模板目录，这些目录是根据语言来设置。具体如下：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gongxufan@gongxufan-ThinkPad-E460 ~/.config $ ls  </span><br><span class="line">autostart  cinnamon-session  enchant         filezilla      gtk-3.0      menus          netease-cloud-music  SogouPY         tomboy          user-dirs.locale  xplayer  </span><br><span class="line">caja       cobinja           fcitx           google-chrome  hexchat      mimeapps.list  pix                  SogouPY.users   Trolltech.conf  VirtualBox        xviewer  </span><br><span class="line">chromium   dconf             fcitx-qimpanel  gtk-2.0        libreoffice  nemo           pulse                sogou-qimpanel  user-dirs.dirs  xed</span><br></pre></td></tr></table></figure></p>
<p>其定义：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">gongxufan@gongxufan-ThinkPad-E460 ~/.config $ cat user-dirs.dirs   </span><br><span class="line"># This file is written by xdg-user-dirs-update  </span><br><span class="line"># If you want to change or add directories, just edit the line you're  </span><br><span class="line"># interested in. All local changes will be retained on the next run  </span><br><span class="line"># Format is XDG_xxx_DIR="$HOME/yyy", where yyy is a shell-escaped  </span><br><span class="line"># homedir-relative path, or XDG_xxx_DIR="/yyy", where /yyy is an  </span><br><span class="line"># absolute path. No other format is supported.  </span><br><span class="line">#   </span><br><span class="line">XDG_DESKTOP_DIR="$HOME/Desktop"  </span><br><span class="line">XDG_DOWNLOAD_DIR="$HOME/下载"  </span><br><span class="line">XDG_TEMPLATES_DIR="$HOME/模板"  </span><br><span class="line">XDG_PUBLICSHARE_DIR="$HOME/公共的"  </span><br><span class="line">XDG_DOCUMENTS_DIR="$HOME/文档"  </span><br><span class="line">XDG_MUSIC_DIR="$HOME/音乐"  </span><br><span class="line">XDG_PICTURES_DIR="$HOME/图片"  </span><br><span class="line">XDG_VIDEOS_DIR="$HOME/视频"</span><br></pre></td></tr></table></figure></p>
<p>该模板是根据l语言自动设置的：<br>user-dirs.locale文件定义了当前的语言</p>
<h2 id="查看硬件信息并保存到html文件"><a href="#查看硬件信息并保存到html文件" class="headerlink" title="查看硬件信息并保存到html文件"></a>查看硬件信息并保存到html文件</h2><p><code>sudo lshw -html &gt; ~/hw.html</code></p>
<h2 id="安装numpy"><a href="#安装numpy" class="headerlink" title="安装numpy"></a>安装numpy</h2><p>for python3+<br><code>sudo apt-get install python3-numpy python3-scipy python3-matplotlib ipython3 ipython3-notebook python3-pandas python-sympy python3-nose</code></p>
<p>for python2+<br><code>sudo apt-get install python-numpy python-scipy python-matplotlib ipython ipython-notebook python-pandas python-sympy python-nose</code></p>
]]></content>
      
        <categories>
            
            <category> 随笔 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> linux </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[如何正确使用Java8的Optional机制]]></title>
      <url>/2017/10/23/java8-optional/</url>
      <content type="html"><![CDATA[<p>Java8带来的函数式编程特性对于习惯命令式编程的程序员来说还是有一定的障碍的，我们只有深入了解这些机制的方方面面才能运用自如。Null的处理在JAVA编程中是出了try catch之外的另一个头疼的问题，需要大量的非空判断模板代码，程序逻辑嵌套层次太深。尤其是对集合的使用，需要层层判空。</p>
<p>首先来看下Optional类的结构图：<br><img src="/upload/images/java/optional.png" alt="img"></p>
<h2 id="属性"><a href="#属性" class="headerlink" title="属性"></a>属性</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * Common instance for &#123;<span class="doctag">@code</span> empty()&#125;. </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Optional&lt;?&gt; EMPTY = <span class="keyword">new</span> Optional&lt;&gt;();  </span><br><span class="line">  </span><br><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * If non-null, the value; if null, indicates no value is present </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> T value;</span><br></pre></td></tr></table></figure>
<p>1) EMPTY持有某个类型的空值结构,调用empty()返回的即是该实例<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span>&lt;T&gt; Optional&lt;T&gt; <span class="title">empty</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">       <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)  </span><br><span class="line">       Optional&lt;T&gt; t = (Optional&lt;T&gt;) EMPTY;  </span><br><span class="line">       <span class="keyword">return</span> t;  </span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>2) T vaule是该结构的持有的值</p>
<h2 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h2><h3 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">Optional</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">this</span>.value = <span class="keyword">null</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">Optional</span><span class="params">(T value)</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">this</span>.value = Objects.requireNonNull(value);  </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>Optional(T value)如果vaule为null就会抛出NullPointer异常,所以对于使用的场景这两个构造器都适用.</p>
<h3 id="生成Optional对象"><a href="#生成Optional对象" class="headerlink" title="生成Optional对象"></a>生成Optional对象</h3><p>有两个方法 of(T)和ofNullable(T)<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">Optional&lt;T&gt; <span class="title">of</span><span class="params">(T value)</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Optional&lt;&gt;(value);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">Optional&lt;T&gt; <span class="title">ofNullable</span><span class="params">(T value)</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> value == <span class="keyword">null</span> ? empty() : of(value);  </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>of是直接调用的构造函数,因此如果T为null则会抛出空指针异常,ofNullable对null进行了处理,会返回EMPTY的实例,因此不会出现异常。</p>
<p>所以只有对于明确不会为null的对象才能直接使用of</p>
<h3 id="获取Optional对象的值"><a href="#获取Optional对象的值" class="headerlink" title="获取Optional对象的值"></a>获取Optional对象的值</h3><p>需要摈弃的使用方式</p>
<blockquote>
<p>if(value.isPresent){<br>  ….<br>  }else{<br>  T t  = value.get();<br>  }</p>
</blockquote>
<p>这种使用方式无异于传统的if(vaule != null)<br>正确的使用姿势:</p>
<blockquote>
<p>orElse:如果值为空则返回指定的值<br>orElseGet:如果值为空则调用指定的方法返回<br>orElseThrow:如果值为空则直接抛出异常</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">orElse</span><span class="params">(T other)</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">return</span> value != <span class="keyword">null</span> ? value : other;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">orElseGet</span><span class="params">(Supplier&lt;? extends T&gt; other)</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">return</span> value != <span class="keyword">null</span> ? value : other.get();  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> &lt;X extends Throwable&gt; <span class="function">T <span class="title">orElseThrow</span><span class="params">(Supplier&lt;? extends X&gt; exceptionSupplier)</span> <span class="keyword">throws</span> X </span>&#123;  </span><br><span class="line">    <span class="keyword">if</span> (value != <span class="keyword">null</span>) &#123;  </span><br><span class="line">        <span class="keyword">return</span> value;  </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">        <span class="keyword">throw</span> exceptionSupplier.get();  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一般我们使用orElse来取值,如果不存在返回默认值.</p>
<h3 id="Optional的中间处理"><a href="#Optional的中间处理" class="headerlink" title="Optional的中间处理"></a>Optional的中间处理</h3><p>filter,map,flatMap,这几个操作跟Stream的处理类似,只是要注意flatMap处理必须手动指定返回类型为Optional<u>,而map会自动将返回值包装成Optional.举个栗子,我们有商品很订单的结构:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> model;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> java.util.List;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auth</span> gongxufan </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2017/10/23 </span></span><br><span class="line"><span class="comment"> **/</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Goods</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">private</span> String goodsName;  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">double</span> price;  </span><br><span class="line">    <span class="keyword">private</span> List&lt;Order&gt; orderList;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getGoodsName</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> goodsName;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setGoodsName</span><span class="params">(String goodsName)</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">this</span>.goodsName = goodsName;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">getPrice</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> price;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPrice</span><span class="params">(<span class="keyword">double</span> price)</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">this</span>.price = price;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Order&gt; <span class="title">getOrderList</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> orderList;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOrderList</span><span class="params">(List&lt;Order&gt; orderList)</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">this</span>.orderList = orderList;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> model;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auth</span> gongxufan </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2017/10/23 </span></span><br><span class="line"><span class="comment"> **/</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Order</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">private</span> LocalDateTime createTime;  </span><br><span class="line">    <span class="keyword">private</span> LocalDateTime finishTime;  </span><br><span class="line">    <span class="keyword">private</span> String orderName;  </span><br><span class="line">    <span class="keyword">private</span> String orderUser;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> LocalDateTime <span class="title">getCreateTime</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> createTime;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCreateTime</span><span class="params">(LocalDateTime createTime)</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">this</span>.createTime = createTime;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> LocalDateTime <span class="title">getFinishTime</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> finishTime;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFinishTime</span><span class="params">(LocalDateTime finishTime)</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">this</span>.finishTime = finishTime;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getOrderName</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> orderName;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOrderName</span><span class="params">(String orderName)</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">this</span>.orderName = orderName;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getOrderUser</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> orderUser;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOrderUser</span><span class="params">(String orderUser)</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">this</span>.orderUser = orderUser;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></u></p>
<p>现在我有一个goodsOptional<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Optional&lt;Goods&gt; goodsOptional = Optional.ofNullable(<span class="keyword">new</span> Goods());</span><br></pre></td></tr></table></figure></p>
<p>现在我需要获取goodsOptional里边的orderList,应该这样你操作<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">goodsOptional.flatMap(g -&gt;Optional.ofNullable(g.getOrderList())).orElse(Collections.emptyList())</span><br></pre></td></tr></table></figure></p>
<p>flatMap里头返回的是Optional<list<order>&gt;,然后我们再使用orElse进行unwraap.因此faltMap可以解引用更深层次的的对象链.</list<order></p>
<h3 id="检测Optional并执行动作"><a href="#检测Optional并执行动作" class="headerlink" title="检测Optional并执行动作"></a>检测Optional并执行动作</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ifPresent</span><span class="params">(Consumer&lt;? <span class="keyword">super</span> T&gt; consumer)</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">if</span> (value != <span class="keyword">null</span>)  </span><br><span class="line">            consumer.accept(value);  </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这是一个终端操作,不像上边的可以进行链式操作.在Optional实例使用直接调用,如果value存在则会调用指定的消费方法.举个栗子:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Goods goods = <span class="keyword">new</span> Goods();  </span><br><span class="line">Optional&lt;Goods&gt; goodsOptional = Optional.ofNullable(goods);  </span><br><span class="line">List&lt;Order&gt; orderList = <span class="keyword">new</span> ArrayList&lt;&gt;();  </span><br><span class="line">goods.setOrderList(orderList);  </span><br><span class="line">goodsOptional.flatMap(g -&gt;Optional.ofNullable(g.getOrderList())).ifPresent((v)-&gt; System.out.println(v));</span><br></pre></td></tr></table></figure></p>
<h2 id="end"><a href="#end" class="headerlink" title="end"></a>end</h2><p>至此该类的方法和使用介绍都差不多了,最后总结需要注意的地方:<br>1) Optional应该只用处理返回值,而不应该作为类的字段或者方法的参数.因为这样会造成额外的复杂度.<br>2) 使用Option应该避免直接适应构造器和get,而应该使用isElse的系列方法避免频繁的非空判断<br>3) map和flatMap要注意区分使用场景</p>
]]></content>
      
        <categories>
            
            <category> 随笔 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> java </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Probably the largest collection of Java(tm) Servlets and filters]]></title>
      <url>/2017/10/20/servlets-and-filters/</url>
      <content type="html"><![CDATA[<p>如题所述“Probably the largest collection of Java(tm) Servlets and filters”，该站点提供了安全，session,IP,时间等工具。其提供的每一个工具包都有简要的介绍和使用说明，如果我们想进一步了解其实现细节或者二次开发可以反编译查看源码。</p>
<p>比如我们常用的XSS过滤：</p>
<p>This is a Java servlet filter (as per Servlet API 2.3). This filter lets you deal with Cross Site Scripting (XSS) attempts. Filter intercepts every request sent to your web application and then cleans any potential script injection. What it basically does is remove all suspicious strings from request parameters (and headers) before returning them to the application.<br>How to use it:</p>
<ul>
<li>download xssflt.jar and save it in WEB-INF/lib</li>
<li><p>describe this filter in web.xml. An optional initial parameter apostrophe lets you define the replacement code for apostrophe (‘) sign. By default it is &#39;. </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span> </span><br><span class="line">  <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>XSSFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span> </span><br><span class="line">  <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>com.cj.xss.XSSFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>describe a mapping for this filter in web.xml. E.g.: </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span> </span><br><span class="line">  <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>XSSFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span> </span><br><span class="line">  <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>in this example filter will be on for the each file.</p>
<p>这样的使用说明真是大道至简。。。</p>
<h2 id="下载地址"><a href="#下载地址" class="headerlink" title="下载地址"></a>下载地址</h2><p>servletsuite站点地址：<a href="http://www.servletsuite.com/filters.htm" target="_blank" rel="external">http://www.servletsuite.com/filters.htm</a><br>csdn本地全集下载地址：<a href="http://download.csdn.net/download/qq381332153/10026088" target="_blank" rel="external">http://download.csdn.net/download/qq381332153/10026088</a></p>
]]></content>
      
        <categories>
            
            <category> 转载 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> java </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[【基于IntelliJ IDEA环境】Tomcat8源码的调试和项目部署]]></title>
      <url>/2017/10/20/tomcat-source-debug/</url>
      <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Tomcat作为J2EE的开源实现，其代码具有很高的参考价值，我们可以从中汲取很多的知识。比如ClassLoader机制，设计模式等。本文只描述了环境搭配方法，具体的源码分析可以参考《How Tomcat Works》 一书。Tomcat现在都到9了，虽然该书是基于5.0但还是具有一定参考意义的。</p>
<h2 id="一，准备工作"><a href="#一，准备工作" class="headerlink" title="一，准备工作"></a>一，准备工作</h2><p>Tomcat的构建是基于Ant和Eclipse的，然而现在很多人都喜欢IDEA+Maven的项目构建方式，所以本文将基于这个环境来搭建源码的调试。我们需要以下工具：</p>
<ul>
<li><p>Tomcat源码下载地址：<a href="https://mirrors.tuna.tsinghua.edu.cn/apache/tomcat/tomcat-8/v8.5.23/src/apache-tomcat-8.5.23-src.tar.gz" target="_blank" rel="external">https://mirrors.tuna.tsinghua.edu.cn/apache/tomcat/tomcat-8/v8.5.23/src/apache-tomcat-8.5.23-src.tar.gz</a></p>
</li>
<li><p>IDEA工具：<a href="https://www.jetbrains.com/idea/download" target="_blank" rel="external">https://www.jetbrains.com/idea/download</a></p>
</li>
<li><p>MAVEN：<a href="http://maven.apache.org/download.cgi" target="_blank" rel="external">http://maven.apache.org/download.cgi</a></p>
</li>
<li><p>JDK：自然不用多提了，但是要按照所选源码要求的版本，这里用的是JDK8</p>
</li>
</ul>
<p>安装和下载这些软件包就可以开始搭建调试环境了。</p>
<h2 id="二，项目结构"><a href="#二，项目结构" class="headerlink" title="二，项目结构"></a>二，项目结构</h2><p><img src="/upload/images/tomcat/jiegou.png" alt="img"></p>
<ul>
<li>新建一个目录，比如：D:\code\tomcat8，然后将tomcat8的源码解压至该目录</li>
<li>新建catalina-home目录，然后将apache-tomcat-8.5.23-src目录下的 conf文件夹拷贝到此处，该目录结构如下<br><img src="/upload/images/tomcat/conf.png" alt="img"><br>除了conf目录其他都是可选的，webapps用于我们应用默认的部署目录，work logs是启动Tomcat自动生成的，其结构跟我们下载的二进制Tomcat程序是一样的.</li>
<li>配置Maven依赖</li>
</ul>
<p>我们采用module的形式来组织目录,首先在根目录(D:\code\tomcat8)下创建pom.xml,其内容如下:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;    </span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span>    </span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd"</span>&gt;</span>    </span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span>    </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>gxf<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>    </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>apache-tomcat-8<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>    </span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>apache-tomcat-8-source<span class="tag">&lt;/<span class="name">name</span>&gt;</span>    </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span>    </span><br><span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span>    </span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">modules</span>&gt;</span>    </span><br><span class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>apache-tomcat-8.5.23-src<span class="tag">&lt;/<span class="name">module</span>&gt;</span>    </span><br><span class="line">    <span class="tag">&lt;/<span class="name">modules</span>&gt;</span>    </span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>这里主要指定module为Tomcat的源码目录,然后在apache-tomcat-8.5.23-src配置Tomcat源码额外的依赖，在该目录创建pom.xml<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;    </span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span>    </span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span>    </span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span>    </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span>    </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>    </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>Tomcat8.0<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>    </span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>Tomcat8.0<span class="tag">&lt;/<span class="name">name</span>&gt;</span>    </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span>    </span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span>    </span><br><span class="line">        <span class="tag">&lt;<span class="name">finalName</span>&gt;</span>Tomcat8.0<span class="tag">&lt;/<span class="name">finalName</span>&gt;</span>    </span><br><span class="line">        <span class="tag">&lt;<span class="name">sourceDirectory</span>&gt;</span>java<span class="tag">&lt;/<span class="name">sourceDirectory</span>&gt;</span>    </span><br><span class="line">        <span class="tag">&lt;<span class="name">testSourceDirectory</span>&gt;</span>test<span class="tag">&lt;/<span class="name">testSourceDirectory</span>&gt;</span>    </span><br><span class="line">        <span class="tag">&lt;<span class="name">resources</span>&gt;</span>    </span><br><span class="line">            <span class="tag">&lt;<span class="name">resource</span>&gt;</span>    </span><br><span class="line">                <span class="tag">&lt;<span class="name">directory</span>&gt;</span>java<span class="tag">&lt;/<span class="name">directory</span>&gt;</span>    </span><br><span class="line">            <span class="tag">&lt;/<span class="name">resource</span>&gt;</span>    </span><br><span class="line">        <span class="tag">&lt;/<span class="name">resources</span>&gt;</span>    </span><br><span class="line">        <span class="tag">&lt;<span class="name">testResources</span>&gt;</span>    </span><br><span class="line">            <span class="tag">&lt;<span class="name">testResource</span>&gt;</span>    </span><br><span class="line">                <span class="tag">&lt;<span class="name">directory</span>&gt;</span>test<span class="tag">&lt;/<span class="name">directory</span>&gt;</span>    </span><br><span class="line">            <span class="tag">&lt;/<span class="name">testResource</span>&gt;</span>    </span><br><span class="line">        <span class="tag">&lt;/<span class="name">testResources</span>&gt;</span>    </span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span>    </span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span>    </span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>    </span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>    </span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span>    </span><br><span class="line">    </span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span>    </span><br><span class="line">                    <span class="tag">&lt;<span class="name">encoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">encoding</span>&gt;</span>    </span><br><span class="line">                    <span class="tag">&lt;<span class="name">source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">source</span>&gt;</span>    </span><br><span class="line">                    <span class="tag">&lt;<span class="name">target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">target</span>&gt;</span>    </span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span>    </span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span>    </span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span>    </span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span>    </span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.easymock<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>easymock<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>    </span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>    </span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>    </span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span>    </span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>    </span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>    </span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ant<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>    </span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ant<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>    </span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span>    </span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>    </span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>    </span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>wsdl4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>    </span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>wsdl4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>    </span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.6.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span>    </span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>    </span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>    </span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.xml<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>    </span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jaxrpc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>    </span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span>    </span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>    </span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>    </span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.eclipse.jdt.core.compiler<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>    </span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ecj<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>    </span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.6.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>    </span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span>    </span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>至此基本的结构已经完成了</p>
<h2 id="三，准备构建"><a href="#三，准备构建" class="headerlink" title="三，准备构建"></a>三，准备构建</h2><h3 id="使用IDEA打开项目"><a href="#使用IDEA打开项目" class="headerlink" title="使用IDEA打开项目"></a>使用IDEA打开项目</h3><p><img src="/upload/images/tomcat/open.png" alt="img"><br>注意这里是直接打开项目，定位到D:\code\tomcat8，然后选择pom.xml，idea会自动识别Maven项目。这一部完成后IDEA开始下载MAVEN依赖包，完整的结构如下：<br><img src="/upload/images/tomcat/whole.png" alt="img"></p>
<h3 id="配置编译环境"><a href="#配置编译环境" class="headerlink" title="配置编译环境"></a>配置编译环境</h3><p>说明：如果编译build的时候出现Test测试代码报错，删除该代码即可。本文中的Tomcat源码util.TestCookieFilter类会报错，将其删除即可。<br><img src="/upload/images/tomcat/env.png" alt="img"><br>1) 打开项目的Run/Debug配置界面，Main class设置为org.apache.catalina.startup.Bootstrap<br>2) 添加VM options -Dcatalina.home=catalina-home -Dcatalina.base=catalina-home   -Djava.endorsed.dirs=catalina-home/endorsed -Djava.io.tmpdir=catalina-home/temp   -Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager   -Djava.util.logging.config.file=catalina-home/conf/logging.properties<br>3) 选择module为Tomcat8.0（源码所在的module）<br>4) 点击Debug按钮启动程序</p>
<h3 id="启动工程"><a href="#启动工程" class="headerlink" title="启动工程"></a>启动工程</h3><p>我们点击调试按钮后发现会报错，如下：<br><img src="/upload/images/tomcat/error.png" alt="img"><br>原来是构建tomcat-jdbc的时候报错了，这里我们手动指定版本号就可以了，修改文件D:\code\tomcat8\apache-tomcat-8.5.23-src\modules\jdbc-pool\resources\MANIFEST.MF中的Bundle-Version: @VERSION@，把Bundle-Version: 8。这里的构建可能会有点卡顿。</p>
<p>好了，一切顺利项目启动成功了。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">"C:\Program Files\Java\jdk1.8.0_111\bin\java" -agentlib:jdwp=transport=dt_socket,address=127.0.0.1:55097,suspend=y,server=n -Dvisualvm.id=150866430461380 -Dcatalina.home=catalina-home -Dcatalina.base=catalina-home -Djava.endorsed.dirs=catalina-home/endorsed -Djava.io.tmpdir=catalina-home/temp -Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager -Djava.util.logging.config.file=catalina-home/conf/logging.properties -Dfile.encoding=UTF-8 -classpath "C:\Program Files\Java\jdk1.8.0_111\jre\lib\charsets.jar;C:\Program Files\Java\jdk1.8.0_111\jre\lib\deploy.jar;C:\Program Files\Java\jdk1.8.0_111\jre\lib\ext\access-bridge-64.jar;C:\Program Files\Java\jdk1.8.0_111\jre\lib\ext\cldrdata.jar;C:\Program Files\Java\jdk1.8.0_111\jre\lib\ext\dnsns.jar;C:\Program Files\Java\jdk1.8.0_111\jre\lib\ext\jaccess.jar;C:\Program Files\Java\jdk1.8.0_111\jre\lib\ext\jfxrt.jar;C:\Program Files\Java\jdk1.8.0_111\jre\lib\ext\localedata.jar;C:\Program Files\Java\jdk1.8.0_111\jre\lib\ext\nashorn.jar;C:\Program Files\Java\jdk1.8.0_111\jre\lib\ext\sunec.jar;C:\Program Files\Java\jdk1.8.0_111\jre\lib\ext\sunjce_provider.jar;C:\Program Files\Java\jdk1.8.0_111\jre\lib\ext\sunmscapi.jar;C:\Program Files\Java\jdk1.8.0_111\jre\lib\ext\sunpkcs11.jar;C:\Program Files\Java\jdk1.8.0_111\jre\lib\ext\zipfs.jar;C:\Program Files\Java\jdk1.8.0_111\jre\lib\javaws.jar;C:\Program Files\Java\jdk1.8.0_111\jre\lib\jce.jar;C:\Program Files\Java\jdk1.8.0_111\jre\lib\jfr.jar;C:\Program Files\Java\jdk1.8.0_111\jre\lib\jfxswt.jar;C:\Program Files\Java\jdk1.8.0_111\jre\lib\jsse.jar;C:\Program Files\Java\jdk1.8.0_111\jre\lib\management-agent.jar;C:\Program Files\Java\jdk1.8.0_111\jre\lib\plugin.jar;C:\Program Files\Java\jdk1.8.0_111\jre\lib\resources.jar;C:\Program Files\Java\jdk1.8.0_111\jre\lib\rt.jar;D:\code\tomcat8\apache-tomcat-8.5.23-src\target\classes;C:\Users\gongxufan\.m2\repository\org\apache\ant\ant\1.7.0\ant-1.7.0.jar;C:\Users\gongxufan\.m2\repository\org\apache\ant\ant-launcher\1.7.0\ant-launcher-1.7.0.jar;C:\Users\gongxufan\.m2\repository\wsdl4j\wsdl4j\1.6.2\wsdl4j-1.6.2.jar;C:\Users\gongxufan\.m2\repository\javax\xml\jaxrpc-api\1.1\jaxrpc-api-1.1.jar;C:\Users\gongxufan\.m2\repository\org\eclipse\jdt\core\compiler\ecj\4.6.1\ecj-4.6.1.jar;D:\soft\IntelliJ IDEA 2017.1.4\lib\idea_rt.jar" org.apache.catalina.startup.Bootstrap  </span><br><span class="line">Connected to the target VM, address: '127.0.0.1:55097', transport: 'socket'  </span><br><span class="line">20-Oct-2017 13:05:22.684 信息 [main] org.apache.catalina.startup.VersionLoggerListener.log Server version:        Apache Tomcat/@VERSION@  </span><br><span class="line">20-Oct-2017 13:05:22.691 信息 [main] org.apache.catalina.startup.VersionLoggerListener.log Server built:          @VERSION_BUILT@  </span><br><span class="line">20-Oct-2017 13:05:22.691 信息 [main] org.apache.catalina.startup.VersionLoggerListener.log Server number:         @VERSION_NUMBER@  </span><br><span class="line">20-Oct-2017 13:05:22.692 信息 [main] org.apache.catalina.startup.VersionLoggerListener.log OS Name:               Windows 10  </span><br><span class="line">20-Oct-2017 13:05:22.692 信息 [main] org.apache.catalina.startup.VersionLoggerListener.log OS Version:            10.0  </span><br><span class="line">20-Oct-2017 13:05:22.692 信息 [main] org.apache.catalina.startup.VersionLoggerListener.log Architecture:          amd64  </span><br><span class="line">20-Oct-2017 13:05:22.692 信息 [main] org.apache.catalina.startup.VersionLoggerListener.log Java Home:             C:\Program Files\Java\jdk1.8.0_111\jre  </span><br><span class="line">20-Oct-2017 13:05:22.693 信息 [main] org.apache.catalina.startup.VersionLoggerListener.log JVM Version:           1.8.0_111-b14  </span><br><span class="line">20-Oct-2017 13:05:22.693 信息 [main] org.apache.catalina.startup.VersionLoggerListener.log JVM Vendor:            Oracle Corporation  </span><br><span class="line">20-Oct-2017 13:05:22.693 信息 [main] org.apache.catalina.startup.VersionLoggerListener.log CATALINA_BASE:         D:\code\tomcat8\catalina-home  </span><br><span class="line">20-Oct-2017 13:05:22.693 信息 [main] org.apache.catalina.startup.VersionLoggerListener.log CATALINA_HOME:         D:\code\tomcat8\catalina-home  </span><br><span class="line">20-Oct-2017 13:05:22.693 信息 [main] org.apache.catalina.startup.VersionLoggerListener.log Command line argument: -agentlib:jdwp=transport=dt_socket,address=127.0.0.1:55097,suspend=y,server=n  </span><br><span class="line">20-Oct-2017 13:05:22.693 信息 [main] org.apache.catalina.startup.VersionLoggerListener.log Command line argument: -Dvisualvm.id=150866430461380  </span><br><span class="line">20-Oct-2017 13:05:22.694 信息 [main] org.apache.catalina.startup.VersionLoggerListener.log Command line argument: -Dcatalina.home=catalina-home  </span><br><span class="line">20-Oct-2017 13:05:22.694 信息 [main] org.apache.catalina.startup.VersionLoggerListener.log Command line argument: -Dcatalina.base=catalina-home  </span><br><span class="line">20-Oct-2017 13:05:22.694 信息 [main] org.apache.catalina.startup.VersionLoggerListener.log Command line argument: -Djava.endorsed.dirs=catalina-home/endorsed  </span><br><span class="line">20-Oct-2017 13:05:22.694 信息 [main] org.apache.catalina.startup.VersionLoggerListener.log Command line argument: -Djava.io.tmpdir=catalina-home/temp  </span><br><span class="line">20-Oct-2017 13:05:22.694 信息 [main] org.apache.catalina.startup.VersionLoggerListener.log Command line argument: -Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager  </span><br><span class="line">20-Oct-2017 13:05:22.694 信息 [main] org.apache.catalina.startup.VersionLoggerListener.log Command line argument: -Djava.util.logging.config.file=catalina-home/conf/logging.properties  </span><br><span class="line">20-Oct-2017 13:05:22.694 信息 [main] org.apache.catalina.startup.VersionLoggerListener.log Command line argument: -Dfile.encoding=UTF-8  </span><br><span class="line">20-Oct-2017 13:05:22.695 信息 [main] org.apache.catalina.core.AprLifecycleListener.lifecycleEvent The APR based Apache Tomcat Native library which allows optimal performance in production environments was not found on the java.library.path: [C:\Program Files\Java\jdk1.8.0_111\bin;C:\WINDOWS\Sun\Java\bin;C:\WINDOWS\system32;C:\WINDOWS;D:\soft\oracle\bin;C:\Python27\;C:\Python27\Scripts;C:\WINDOWS\system32;C:\WINDOWS;C:\WINDOWS\System32\Wbem;C:\WINDOWS\System32\WindowsPowerShell\v1.0\;C:\Program Files (x86)\ATI Technologies\ATI.ACE\Core-Static;D:\apache-maven-3.5.0\bin;C:\Program Files\Java\jdk1.8.0_111\bin;D:\soft\Git\cmd;C:\Program Files\MySQL\MySQL Server 5.5\bin;D:\soft\AndroidStudio\sdk\tools;D:\soft\AndroidStudio\sdk\platform-tools;D:\soft\nodejs\;D:\soft\AndroidStudio\sdk\tools\bin;D:\soft\SVN\bin;D:\soft\AndroidStudio\app\gradle\gradle-3.2\bin;D:\soft\gradle-4.1\bin;C:\Users\gongxufan\AppData\Local\Microsoft\WindowsApps;C:\Users\gongxufan\AppData\Roaming\npm;;.]  </span><br><span class="line">20-Oct-2017 13:05:22.941 信息 [main] org.apache.coyote.AbstractProtocol.init Initializing ProtocolHandler ["http-nio-8080"]  </span><br><span class="line">20-Oct-2017 13:05:23.226 信息 [main] org.apache.tomcat.util.net.NioSelectorPool.getSharedSelector Using a shared selector for servlet write/read  </span><br><span class="line">20-Oct-2017 13:05:23.230 信息 [main] org.apache.coyote.AbstractProtocol.init Initializing ProtocolHandler ["ajp-nio-8009"]  </span><br><span class="line">20-Oct-2017 13:05:23.232 信息 [main] org.apache.tomcat.util.net.NioSelectorPool.getSharedSelector Using a shared selector for servlet write/read  </span><br><span class="line">20-Oct-2017 13:05:23.233 信息 [main] org.apache.catalina.startup.Catalina.load Initialization processed in 1361 ms  </span><br><span class="line">20-Oct-2017 13:05:23.290 信息 [main] org.apache.catalina.core.StandardService.startInternal Starting service [Catalina]  </span><br><span class="line">20-Oct-2017 13:05:23.290 信息 [main] org.apache.catalina.core.StandardEngine.startInternal Starting Servlet Engine: Apache Tomcat/@VERSION@</span><br></pre></td></tr></table></figure></p>
<h2 id="四，项目部署"><a href="#四，项目部署" class="headerlink" title="四，项目部署"></a>四，项目部署</h2><p>项目启动完毕我们可以测试了，在浏览器访问<a href="http://localhost:8080/就可以看到我们经典的欢迎页面了。这里前提是要把源码目录下的webapps复制到catalina-home目录。" target="_blank" rel="external">http://localhost:8080/就可以看到我们经典的欢迎页面了。这里前提是要把源码目录下的webapps复制到catalina-home目录。</a></p>
<p>然而当访问JSP的时候却报错了，比如访问：<a href="http://localhost:8080/index.jsp或者我们自己的项目的时候会出现JSP无法编译的错误。" target="_blank" rel="external">http://localhost:8080/index.jsp或者我们自己的项目的时候会出现JSP无法编译的错误。</a><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">java.lang.NullPointerException  </span><br><span class="line">    at org.apache.jasper.JspCompilationContext.getTldResourcePath(JspCompilationContext.java:<span class="number">536</span>)  </span><br><span class="line">    at org.apache.jasper.compiler.Parser.parseTaglibDirective(Parser.java:<span class="number">410</span>)  </span><br><span class="line">    at org.apache.jasper.compiler.Parser.parseDirective(Parser.java:<span class="number">469</span>)  </span><br><span class="line">    at org.apache.jasper.compiler.Parser.parseElements(Parser.java:<span class="number">1430</span>)  </span><br><span class="line">    at org.apache.jasper.compiler.Parser.parse(Parser.java:<span class="number">139</span>)  </span><br><span class="line">    at org.apache.jasper.compiler.ParserController.doParse(ParserController.java:<span class="number">227</span>)  </span><br><span class="line">    at org.apache.jasper.compiler.ParserController.parse(ParserController.java:<span class="number">100</span>)  </span><br><span class="line">    at org.apache.jasper.compiler.Compiler.generateJava(Compiler.java:<span class="number">199</span>)  </span><br><span class="line">    at org.apache.jasper.compiler.Compiler.compile(Compiler.java:<span class="number">356</span>)  </span><br><span class="line">    at org.apache.jasper.compiler.Compiler.compile(Compiler.java:<span class="number">336</span>)  </span><br><span class="line">    at org.apache.jasper.compiler.Compiler.compile(Compiler.java:<span class="number">323</span>)  </span><br><span class="line">    at org.apache.jasper.JspCompilationContext.compile(JspCompilationContext.java:<span class="number">570</span>)  </span><br><span class="line">    at org.apache.jasper.servlet.JspServletWrapper.service(JspServletWrapper.java:<span class="number">356</span>)  </span><br><span class="line">    at org.apache.jasper.servlet.JspServlet.serviceJspFile(JspServlet.java:<span class="number">396</span>)  </span><br><span class="line">    at org.apache.jasper.servlet.JspServlet.service(JspServlet.java:<span class="number">340</span>)  </span><br><span class="line">    at javax.servlet.http.HttpServlet.service(HttpServlet.java:<span class="number">725</span>)  </span><br><span class="line">    at org.wso2.carbon.ui.JspServlet.service(JspServlet.java:<span class="number">155</span>)  </span><br><span class="line">    at org.wso2.carbon.ui.TilesJspServlet.service(TilesJspServlet.java:<span class="number">80</span>)  </span><br><span class="line">    at javax.servlet.http.HttpServlet.service(HttpServlet.java:<span class="number">725</span>)</span><br></pre></td></tr></table></figure></p>
<p>原因是我们直接启动org.apache.catalina.startup.Bootstrap的时候没有加载org.apache.jasper.servlet.JasperInitializer，从而无法编译JSP。这在Tomcat6/7是没有这个问题的。解决办法是在tomcat的源码org.apache.catalina.startup.ContextConfig中手动将JSP解析器初始化：<br><code>context.addServletContainerInitializer(new JasperInitializer(), null);</code><br><img src="/upload/images/tomcat/init.png" alt="img"><br>至此，我们可以将项目直接放到Tomcat来启动调试了。本文描述的方式同样可以适用于其他版本(Tomcat6+)的Tomcat调试。</p>
<h2 id="五，部署外部项目"><a href="#五，部署外部项目" class="headerlink" title="五，部署外部项目"></a>五，部署外部项目</h2><p>默认情况下我们必须把应用程序部署到catalina-home/webapps下，如何直接部署访问外部的应用程序?我们只需要修改server.xml和web.xml配置即可。<br>1) 编辑catalina-home/conf/server.xml<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Host</span> <span class="attr">name</span>=<span class="string">"localhost"</span>  <span class="attr">appBase</span>=<span class="string">"webapps"</span>  </span></span><br><span class="line"><span class="tag">           <span class="attr">unpackWARs</span>=<span class="string">"true"</span> <span class="attr">autoDeploy</span>=<span class="string">"true"</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line">       <span class="comment">&lt;!-- SingleSignOn valve, share authentication between web applications  </span></span><br><span class="line"><span class="comment">            Documentation at: /docs/config/valve.html --&gt;</span>  </span><br><span class="line">       <span class="comment">&lt;!-- </span></span><br><span class="line"><span class="comment">       &lt;Valve className="org.apache.catalina.authenticator.SingleSignOn" /&gt; </span></span><br><span class="line"><span class="comment">       --&gt;</span>  </span><br><span class="line">  </span><br><span class="line">       <span class="comment">&lt;!-- Access log processes all example.  </span></span><br><span class="line"><span class="comment">            Documentation at: /docs/config/valve.html  </span></span><br><span class="line"><span class="comment">            <span class="doctag">Note:</span> The pattern used is equivalent to using pattern="common" --&gt;</span>  </span><br><span class="line">       <span class="tag">&lt;<span class="name">Valve</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.valves.AccessLogValve"</span> <span class="attr">directory</span>=<span class="string">"logs"</span>  </span></span><br><span class="line"><span class="tag">              <span class="attr">prefix</span>=<span class="string">"localhost_access_log"</span> <span class="attr">suffix</span>=<span class="string">".txt"</span>  </span></span><br><span class="line"><span class="tag">              <span class="attr">pattern</span>=<span class="string">"%h %l %u %t "</span>%<span class="attr">r</span>" %<span class="attr">s</span> %<span class="attr">b</span>" /&gt;</span>  </span><br><span class="line">       <span class="tag">&lt;<span class="name">Context</span> <span class="attr">path</span>=<span class="string">"/easyshare-web"</span> <span class="attr">reloadable</span>=<span class="string">"true"</span> <span class="attr">debug</span>=<span class="string">"0"</span> <span class="attr">docBase</span>=<span class="string">"D:\code\work\easyshare2017\easyshare-web\target\easyshare-web-1.0-SNAPSHOT"</span> <span class="attr">workDir</span>=<span class="string">"D:\code\work\easyshare2017\easyshare-web\target\easyshare-web-1.0-SNAPSHOT\work"</span> <span class="attr">crossContext</span>=<span class="string">"true"</span> &gt;</span>  </span><br><span class="line">       <span class="tag">&lt;/<span class="name">Context</span>&gt;</span>  </span><br><span class="line">     <span class="tag">&lt;/<span class="name">Host</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>在Host节点增加Context配置，path是我们访问项目时的contextPath，docBase设置为外部应用程序的绝对路径,workDir为jsp编译结果存放路径，这里是指为docBase/work<br>2) 编辑catalina-home/conf/web.xml（一般不需要这个步骤，如果第一步出现404再尝试开启）<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">servlet</span>&gt;</span>  </span><br><span class="line">       <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>default<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span>  </span><br><span class="line">       <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.apache.catalina.servlets.DefaultServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span>  </span><br><span class="line">       <span class="tag">&lt;<span class="name">init-param</span>&gt;</span>  </span><br><span class="line">           <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>debug<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span>  </span><br><span class="line">           <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>0<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span>  </span><br><span class="line">       <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span>  </span><br><span class="line">       <span class="tag">&lt;<span class="name">init-param</span>&gt;</span>  </span><br><span class="line">           <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>listings<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span>  </span><br><span class="line">           <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span>  </span><br><span class="line">       <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span>  </span><br><span class="line">       <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span>  </span><br><span class="line">   <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>这里将listings改为true，这个参数控制当访问的资源是物理目录时，是否列出该目录下的文件，为了安全默认是禁止的。</p>
<p>可见，如果在浏览器中输入的资源是一个目录，那么就会列出该目录下的文件，这样是不安全的，所以默认是禁止的。其代码在org.apache.catalina.servlets.DefaultServlet中实现：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (resource.isDirectory()) &#123;  </span><br><span class="line">           <span class="keyword">if</span> (!path.endsWith(<span class="string">"/"</span>)) &#123;  </span><br><span class="line">               doDirectoryRedirect(request, response);  </span><br><span class="line">               <span class="keyword">return</span>;  </span><br><span class="line">           &#125;  </span><br><span class="line">  </span><br><span class="line">           <span class="comment">// Skip directory listings if we have been configured to  </span></span><br><span class="line">           <span class="comment">// suppress them  </span></span><br><span class="line">           <span class="keyword">if</span> (!listings) &#123;  </span><br><span class="line">               response.sendError(HttpServletResponse.SC_NOT_FOUND,  </span><br><span class="line">                                  request.getRequestURI());  </span><br><span class="line">               <span class="keyword">return</span>;  </span><br><span class="line">           &#125;  </span><br><span class="line">           contentType = <span class="string">"text/html;charset=UTF-8"</span>;  </span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">           <span class="keyword">if</span> (!isError) &#123;  </span><br><span class="line">               <span class="keyword">if</span> (useAcceptRanges) &#123;  </span><br><span class="line">                   <span class="comment">// Accept ranges header  </span></span><br><span class="line">                   response.setHeader(<span class="string">"Accept-Ranges"</span>, <span class="string">"bytes"</span>);  </span><br><span class="line">               &#125;  </span><br><span class="line">  </span><br><span class="line">               <span class="comment">// Parse range specifier  </span></span><br><span class="line">               ranges = parseRange(request, response, resource);  </span><br><span class="line">  </span><br><span class="line">               <span class="comment">// ETag header  </span></span><br><span class="line">               response.setHeader(<span class="string">"ETag"</span>, eTag);  </span><br><span class="line">  </span><br><span class="line">               <span class="comment">// Last-Modified header  </span></span><br><span class="line">               response.setHeader(<span class="string">"Last-Modified"</span>, lastModifiedHttp);  </span><br><span class="line">           &#125;  </span><br><span class="line">  </span><br><span class="line">           <span class="comment">// Get content length  </span></span><br><span class="line">           contentLength = resource.getContentLength();  </span><br><span class="line">           <span class="comment">// Special case for zero length files, which would cause a  </span></span><br><span class="line">           <span class="comment">// (silent) ISE when setting the output buffer size  </span></span><br><span class="line">           <span class="keyword">if</span> (contentLength == <span class="number">0L</span>) &#123;  </span><br><span class="line">               serveContent = <span class="keyword">false</span>;  </span><br><span class="line">           &#125;  </span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure></p>
<p>当访问的资源是一个物理目录时，会根据listings的值来判断是否列出目录下的文件列表。</p>
<h2 id="end"><a href="#end" class="headerlink" title="end"></a>end</h2>]]></content>
      
        <categories>
            
            <category> 随笔 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> java </tag>
            
            <tag> tomcat </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[spring-data-jpa使用缓存的注意事项]]></title>
      <url>/2017/07/20/spring-data-jpa-cache/</url>
      <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>采用hibernate的JPA实现，对于简单的查询十分方便。而对于复杂查询我们也可以写SQL来进行复杂的多表连接查询。很多人不喜欢hibernate其实更多的是对其机制的掌握不深，如果认真研究其实现源码，其实是一个很快乐的学习过程。各种设计范式的运用也是精彩绝伦。</p>
<p>这里主要说下缓存的配置。既然是hibernate，其缓存机制离不开这三种：session级别的缓存、sessionFactory级别的二级缓存以及查询缓存和带有集合的缓存。对于jpa的使用，个人建议不要使用关系映射。这样会导致各种关联查询，涉及到延迟加载等机制，会消耗额外的cglib的大量代理工作。尤其是很多人还使用org.springframework.orm.jpa.support.OpenEntityManagerInViewFilter来实现集合的页面懒加载。这对http响应要求很高的系统简直就是灾难。</p>
<p>使用jpa要放弃hibernate的关系映射部分，保持开发的简洁和灵活性。</p>
<p>先上测试代码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.com.egova.easyshare.test.service;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> cn.com.egova.easyshare.common.dto.NavMenuDto;  </span><br><span class="line"><span class="keyword">import</span> cn.com.egova.easyshare.common.entity.Human;  </span><br><span class="line"><span class="keyword">import</span> cn.com.egova.easyshare.common.entity.NavMenu;  </span><br><span class="line"><span class="keyword">import</span> cn.com.egova.easyshare.server.service.IHumanService;  </span><br><span class="line"><span class="keyword">import</span> org.junit.Test;  </span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.ContextConfiguration;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringJUnit4ClassRunner;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> javax.persistence.EntityManager;  </span><br><span class="line"><span class="keyword">import</span> javax.persistence.EntityManagerFactory;  </span><br><span class="line"><span class="keyword">import</span> java.util.List;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@RunWith</span>(SpringJUnit4ClassRunner.class)  </span><br><span class="line"><span class="meta">@ContextConfiguration</span>(&#123;<span class="string">"classpath:/applicationContext.xml"</span>&#125;)  </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HumanServiceTest</span> </span>&#123;  </span><br><span class="line">    <span class="meta">@Autowired</span>  </span><br><span class="line">    <span class="keyword">private</span> IHumanService humanService;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Autowired</span>  </span><br><span class="line">    <span class="keyword">private</span> EntityManagerFactory entityManagerFactory;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//一级缓存：内建的session级别的缓存,默认开启  </span></span><br><span class="line">    <span class="meta">@Test</span>  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sessionCacheTest</span><span class="params">()</span></span>&#123;  </span><br><span class="line">        EntityManager entityManager = entityManagerFactory.createEntityManager();  </span><br><span class="line">  </span><br><span class="line">        Human human = entityManager.find(Human.class,<span class="number">37</span>);  </span><br><span class="line">        Human human1 = entityManager.find(Human.class,<span class="number">37</span>);  </span><br><span class="line">        System.out.println(human == human1?<span class="string">"true"</span>:<span class="string">"false"</span>);  </span><br><span class="line">        entityManager.close();  </span><br><span class="line">  </span><br><span class="line">        entityManager = entityManagerFactory.createEntityManager();  </span><br><span class="line">  </span><br><span class="line">        Human human3 = entityManager.find(Human.class,<span class="number">37</span>);  </span><br><span class="line">        System.out.println(human == human3?<span class="string">"true"</span>:<span class="string">"false"</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//二级缓存，同一个sessionFactory的不同session缓存，默认关闭  </span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sessionFactoryCacheTest</span><span class="params">()</span></span>&#123;  </span><br><span class="line">        EntityManager entityManager = entityManagerFactory.createEntityManager();  </span><br><span class="line">  </span><br><span class="line">        NavMenu navMenu = entityManager.find(NavMenu.class,<span class="number">1</span>);  </span><br><span class="line">        entityManager.close();  </span><br><span class="line">  </span><br><span class="line">        entityManager = entityManagerFactory.createEntityManager();  </span><br><span class="line">        NavMenu navMenu2 = entityManager.find(NavMenu.class,<span class="number">1</span>);  </span><br><span class="line">        entityManager.close();  </span><br><span class="line">  </span><br><span class="line">        System.out.println(navMenu == navMenu2?<span class="string">"true"</span>:<span class="string">"false"</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//查询缓存，前两种都是根据主键ID的缓存策略.  </span></span><br><span class="line">    <span class="meta">@Test</span>  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">queryCacheTest</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;  </span><br><span class="line">        List&lt;NavMenuDto&gt; navMenuDtos = humanService.getMenuList(<span class="number">37</span>);  </span><br><span class="line">        List&lt;NavMenuDto&gt; navMenuDtos2 = humanService.getMenuList(<span class="number">37</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="一级缓存"><a href="#一级缓存" class="headerlink" title="一级缓存"></a>一级缓存</h2><p>也就是自建的session级别的缓存，在一个session回话事物中根据主键查询是只会查询一次数据库的。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">EntityManager entityManager = entityManagerFactory.createEntityManager();  </span><br><span class="line">Human human = entityManager.find(Human.class,<span class="number">37</span>);  </span><br><span class="line">Human human1 = entityManager.find(Human.class,<span class="number">37</span>);  </span><br><span class="line">System.out.println(human == human1?<span class="string">"true"</span>:<span class="string">"false"</span>);  </span><br><span class="line">entityManager.close();  </span><br><span class="line">entityManager = entityManagerFactory.createEntityManager();  </span><br><span class="line">Human human3 = entityManager.find(Human.class,<span class="number">37</span>);  </span><br><span class="line"> System.out.println(human == human3?<span class="string">"true"</span>:<span class="string">"false"</span>);</span><br></pre></td></tr></table></figure></p>
<p>控制台打印：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">Hibernate:   </span><br><span class="line">    <span class="keyword">select</span>  </span><br><span class="line">        human0_.humanID <span class="keyword">as</span> humanID1_11_0_,  </span><br><span class="line">        human0_.activeFlag <span class="keyword">as</span> activeFlag2_11_0_,  </span><br><span class="line">        human0_.address <span class="keyword">as</span> address3_11_0_,  </span><br><span class="line">        human0_.createDate <span class="keyword">as</span> createDate4_11_0_,  </span><br><span class="line">        human0_.description <span class="keyword">as</span> description5_11_0_,  </span><br><span class="line">        human0_.displayOrder <span class="keyword">as</span> displayOrder6_11_0_,  </span><br><span class="line">        human0_.email <span class="keyword">as</span> email7_11_0_,  </span><br><span class="line">        human0_.humanCode <span class="keyword">as</span> humanCode8_11_0_,  </span><br><span class="line">        human0_.humanName <span class="keyword">as</span> humanName9_11_0_,  </span><br><span class="line">        human0_.humanPassword <span class="keyword">as</span> humanPassword10_11_0_,  </span><br><span class="line">        human0_.identifyType <span class="keyword">as</span> identifyType11_11_0_,  </span><br><span class="line">        human0_.orgId <span class="keyword">as</span> orgId12_11_0_,  </span><br><span class="line">        human0_.tel <span class="keyword">as</span> tel13_11_0_,  </span><br><span class="line">        human0_.unitID <span class="keyword">as</span> unitID14_11_0_,  </span><br><span class="line">        human0_.userid <span class="keyword">as</span> userid15_11_0_,  </span><br><span class="line">        human0_.userroles <span class="keyword">as</span> userroles16_11_0_,  </span><br><span class="line">        human0_.zipCode <span class="keyword">as</span> zipCode17_11_0_   </span><br><span class="line">    <span class="keyword">from</span>  </span><br><span class="line">        tcHuman human0_   </span><br><span class="line">    <span class="keyword">where</span>  </span><br><span class="line">        human0_.humanID=?  </span><br><span class="line"><span class="literal">true</span>  </span><br><span class="line"><span class="number">2017</span><span class="number">-07</span><span class="number">-20</span> <span class="number">14</span>:<span class="number">24</span>:<span class="number">30</span> INFO <span class="keyword">main</span> org.hibernate.engine.internal.StatisticalLoggingSessionEventListener - <span class="keyword">Session</span> Metrics &#123;  </span><br><span class="line">    <span class="number">399787</span> nanoseconds spent acquiring <span class="number">1</span> JDBC connections;  </span><br><span class="line">    0 nanoseconds spent releasing 0 JDBC connections;  </span><br><span class="line">    114082560 nanoseconds spent preparing 1 JDBC statements;  </span><br><span class="line">    2907307 nanoseconds spent executing 1 JDBC statements;  </span><br><span class="line">    0 nanoseconds spent executing 0 JDBC batches;  </span><br><span class="line">    0 nanoseconds spent performing 0 L2C puts;  </span><br><span class="line">    0 nanoseconds spent performing 0 L2C hits;  </span><br><span class="line">    0 nanoseconds spent performing 0 L2C misses;  </span><br><span class="line">    0 nanoseconds spent executing 0 flushes (flushing a total of 0 entities and 0 collections);  </span><br><span class="line">    0 nanoseconds spent executing 0 partial-flushes (flushing a total of 0 entities and 0 collections)  </span><br><span class="line">&#125;  </span><br><span class="line">Hibernate:   </span><br><span class="line">    <span class="keyword">select</span>  </span><br><span class="line">        human0_.humanID <span class="keyword">as</span> humanID1_11_0_,  </span><br><span class="line">        human0_.activeFlag <span class="keyword">as</span> activeFlag2_11_0_,  </span><br><span class="line">        human0_.address <span class="keyword">as</span> address3_11_0_,  </span><br><span class="line">        human0_.createDate <span class="keyword">as</span> createDate4_11_0_,  </span><br><span class="line">        human0_.description <span class="keyword">as</span> description5_11_0_,  </span><br><span class="line">        human0_.displayOrder <span class="keyword">as</span> displayOrder6_11_0_,  </span><br><span class="line">        human0_.email <span class="keyword">as</span> email7_11_0_,  </span><br><span class="line">        human0_.humanCode <span class="keyword">as</span> humanCode8_11_0_,  </span><br><span class="line">        human0_.humanName <span class="keyword">as</span> humanName9_11_0_,  </span><br><span class="line">        human0_.humanPassword <span class="keyword">as</span> humanPassword10_11_0_,  </span><br><span class="line">        human0_.identifyType <span class="keyword">as</span> identifyType11_11_0_,  </span><br><span class="line">        human0_.orgId <span class="keyword">as</span> orgId12_11_0_,  </span><br><span class="line">        human0_.tel <span class="keyword">as</span> tel13_11_0_,  </span><br><span class="line">        human0_.unitID <span class="keyword">as</span> unitID14_11_0_,  </span><br><span class="line">        human0_.userid <span class="keyword">as</span> userid15_11_0_,  </span><br><span class="line">        human0_.userroles <span class="keyword">as</span> userroles16_11_0_,  </span><br><span class="line">        human0_.zipCode <span class="keyword">as</span> zipCode17_11_0_   </span><br><span class="line">    <span class="keyword">from</span>  </span><br><span class="line">        tcHuman human0_   </span><br><span class="line">    <span class="keyword">where</span>  </span><br><span class="line">        human0_.humanID=?  </span><br><span class="line"><span class="literal">false</span></span><br></pre></td></tr></table></figure></p>
<p>执行<code>entityManager.close();</code>entityManager关闭后会重新执行一次sql查询</p>
<h2 id="二级缓存"><a href="#二级缓存" class="headerlink" title="二级缓存"></a>二级缓存</h2><p>二级缓存默认是关闭的，需要配置缓存策略<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;  </span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span>  </span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span>  </span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span>  </span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:aop</span>=<span class="string">"http://www.springframework.org/schema/aop"</span>  </span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:tx</span>=<span class="string">"http://www.springframework.org/schema/tx"</span>  </span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:p</span>=<span class="string">"http://www.springframework.org/schema/p"</span>  </span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:cache</span>=<span class="string">"http://www.springframework.org/schema/cache"</span>  </span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:jpa</span>=<span class="string">"http://www.springframework.org/schema/data/jpa"</span>  </span></span><br><span class="line"><span class="tag">  </span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans  </span></span></span><br><span class="line"><span class="tag"><span class="string">         http://www.springframework.org/schema/beans/spring-beans-2.5.xsd  </span></span></span><br><span class="line"><span class="tag"><span class="string">          http://www.springframework.org/schema/context  </span></span></span><br><span class="line"><span class="tag"><span class="string">          http://www.springframework.org/schema/context/spring-context-3.1.xsd  </span></span></span><br><span class="line"><span class="tag"><span class="string">          http://www.springframework.org/schema/aop  </span></span></span><br><span class="line"><span class="tag"><span class="string">          http://www.springframework.org/schema/aop/spring-aop-3.1.xsd  </span></span></span><br><span class="line"><span class="tag"><span class="string">          http://www.springframework.org/schema/tx  </span></span></span><br><span class="line"><span class="tag"><span class="string">          http://www.springframework.org/schema/tx/spring-tx-3.1.xsd  </span></span></span><br><span class="line"><span class="tag"><span class="string">          http://www.springframework.org/schema/cache  </span></span></span><br><span class="line"><span class="tag"><span class="string">          http://www.springframework.org/schema/cache/spring-cache-3.1.xsd  </span></span></span><br><span class="line"><span class="tag"><span class="string">          http://www.springframework.org/schema/data/jpa  </span></span></span><br><span class="line"><span class="tag"><span class="string">          http://www.springframework.org/schema/data/jpa/spring-jpa.xsd"</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="tag">&lt;<span class="name">context:annotation-config</span> /&gt;</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"cn.com.egova.easyshare"</span>/&gt;</span>  </span><br><span class="line">    <span class="comment">&lt;!--配置文件读取--&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"propertyConfigurer"</span> <span class="attr">class</span>=<span class="string">"org.springframework.beans.factory.config.PropertyPlaceholderConfigurer"</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"locations"</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">list</span>&gt;</span>  </span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>classpath:config.properties<span class="tag">&lt;/<span class="name">value</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;/<span class="name">list</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"springContextUtil"</span> <span class="attr">class</span>=<span class="string">"cn.com.egova.easyshare.common.utils.SpringContextUtil"</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"dataSource"</span> <span class="attr">class</span>=<span class="string">"org.apache.commons.dbcp2.BasicDataSource"</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driverClassName"</span> <span class="attr">value</span>=<span class="string">"$&#123;db.driverClassName&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"$&#123;db.url&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"$&#123;db.username&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"$&#123;db.password&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxTotal"</span> <span class="attr">value</span>=<span class="string">"$&#123;db.maxTotal&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxIdle"</span> <span class="attr">value</span>=<span class="string">"$&#123;db.maxIdle&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"entityManagerFactory"</span>  </span></span><br><span class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">"org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean"</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span> /&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jpaVendorAdapter"</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter"</span>&gt;</span>  </span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"generateDdl"</span> <span class="attr">value</span>=<span class="string">"false"</span> /&gt;</span>  </span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"database"</span> <span class="attr">value</span>=<span class="string">"ORACLE"</span> /&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;/<span class="name">bean</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span>  </span><br><span class="line">        <span class="comment">&lt;!-- 指定Entity实体类包路径 --&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"packagesToScan"</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>cn.com.egova.easyshare.common.entity<span class="tag">&lt;/<span class="name">value</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span>  </span><br><span class="line">        <span class="comment">&lt;!-- 指定JPA属性；如Hibernate中指定是否显示SQL的是否显示、方言等 --&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jpaProperties"</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">props</span>&gt;</span>  </span><br><span class="line">                <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"hibernate.dialect"</span>&gt;</span>org.hibernate.dialect.Oracle9iDialect<span class="tag">&lt;/<span class="name">prop</span>&gt;</span>  </span><br><span class="line">                <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"hibernate.show_sql"</span>&gt;</span>true<span class="tag">&lt;/<span class="name">prop</span>&gt;</span>  </span><br><span class="line">                <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"hibernate.format_sql"</span>&gt;</span>true<span class="tag">&lt;/<span class="name">prop</span>&gt;</span>  </span><br><span class="line">                <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"hibernate.generate_statistics"</span>&gt;</span>true<span class="tag">&lt;/<span class="name">prop</span>&gt;</span>  </span><br><span class="line">                <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"hibernate.hbm2ddl.auto"</span>&gt;</span>none<span class="tag">&lt;/<span class="name">prop</span>&gt;</span>  </span><br><span class="line">                <span class="comment">&lt;!-- 配置二级缓存 --&gt;</span>  </span><br><span class="line">                <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"hibernate.cache.use_second_level_cache"</span>&gt;</span>true<span class="tag">&lt;/<span class="name">prop</span>&gt;</span>  </span><br><span class="line">                <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"hibernate.cache.region.factory_class"</span>&gt;</span>org.hibernate.cache.ehcache.EhCacheRegionFactory<span class="tag">&lt;/<span class="name">prop</span>&gt;</span>  </span><br><span class="line">                <span class="comment">&lt;!-- 开启查询缓存 --&gt;</span>  </span><br><span class="line">                <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"hibernate.cache.use_query_cache"</span>&gt;</span>true<span class="tag">&lt;/<span class="name">prop</span>&gt;</span>  </span><br><span class="line">                <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"hibernate.cache.provider_configuration"</span>&gt;</span>classpath:ehcache.xml<span class="tag">&lt;/<span class="name">prop</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;/<span class="name">props</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">&lt;!-- 配置事务管理器 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"transactionManager"</span> <span class="attr">class</span>=<span class="string">"org.springframework.orm.jpa.JpaTransactionManager"</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"entityManagerFactory"</span> <span class="attr">ref</span>=<span class="string">"entityManagerFactory"</span> /&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">&lt;!-- 启用 annotation事务--&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">tx:annotation-driven</span> <span class="attr">transaction-manager</span>=<span class="string">"transactionManager"</span>/&gt;</span>  </span><br><span class="line">      </span><br><span class="line">      </span><br><span class="line">    <span class="comment">&lt;!-- 采用JdbcTemplate配置 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"jdbcTemplate"</span>  <span class="attr">class</span>=<span class="string">"org.springframework.jdbc.core.JdbcTemplate"</span>&gt;</span>    </span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span> /&gt;</span>    </span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span>  </span><br><span class="line">      </span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"lobHandler"</span>  <span class="attr">class</span>=<span class="string">"org.springframework.jdbc.support.lob.OracleLobHandler"</span>&gt;</span>    </span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span>  </span><br><span class="line">      </span><br><span class="line">    <span class="comment">&lt;!-- 通过aop配置事务 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"txManager"</span> <span class="attr">class</span>=<span class="string">"org.springframework.jdbc.datasource.DataSourceTransactionManager"</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span>/&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span>  </span><br><span class="line">      </span><br><span class="line">  </span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:aspectj-autoproxy</span>/&gt;</span>  </span><br><span class="line">    <span class="comment">&lt;!-- 配置Spring Data JPA扫描目录--&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">jpa:repositories</span> <span class="attr">base-package</span>=<span class="string">"cn.com.egova.easyshare.server.repository"</span>/&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>然后在需要使用缓存的entity配置好缓存注解<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.com.egova.easyshare.common.entity;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> org.hibernate.annotations.Cache;  </span><br><span class="line"><span class="keyword">import</span> org.hibernate.annotations.CacheConcurrencyStrategy;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> javax.persistence.*;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * 系统菜单 </span></span><br><span class="line"><span class="comment"> * Created by gongxufan on 2017/3/13. </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="meta">@Entity</span>  </span><br><span class="line"><span class="meta">@Table</span>(name = <span class="string">"TCSYSNAVMENU"</span>)  </span><br><span class="line"><span class="meta">@Cache</span>(usage = CacheConcurrencyStrategy.READ_ONLY)  </span><br><span class="line"><span class="meta">@Cacheable</span>(<span class="keyword">true</span>)  </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NavMenu</span> </span>&#123;  </span><br><span class="line">    <span class="meta">@Id</span>  </span><br><span class="line">    <span class="meta">@GeneratedValue</span>(strategy = GenerationType.TABLE, generator = <span class="string">"tableKeyGenerator"</span>)  </span><br><span class="line">    <span class="meta">@TableGenerator</span>(name = <span class="string">"tableKeyGenerator"</span>, table = <span class="string">"tcTableKeyGenerator"</span>,  </span><br><span class="line">            pkColumnName = <span class="string">"pk_key"</span>, valueColumnName = <span class="string">"pk_value"</span>, pkColumnValue = <span class="string">"menuID"</span>,  </span><br><span class="line">            initialValue = <span class="number">1</span>, allocationSize = <span class="number">1</span>)  </span><br><span class="line">    <span class="keyword">private</span> Integer menuID;  </span><br><span class="line">    <span class="keyword">private</span> Integer seniorMenuID;  </span><br><span class="line">    <span class="keyword">private</span> String menuName;  </span><br><span class="line">    <span class="keyword">private</span> String menuDescr;  </span><br><span class="line">    <span class="keyword">private</span> String menuIconClass;  </span><br><span class="line">    <span class="keyword">private</span> String hrefUrl;  </span><br><span class="line">    <span class="keyword">private</span> Integer displayOrder;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getMenuID</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> menuID;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMenuID</span><span class="params">(Integer menuID)</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">this</span>.menuID = menuID;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getSeniorMenuID</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> seniorMenuID;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSeniorMenuID</span><span class="params">(Integer seniorMenuID)</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">this</span>.seniorMenuID = seniorMenuID;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getMenuName</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> menuName;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMenuName</span><span class="params">(String menuName)</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">this</span>.menuName = menuName;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getMenuDescr</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> menuDescr;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMenuDescr</span><span class="params">(String menuDescr)</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">this</span>.menuDescr = menuDescr;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getMenuIconClass</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> menuIconClass;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMenuIconClass</span><span class="params">(String menuIconClass)</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">this</span>.menuIconClass = menuIconClass;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getHrefUrl</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> hrefUrl;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setHrefUrl</span><span class="params">(String hrefUrl)</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">this</span>.hrefUrl = hrefUrl;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getDisplayOrder</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> displayOrder;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDisplayOrder</span><span class="params">(Integer displayOrder)</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">this</span>.displayOrder = displayOrder;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>当然还要配置好ehcache.xml<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;  </span><br><span class="line"><span class="tag">&lt;<span class="name">ehcache</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span>  </span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:noNamespaceSchemaLocation</span>=<span class="string">"http://ehcache.org/ehcache.xsd"</span>  </span></span><br><span class="line"><span class="tag">         <span class="attr">updateCheck</span>=<span class="string">"false"</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">&lt;!-- Sets the path to the directory where cache .data files are created.  </span></span><br><span class="line"><span class="comment">  </span></span><br><span class="line"><span class="comment">         If the path is a Java System Property it is replaced by  </span></span><br><span class="line"><span class="comment">         its value in the running VM.  </span></span><br><span class="line"><span class="comment">  </span></span><br><span class="line"><span class="comment">         The following properties are translated:  </span></span><br><span class="line"><span class="comment">         user.home - User's home directory  </span></span><br><span class="line"><span class="comment">         user.dir - User's current working directory  </span></span><br><span class="line"><span class="comment">         java.io.tmpdir - Default temp file path --&gt;</span>  </span><br><span class="line">    <span class="comment">&lt;!-- 缓存写入文件目录 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">diskStore</span> <span class="attr">path</span>=<span class="string">"user.home"</span>/&gt;</span>  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">&lt;!--Default Cache configuration. These will applied to caches programmatically created through  </span></span><br><span class="line"><span class="comment">        the CacheManager.  </span></span><br><span class="line"><span class="comment">  </span></span><br><span class="line"><span class="comment">        The following attributes are required for defaultCache:  </span></span><br><span class="line"><span class="comment">  </span></span><br><span class="line"><span class="comment">        maxInMemory       - Sets the maximum number of objects that will be created in memory  </span></span><br><span class="line"><span class="comment">        eternal           - Sets whether elements are eternal. If eternal,  timeouts are ignored and the element  </span></span><br><span class="line"><span class="comment">                            is never expired.  </span></span><br><span class="line"><span class="comment">        timeToIdleSeconds - Sets the time to idle for an element before it expires. Is only used  </span></span><br><span class="line"><span class="comment">                            if the element is not eternal. Idle time is now - last accessed time  </span></span><br><span class="line"><span class="comment">        timeToLiveSeconds - Sets the time to live for an element before it expires. Is only used  </span></span><br><span class="line"><span class="comment">                            if the element is not eternal. TTL is now - creation time  </span></span><br><span class="line"><span class="comment">        overflowToDisk    - Sets whether elements can overflow to disk when the in-memory cache  </span></span><br><span class="line"><span class="comment">                            has reached the maxInMemory limit.  </span></span><br><span class="line"><span class="comment">  </span></span><br><span class="line"><span class="comment">        --&gt;</span>  </span><br><span class="line">    <span class="comment">&lt;!-- 数据过期策略 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">defaultCache</span>  </span></span><br><span class="line"><span class="tag">            <span class="attr">maxElementsInMemory</span>=<span class="string">"10000"</span>  </span></span><br><span class="line"><span class="tag">            <span class="attr">eternal</span>=<span class="string">"false"</span>  </span></span><br><span class="line"><span class="tag">            <span class="attr">timeToIdleSeconds</span>=<span class="string">"120"</span>  </span></span><br><span class="line"><span class="tag">            <span class="attr">timeToLiveSeconds</span>=<span class="string">"120"</span>  </span></span><br><span class="line"><span class="tag">            <span class="attr">overflowToDisk</span>=<span class="string">"true"</span>  </span></span><br><span class="line"><span class="tag">    /&gt;</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">&lt;!--Predefined caches.  Add your cache configuration settings here.  </span></span><br><span class="line"><span class="comment">        If you do not have a configuration for your cache a WARNING will be issued when the  </span></span><br><span class="line"><span class="comment">        CacheManager starts  </span></span><br><span class="line"><span class="comment">  </span></span><br><span class="line"><span class="comment">        The following attributes are required for defaultCache:  </span></span><br><span class="line"><span class="comment">  </span></span><br><span class="line"><span class="comment">        name              - Sets the name of the cache. This is used to identify the cache. It must be unique.  </span></span><br><span class="line"><span class="comment">        maxInMemory       - Sets the maximum number of objects that will be created in memory  </span></span><br><span class="line"><span class="comment">        eternal           - Sets whether elements are eternal. If eternal,  timeouts are ignored and the element  </span></span><br><span class="line"><span class="comment">                            is never expired.  </span></span><br><span class="line"><span class="comment">        timeToIdleSeconds - Sets the time to idle for an element before it expires. Is only used  </span></span><br><span class="line"><span class="comment">                            if the element is not eternal. Idle time is now - last accessed time  </span></span><br><span class="line"><span class="comment">        timeToLiveSeconds - Sets the time to live for an element before it expires. Is only used  </span></span><br><span class="line"><span class="comment">                            if the element is not eternal. TTL is now - creation time  </span></span><br><span class="line"><span class="comment">        overflowToDisk    - Sets whether elements can overflow to disk when the in-memory cache  </span></span><br><span class="line"><span class="comment">                            has reached the maxInMemory limit.  </span></span><br><span class="line"><span class="comment">  </span></span><br><span class="line"><span class="comment">        --&gt;</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">&lt;!-- Sample cache named sampleCache1  </span></span><br><span class="line"><span class="comment">        This cache contains a maximum in memory of 10000 elements, and will expire  </span></span><br><span class="line"><span class="comment">        an element if it is idle for more than 5 minutes and lives for more than  </span></span><br><span class="line"><span class="comment">        10 minutes.  </span></span><br><span class="line"><span class="comment">  </span></span><br><span class="line"><span class="comment">        If there are more than 10000 elements it will overflow to the  </span></span><br><span class="line"><span class="comment">        disk cache, which in this configuration will go to wherever java.io.tmp is  </span></span><br><span class="line"><span class="comment">        defined on your system. On a standard Linux system this will be /tmp"  </span></span><br><span class="line"><span class="comment">        --&gt;</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">&lt;!-- Sample cache named sampleCache2  </span></span><br><span class="line"><span class="comment">        This cache contains 1000 elements. Elements will always be held in memory.  </span></span><br><span class="line"><span class="comment">        They are not expired. --&gt;</span>  </span><br><span class="line">    <span class="comment">&lt;!-- &lt;cache name="sampleCache2"  </span></span><br><span class="line"><span class="comment">        maxElementsInMemory="1000"  </span></span><br><span class="line"><span class="comment">        eternal="true"  </span></span><br><span class="line"><span class="comment">        timeToIdleSeconds="0"  </span></span><br><span class="line"><span class="comment">        timeToLiveSeconds="0"  </span></span><br><span class="line"><span class="comment">        overflowToDisk="false"  </span></span><br><span class="line"><span class="comment">        /&gt;  --&gt;</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">&lt;!-- Place configuration for your caches following --&gt;</span>  </span><br><span class="line">  </span><br><span class="line"><span class="tag">&lt;/<span class="name">ehcache</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>运行测试代码会发现两次执行只有一次sql查询</p>
<h2 id="查询缓存"><a href="#查询缓存" class="headerlink" title="查询缓存"></a>查询缓存</h2><p>前两种都是对主键查询时候的缓存，对于普通的sql查询我们可以在repository中配置hints<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.com.egova.easyshare.server.repository;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> cn.com.egova.easyshare.common.entity.Human;  </span><br><span class="line"><span class="keyword">import</span> cn.com.egova.easyshare.common.entity.NavMenu;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.data.jpa.repository.Query;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.data.jpa.repository.QueryHints;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.data.repository.PagingAndSortingRepository;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.data.repository.query.Param;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> javax.persistence.QueryHint;  </span><br><span class="line"><span class="keyword">import</span> java.util.List;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * Created by gongxufan on 2017/3/13. </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SysNavRepository</span> <span class="keyword">extends</span> <span class="title">PagingAndSortingRepository</span>&lt;<span class="title">NavMenu</span>, <span class="title">Integer</span>&gt; </span>&#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Query</span>(<span class="string">"select n from NavMenu n where exists (select 1 from SysNavRight s "</span> +  </span><br><span class="line">            <span class="string">"where n.menuID=s.sysNavMenuID and s.humanID=:humanId) order by n.displayOrder"</span>)  </span><br><span class="line">    <span class="meta">@QueryHints</span>(&#123; <span class="meta">@QueryHint</span>(name = <span class="string">"org.hibernate.cacheable"</span>, value =<span class="string">"true"</span>) &#125;)  </span><br><span class="line">    <span class="function">List&lt;NavMenu&gt; <span class="title">findMenuList</span><span class="params">(@Param(<span class="string">"humanId"</span>)</span> Integer humanId)</span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Query</span>(<span class="string">"select m from NavMenu  m  order by m.displayOrder"</span>)  </span><br><span class="line">    <span class="function">List&lt;NavMenu&gt; <span class="title">findAllMenuList</span><span class="params">()</span></span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>运行测试代码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Test</span>  </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">queryCacheTest</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;  </span><br><span class="line">    List&lt;NavMenuDto&gt; navMenuDtos = humanService.getMenuList(<span class="number">37</span>);  </span><br><span class="line">    List&lt;NavMenuDto&gt; navMenuDtos2 = humanService.getMenuList(<span class="number">37</span>);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>控制台输出<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">Hibernate:   </span><br><span class="line">    <span class="keyword">select</span>  </span><br><span class="line">        navmenu0_.menuID <span class="keyword">as</span> menuID1_4_,  </span><br><span class="line">        navmenu0_.displayOrder <span class="keyword">as</span> displayOrder2_4_,  </span><br><span class="line">        navmenu0_.hrefUrl <span class="keyword">as</span> hrefUrl3_4_,  </span><br><span class="line">        navmenu0_.menuDescr <span class="keyword">as</span> menuDescr4_4_,  </span><br><span class="line">        navmenu0_.menuIconClass <span class="keyword">as</span> menuIconClass5_4_,  </span><br><span class="line">        navmenu0_.menuName <span class="keyword">as</span> menuName6_4_,  </span><br><span class="line">        navmenu0_.seniorMenuID <span class="keyword">as</span> seniorMenuID7_4_   </span><br><span class="line">    <span class="keyword">from</span>  </span><br><span class="line">        TCSYSNAVMENU navmenu0_   </span><br><span class="line">    <span class="keyword">where</span>  </span><br><span class="line">        <span class="keyword">exists</span> (  </span><br><span class="line">            <span class="keyword">select</span>  </span><br><span class="line">                <span class="number">1</span>   </span><br><span class="line">            <span class="keyword">from</span>  </span><br><span class="line">                TCHUMANSYSRIGHTS sysnavrigh1_   </span><br><span class="line">            <span class="keyword">where</span>  </span><br><span class="line">                navmenu0_.menuID=sysnavrigh1_.sysNavMenuID   </span><br><span class="line">                <span class="keyword">and</span> sysnavrigh1_.humanID=?  </span><br><span class="line">        )   </span><br><span class="line">    <span class="keyword">order</span> <span class="keyword">by</span>  </span><br><span class="line">        navmenu0_.displayOrder  </span><br><span class="line"><span class="number">2017</span><span class="number">-07</span><span class="number">-20</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">13</span> INFO <span class="keyword">main</span> org.hibernate.engine.internal.StatisticalLoggingSessionEventListener - <span class="keyword">Session</span> Metrics &#123;  </span><br><span class="line">    <span class="number">445013</span> nanoseconds spent acquiring <span class="number">1</span> JDBC connections;  </span><br><span class="line">    0 nanoseconds spent releasing 0 JDBC connections;  </span><br><span class="line">    179244800 nanoseconds spent preparing 1 JDBC statements;  </span><br><span class="line">    15228160 nanoseconds spent executing 1 JDBC statements;  </span><br><span class="line">    0 nanoseconds spent executing 0 JDBC batches;  </span><br><span class="line">    20012371 nanoseconds spent performing 39 L2C puts;  </span><br><span class="line">    0 nanoseconds spent performing 0 L2C hits;  </span><br><span class="line">    145920 nanoseconds spent performing 1 L2C misses;  </span><br><span class="line">    0 nanoseconds spent executing 0 flushes (flushing a total of 0 entities and 0 collections);  </span><br><span class="line">    0 nanoseconds spent executing 0 partial-flushes (flushing a total of 0 entities and 0 collections)  </span><br><span class="line">&#125;  </span><br><span class="line">2017-07-20 14:32:13 INFO main org.hibernate.engine.internal.StatisticalLoggingSessionEventListener - Session Metrics &#123;  </span><br><span class="line">    0 nanoseconds spent acquiring 0 JDBC connections;  </span><br><span class="line">    0 nanoseconds spent releasing 0 JDBC connections;  </span><br><span class="line">    0 nanoseconds spent preparing 0 JDBC statements;  </span><br><span class="line">    0 nanoseconds spent executing 0 JDBC statements;  </span><br><span class="line">    0 nanoseconds spent executing 0 JDBC batches;  </span><br><span class="line">    0 nanoseconds spent performing 0 L2C puts;  </span><br><span class="line">    1620055 nanoseconds spent performing 39 L2C hits;  </span><br><span class="line">    36694 nanoseconds spent performing 2 L2C misses;  </span><br><span class="line">    0 nanoseconds spent executing 0 flushes (flushing a total of 0 entities and 0 collections);  </span><br><span class="line">    0 nanoseconds spent executing 0 partial-flushes (flushing a total of 0 entities and 0 collections)  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这可以看到第二次执行同样的查询会有L2C缓存命中</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>如何配置二级缓存和注意事项</p>
<ol>
<li>首先需要添加pom依赖<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.data<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-data-jpa<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-data-jpa.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.hibernate<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hibernate-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;hibernate.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.hibernate<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hibernate-ehcache<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;hibernate.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>一定要注意ehcache和hibernate的版本要一致，不然启动会报错。</p>
<ol>
<li>修改jpa配置<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"hibernate.generate_statistics"</span>&gt;</span>true<span class="tag">&lt;/<span class="name">prop</span>&gt;</span>  </span><br><span class="line"><span class="comment">&lt;!-- 配置二级缓存 --&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"hibernate.cache.use_second_level_cache"</span>&gt;</span>true<span class="tag">&lt;/<span class="name">prop</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"hibernate.cache.region.factory_class"</span>&gt;</span>org.hibernate.cache.ehcache.EhCacheRegionFactory<span class="tag">&lt;/<span class="name">prop</span>&gt;</span>  </span><br><span class="line"><span class="comment">&lt;!-- 开启查询缓存 --&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"hibernate.cache.use_query_cache"</span>&gt;</span>true<span class="tag">&lt;/<span class="name">prop</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"hibernate.cache.provider_configuration"</span>&gt;</span>classpath:ehcache.xml<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>这里开启了二级缓存和查询缓存，指定了ehcache缓存的配置文件statistics是个调试开关，可以查询缓存的命中情况</p>
<ol>
<li>ehcache.xml配置<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">defaultCache</span>  </span></span><br><span class="line"><span class="tag">           <span class="attr">maxElementsInMemory</span>=<span class="string">"10000"</span>  </span></span><br><span class="line"><span class="tag">           <span class="attr">eternal</span>=<span class="string">"false"</span>  </span></span><br><span class="line"><span class="tag">           <span class="attr">timeToIdleSeconds</span>=<span class="string">"120"</span>  </span></span><br><span class="line"><span class="tag">           <span class="attr">timeToLiveSeconds</span>=<span class="string">"120"</span>  </span></span><br><span class="line"><span class="tag">           <span class="attr">overflowToDisk</span>=<span class="string">"true"</span>  </span></span><br><span class="line"><span class="tag">   /&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><code>timeToIdleSeconds</code><br>这个是缓存的最大空闲时间，也就是多久不访问自动失效<br><code>timeToLiveSeconds</code><br>这个是最大存活时间，如果在存活时间内空闲时间达到上限，缓存也会自动失效。<br>4)给entity配置缓存策略<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Cache</span>(usage = CacheConcurrencyStrategy.READ_ONLY)  </span><br><span class="line"><span class="meta">@Cacheable</span>(<span class="keyword">true</span>)</span><br></pre></td></tr></table></figure></p>
<p>cacheable主要对集合类的缓存提供支持，缓存策略这里适合数据更新不多的情况进行设置。</p>
<h2 id="end"><a href="#end" class="headerlink" title="end"></a>end</h2><p>使用二级缓存和查询缓存要注意使用场景，如果发现增加缓存机制系统反而出现吞吐下降频发宕机。就要考虑是不是该换memcache等专门的缓存服务器了。</p>
]]></content>
      
        <categories>
            
            <category> 随笔 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> java </tag>
            
            <tag> spring </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[使用commons-net进行ftp下载的注意事项]]></title>
      <url>/2017/07/11/commons-ftp/</url>
      <content type="html"><![CDATA[<p>简单实现ftp递归下载，直接上代码。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.com.egova.easyshare.common.utils;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> org.apache.commons.net.ftp.FTP;  </span><br><span class="line"><span class="keyword">import</span> org.apache.commons.net.ftp.FTPClient;  </span><br><span class="line"><span class="keyword">import</span> org.apache.commons.net.ftp.FTPFile;  </span><br><span class="line"><span class="keyword">import</span> org.apache.commons.net.ftp.FTPReply;  </span><br><span class="line"><span class="keyword">import</span> org.apache.log4j.Logger;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> java.io.File;  </span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;  </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line"><span class="keyword">import</span> java.net.SocketException;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * 使用apache的commons-net下载ftp文件或者文件夹到本地 </span></span><br><span class="line"><span class="comment"> * 一定要注意中文路径或者哟中文的文件，在执行ftp命令的时候要转换FTP协议的规定编码 </span></span><br><span class="line"><span class="comment"> * Created by gxf on 17-6-12. </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FtpUtil</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">private</span> String username;  </span><br><span class="line">    <span class="keyword">private</span> String password;  </span><br><span class="line">    <span class="keyword">private</span> String ftpHostName;  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> port = <span class="number">21</span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> FTPClient ftpClient = <span class="keyword">new</span> FTPClient();  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Logger logger = Logger.getLogger(FtpUtil.class);  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> FtpUtil instance;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * 本地字符编码 </span></span><br><span class="line"><span class="comment">     */</span>  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String LOCAL_CHARSET = <span class="string">"GBK"</span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// FTP协议里面，规定文件名编码为iso-8859-1  </span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String SERVER_CHARSET = <span class="string">"ISO-8859-1"</span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> FtpUtil <span class="title">getInstance</span><span class="params">(String username, String password, String ftpHostName, <span class="keyword">int</span> port)</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>)  </span><br><span class="line">            instance = <span class="keyword">new</span> FtpUtil(username, password, ftpHostName, port);  </span><br><span class="line">        <span class="keyword">return</span> instance;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FtpUtil</span><span class="params">(String username, String password,  </span></span></span><br><span class="line"><span class="function"><span class="params">                   String ftpHostName, <span class="keyword">int</span> port)</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">this</span>.username = username;  </span><br><span class="line">        <span class="keyword">this</span>.password = password;  </span><br><span class="line">        <span class="keyword">this</span>.ftpHostName = ftpHostName;  </span><br><span class="line">        <span class="keyword">this</span>.port = port;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * 建立连接,设置各种连接属性 </span></span><br><span class="line"><span class="comment">     */</span>  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">connect</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            logger.debug(<span class="string">"开始连接"</span>);  </span><br><span class="line">            <span class="comment">// 连接  </span></span><br><span class="line">            ftpClient.connect(ftpHostName, port);  </span><br><span class="line">            <span class="keyword">int</span> reply = ftpClient.getReplyCode();  </span><br><span class="line">            <span class="keyword">if</span> (!FTPReply.isPositiveCompletion(reply)) &#123;  </span><br><span class="line">                ftpClient.disconnect();  </span><br><span class="line">            &#125;  </span><br><span class="line">            <span class="comment">// 登录  </span></span><br><span class="line">            ftpClient.login(username, password);  </span><br><span class="line">            ftpClient.setBufferSize(<span class="number">1024</span> * <span class="number">1024</span>);  </span><br><span class="line">            ftpClient.setFileType(FTP.BINARY_FILE_TYPE);  </span><br><span class="line">            ftpClient.enterLocalPassiveMode();  </span><br><span class="line">            <span class="comment">//本地文件名编码  </span></span><br><span class="line">            ftpClient.setControlEncoding(LOCAL_CHARSET);  </span><br><span class="line">            logger.debug(<span class="string">"登录成功！"</span>);  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (SocketException e) &#123;  </span><br><span class="line">            logger.error(<span class="string">""</span>, e);  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;  </span><br><span class="line">            logger.error(<span class="string">""</span>, e);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * 关闭输入输出流 </span></span><br><span class="line"><span class="comment">     */</span>  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            ftpClient.logout();  </span><br><span class="line">            logger.info(<span class="string">"退出登录"</span>);  </span><br><span class="line">            ftpClient.disconnect();  </span><br><span class="line">            logger.info(<span class="string">"关闭连接"</span>);  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;  </span><br><span class="line">            logger.error(<span class="string">""</span>, e);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ftpFileName ftp服务器上的文件或者路径 </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> localDir    本地保存的文件或者路径 </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception </span></span><br><span class="line"><span class="comment">     */</span>  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">downFileOrDir</span><span class="params">(String ftpFileName, String localDir, <span class="keyword">boolean</span> isDir)</span> <span class="keyword">throws</span> Exception </span>&#123;  </span><br><span class="line">        <span class="comment">//本地输出流记得手动关闭，系统调用不会关闭本地流  </span></span><br><span class="line">        FileOutputStream fos = <span class="keyword">null</span>;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="keyword">boolean</span> downloadSuccess = <span class="keyword">false</span>;  </span><br><span class="line">            File temp = <span class="keyword">new</span> File(localDir);  </span><br><span class="line">            <span class="keyword">if</span> (!temp.exists() &amp;&amp; isDir) &#123;  </span><br><span class="line">                temp.mkdirs();  </span><br><span class="line">            &#125;  </span><br><span class="line">            <span class="comment">// 判断是否是目录  </span></span><br><span class="line">            <span class="keyword">if</span> (isDir) &#123;  </span><br><span class="line">                <span class="comment">//切换到当前目录  </span></span><br><span class="line">                <span class="keyword">if</span> (!ftpClient.changeWorkingDirectory(  </span><br><span class="line">                        <span class="keyword">new</span> String(ftpFileName.getBytes(LOCAL_CHARSET), SERVER_CHARSET))) &#123;  </span><br><span class="line">                    logger.debug(<span class="string">"目录："</span> + ftpFileName + <span class="string">" 切换失败,"</span> + ftpClient.getReplyString());  </span><br><span class="line">                    <span class="keyword">return</span>;  </span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">                    logger.debug(<span class="string">"目录："</span> + ftpFileName + <span class="string">" 切换成功,"</span> + ftpClient.getReplyString());  </span><br><span class="line">                &#125;  </span><br><span class="line">                FTPFile[] ftpFile = ftpClient.listFiles();  </span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; ftpFile.length; i++) &#123;  </span><br><span class="line">                    String fileName = ftpFile[i].getName();  </span><br><span class="line">                    <span class="comment">//两个隐藏目录忽略  </span></span><br><span class="line">                    <span class="keyword">if</span> (<span class="string">"."</span>.equals(fileName) || <span class="string">".."</span>.equals(fileName))  </span><br><span class="line">                        <span class="keyword">continue</span>;  </span><br><span class="line">                    <span class="keyword">if</span> (ftpFileName.endsWith(<span class="string">"/"</span>))  </span><br><span class="line">                        ftpFileName = ftpFileName.substring(<span class="number">0</span>, ftpFileName.length() - <span class="number">1</span>);  </span><br><span class="line">                    <span class="keyword">if</span> (localDir.endsWith(File.separator))  </span><br><span class="line">                        localDir = localDir.substring(<span class="number">0</span>, localDir.length() - <span class="number">1</span>);  </span><br><span class="line">                    <span class="comment">//递归  </span></span><br><span class="line">                    downFileOrDir(ftpFileName + <span class="string">"/"</span> + fileName, localDir  </span><br><span class="line">                            + File.separator + fileName, ftpFile[i].isDirectory() ? <span class="keyword">true</span> : <span class="keyword">false</span>);  </span><br><span class="line">                &#125;  </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">                File localfile = <span class="keyword">new</span> File(localDir);  </span><br><span class="line">                String remoteFileName = <span class="keyword">new</span> String(ftpFileName.getBytes(LOCAL_CHARSET), SERVER_CHARSET);  </span><br><span class="line">                <span class="keyword">if</span> (!localfile.exists()) &#123;  </span><br><span class="line">                    fos = <span class="keyword">new</span> FileOutputStream(localfile);  </span><br><span class="line">                    downloadSuccess = ftpClient.retrieveFile(remoteFileName, fos);  </span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">                    logger.debug(<span class="string">"开始删除本地文件："</span> + localfile);  </span><br><span class="line">                    localfile.delete();  </span><br><span class="line">                    logger.debug(<span class="string">"文件已经删除"</span>);  </span><br><span class="line">                    fos = <span class="keyword">new</span> FileOutputStream(localfile);  </span><br><span class="line">                    downloadSuccess = ftpClient.retrieveFile(remoteFileName, fos);  </span><br><span class="line">                &#125;  </span><br><span class="line">                <span class="keyword">if</span> (!downloadSuccess)  </span><br><span class="line">                    logger.debug(localfile.getCanonicalPath() + <span class="string">" 下载失败,返回代码："</span> + ftpClient.getReplyString());  </span><br><span class="line">                <span class="keyword">else</span>  </span><br><span class="line">                    logger.debug(localfile.getCanonicalPath() + <span class="string">" 下载成功,返回代码："</span> + ftpClient.getReplyString());  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">            logger.error(<span class="string">"下载失败！"</span>, e);  </span><br><span class="line">            <span class="keyword">throw</span> e;  </span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;  </span><br><span class="line">            <span class="keyword">if</span> (fos != <span class="keyword">null</span>) &#123;  </span><br><span class="line">                fos.close();  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUsername</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> username;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUsername</span><span class="params">(String username)</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">this</span>.username = username;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPassword</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> password;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPassword</span><span class="params">(String password)</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">this</span>.password = password;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getFtpHostName</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> ftpHostName;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFtpHostName</span><span class="params">(String ftpHostName)</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">this</span>.ftpHostName = ftpHostName;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPort</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> port;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPort</span><span class="params">(<span class="keyword">int</span> port)</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">this</span>.port = port;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;  </span><br><span class="line">        FtpUtil ftpUtil = FtpUtil.getInstance(<span class="string">"administrator"</span>, <span class="string">"eland_2014"</span>, <span class="string">"192.168.177.12"</span>, <span class="number">21</span>);  </span><br><span class="line">  </span><br><span class="line">        ftpUtil.connect();  </span><br><span class="line">  </span><br><span class="line">        String filePath = <span class="string">"/coredatabase/575A651B5B424200B160F92854DE986A/12220165325039161771642/"</span>;  </span><br><span class="line">        String localPath = filePath.replace(<span class="string">"/"</span>,File.separator);  </span><br><span class="line">        ftpUtil.downFileOrDir(filePath, <span class="string">"D:\\test"</span> + localPath, <span class="keyword">true</span>);  </span><br><span class="line">  </span><br><span class="line">        filePath = <span class="string">"/coredatabase/7917FCF268BE4CE09DD1C0154F9A3B0B/12920165325039689107501/"</span>;  </span><br><span class="line">        localPath = filePath.replace(<span class="string">"/"</span>,File.separator);  </span><br><span class="line">        ftpUtil.downFileOrDir(filePath, <span class="string">"D:\\test"</span> + localPath, <span class="keyword">true</span>);  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">        filePath = <span class="string">"/coredatabase/D1DEDCA33DDF47E6BA0FD697245C5D14/12320155325006100699716/"</span>;  </span><br><span class="line">        localPath = filePath.replace(<span class="string">"/"</span>,File.separator);  </span><br><span class="line">        ftpUtil.downFileOrDir(filePath, <span class="string">"D:\\test"</span> + localPath, <span class="keyword">true</span>);  </span><br><span class="line">  </span><br><span class="line">        filePath = <span class="string">"/coredatabase/3AA5084212284DCEB358F57F33BBE71D/13020165325036258525268/"</span>;  </span><br><span class="line">        localPath = filePath.replace(<span class="string">"/"</span>,File.separator);  </span><br><span class="line">        ftpUtil.downFileOrDir(filePath, <span class="string">"D:\\test"</span> + localPath, <span class="keyword">true</span>);  </span><br><span class="line">  </span><br><span class="line">        ftpUtil.close();  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>代码会递归下载传入的目录下的文件，并在本地生成ftp服务器同样的的目录结构,中文路径和文件需要对中文进行编码转换，代码中服务器中文编码是GBK的。</p>
]]></content>
      
        <categories>
            
            <category> 随笔 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> java </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[基于springmvc+spring-data-jpa+dubbo开发web应用]]></title>
      <url>/2017/05/12/spirngmvc-jpa-dubbo/</url>
      <content type="html"><![CDATA[<p>最近有项目客户要求使用dubbo进行服务关联和分布式部署，能基于dubbo发布分布式的rest服务和基于wsdl的webservice服务。看了下dubbo这个项目，其开发基本处于停滞状态,比较活跃的项目只有当当网维护的dubbox项目。本项目就是基于dubbox进行的。</p>
<p>项目模块如下图所示<br><img src="/upload/images/springmvc-dubbo/dubbo-project.png" alt="img"></p>
<p>用pom来组织Jar包依赖，dubbox我已经打包成Jar。可以看到项目分为四个模块。api提供rest和webservice的接口暴露，common是一些实体和工具类,server是数据库操作的模块，这里我们使用spring-data-jpa进行操作。web是前端应用，它通过api模块暴露的接口来调用远程dubbo服务，包括rest和webservice的。</p>
<h2 id="api部分的实现"><a href="#api部分的实现" class="headerlink" title="api部分的实现"></a>api部分的实现</h2><h3 id="1、暴露rest接口"><a href="#1、暴露rest接口" class="headerlink" title="1、暴露rest接口"></a>1、暴露rest接口</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.com.egova.easyshare.api.human;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> cn.com.egova.easyshare.common.dto.ResultDto;  </span><br><span class="line"><span class="keyword">import</span> cn.com.egova.easyshare.common.entity.Human;  </span><br><span class="line"><span class="keyword">import</span> com.alibaba.dubbo.rpc.protocol.rest.support.ContentType;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> javax.ws.rs.Consumes;  </span><br><span class="line"><span class="keyword">import</span> javax.ws.rs.GET;  </span><br><span class="line"><span class="keyword">import</span> javax.ws.rs.Path;  </span><br><span class="line"><span class="keyword">import</span> javax.ws.rs.PathParam;  </span><br><span class="line"><span class="keyword">import</span> javax.ws.rs.Produces;  </span><br><span class="line"><span class="keyword">import</span> javax.ws.rs.core.MediaType;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * 人员相关接口 </span></span><br><span class="line"><span class="comment"> * Created by gongxufan on 2017/3/8. </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="meta">@Path</span>(<span class="string">"humans"</span>)  </span><br><span class="line"><span class="meta">@Consumes</span>(&#123;MediaType.APPLICATION_JSON, MediaType.TEXT_XML&#125;)  </span><br><span class="line"><span class="meta">@Produces</span>(&#123;ContentType.APPLICATION_JSON_UTF_8, ContentType.TEXT_XML_UTF_8&#125;)  </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HumanActionApi</span>&lt;<span class="title">T</span>&gt; </span>&#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * 获取人员信息 </span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> </span></span><br><span class="line"><span class="comment">     */</span>  </span><br><span class="line">    <span class="meta">@GET</span>  </span><br><span class="line">    <span class="meta">@Path</span>(<span class="string">"view/&#123;id : \\d+&#125;"</span>)  </span><br><span class="line">    <span class="function">ResultDto&lt;Human&gt; <span class="title">getHuman</span><span class="params">(@PathParam(<span class="string">"id"</span>)</span> Integer id)</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里使用rest的注解暴露接口</p>
<h3 id="2、暴露webservice"><a href="#2、暴露webservice" class="headerlink" title="2、暴露webservice"></a>2、暴露webservice</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">WSDLServiceApi</span> </span>&#123;  </span><br><span class="line">    <span class="function">List&lt;NewsDto&gt; <span class="title">fetchNews</span><span class="params">(@XmlJavaTypeAdapter(StringObjectMapAdapter.class)</span> Map params)</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>webservice的写法很简单，只是需要注意要在接口返回的实体类上上加上xml的注解<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.com.egova.easyshare.common.dto;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> javax.xml.bind.annotation.XmlAccessType;  </span><br><span class="line"><span class="keyword">import</span> javax.xml.bind.annotation.XmlAccessorType;  </span><br><span class="line"><span class="keyword">import</span> javax.xml.bind.annotation.XmlElement;  </span><br><span class="line"><span class="keyword">import</span> javax.xml.bind.annotation.XmlRootElement;  </span><br><span class="line"><span class="keyword">import</span> java.util.Date;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * Created by gongxufan on 2017/3/30. </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="meta">@XmlRootElement</span>  </span><br><span class="line"><span class="meta">@XmlAccessorType</span>(XmlAccessType.FIELD)  </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NewsDto</span> </span>&#123;  </span><br><span class="line">  <span class="meta">@XmlElement</span>  </span><br><span class="line">  <span class="keyword">private</span> Integer newsID;  </span><br><span class="line">  <span class="meta">@XmlElement</span>  </span><br><span class="line">  <span class="keyword">private</span> String newsName;  </span><br><span class="line">  <span class="meta">@XmlElement</span>  </span><br><span class="line">  <span class="keyword">private</span> String newsDescr;  </span><br><span class="line">  <span class="meta">@XmlElement</span>  </span><br><span class="line">  <span class="keyword">private</span> String newsURL;  </span><br><span class="line">  <span class="meta">@XmlElement</span>  </span><br><span class="line">  <span class="keyword">private</span> Integer newsTypeID;  </span><br><span class="line">  <span class="meta">@XmlElement</span>  </span><br><span class="line">  <span class="keyword">private</span> Integer unitID;  </span><br><span class="line">  <span class="meta">@XmlElement</span>  </span><br><span class="line">  <span class="keyword">private</span> Date createDate;  </span><br><span class="line">  <span class="meta">@XmlElement</span>  </span><br><span class="line">  <span class="keyword">private</span> Date updateDate;  </span><br><span class="line">  <span class="meta">@XmlElement</span>  </span><br><span class="line">  <span class="keyword">private</span> Integer displayOrder;  </span><br><span class="line">  <span class="meta">@XmlElement</span>  </span><br><span class="line">  <span class="keyword">private</span> Integer openFlag = <span class="number">0</span>;  </span><br><span class="line">  <span class="meta">@XmlElement</span>  </span><br><span class="line">  <span class="keyword">private</span> String op;  </span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> Integer <span class="title">getNewsID</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">return</span> newsID;  </span><br><span class="line">  &#125;  </span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNewsID</span><span class="params">(Integer newsID)</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">this</span>.newsID = newsID;  </span><br><span class="line">  &#125;  </span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getNewsName</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">return</span> newsName;  </span><br><span class="line">  &#125;  </span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNewsName</span><span class="params">(String newsName)</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">this</span>.newsName = newsName;  </span><br><span class="line">  &#125;  </span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getNewsDescr</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">return</span> newsDescr;  </span><br><span class="line">  &#125;  </span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNewsDescr</span><span class="params">(String newsDescr)</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">this</span>.newsDescr = newsDescr;  </span><br><span class="line">  &#125;  </span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getNewsURL</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">return</span> newsURL;  </span><br><span class="line">  &#125;  </span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNewsURL</span><span class="params">(String newsURL)</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">this</span>.newsURL = newsURL;  </span><br><span class="line">  &#125;  </span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> Integer <span class="title">getNewsTypeID</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">return</span> newsTypeID;  </span><br><span class="line">  &#125;  </span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNewsTypeID</span><span class="params">(Integer newsTypeID)</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">this</span>.newsTypeID = newsTypeID;  </span><br><span class="line">  &#125;  </span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> Integer <span class="title">getUnitID</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">return</span> unitID;  </span><br><span class="line">  &#125;  </span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUnitID</span><span class="params">(Integer unitID)</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">this</span>.unitID = unitID;  </span><br><span class="line">  &#125;  </span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> Date <span class="title">getCreateDate</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">return</span> createDate;  </span><br><span class="line">  &#125;  </span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCreateDate</span><span class="params">(Date createDate)</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">this</span>.createDate = createDate;  </span><br><span class="line">  &#125;  </span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> Date <span class="title">getUpdateDate</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">return</span> updateDate;  </span><br><span class="line">  &#125;  </span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUpdateDate</span><span class="params">(Date updateDate)</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">this</span>.updateDate = updateDate;  </span><br><span class="line">  &#125;  </span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> Integer <span class="title">getDisplayOrder</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">return</span> displayOrder;  </span><br><span class="line">  &#125;  </span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDisplayOrder</span><span class="params">(Integer displayOrder)</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">this</span>.displayOrder = displayOrder;  </span><br><span class="line">  &#125;  </span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> Integer <span class="title">getOpenFlag</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">return</span> openFlag;  </span><br><span class="line">  &#125;  </span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOpenFlag</span><span class="params">(Integer openFlag)</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">this</span>.openFlag = openFlag;  </span><br><span class="line">  &#125;  </span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getOp</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">return</span> op;  </span><br><span class="line">  &#125;  </span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOp</span><span class="params">(String op)</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">this</span>.op = op;  </span><br><span class="line">  &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>api模块单独分出来可以直接提供给其他模块进行调用</p>
<h2 id="接口实现部分"><a href="#接口实现部分" class="headerlink" title="接口实现部分"></a>接口实现部分</h2><h3 id="使用dubbo服务"><a href="#使用dubbo服务" class="headerlink" title="使用dubbo服务"></a>使用dubbo服务</h3><p>在app-config.xml中我们需要定义dubbo服务相关的信息，具体网上很多资料可以查看。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;  </span><br><span class="line"><span class="comment">&lt;!--  </span></span><br><span class="line"><span class="comment"> - Copyright 1999-2011 Alibaba Group.  </span></span><br><span class="line"><span class="comment"> -    </span></span><br><span class="line"><span class="comment"> - Licensed under the Apache License, Version 2.0 (the "License");  </span></span><br><span class="line"><span class="comment"> - you may not use this file except in compliance with the License.  </span></span><br><span class="line"><span class="comment"> - You may obtain a copy of the License at  </span></span><br><span class="line"><span class="comment"> -    </span></span><br><span class="line"><span class="comment"> -      http://www.apache.org/licenses/LICENSE-2.0  </span></span><br><span class="line"><span class="comment"> -    </span></span><br><span class="line"><span class="comment"> - Unless required by applicable law or agreed to in writing, software  </span></span><br><span class="line"><span class="comment"> - distributed under the License is distributed on an "AS IS" BASIS,  </span></span><br><span class="line"><span class="comment"> - WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  </span></span><br><span class="line"><span class="comment"> - See the License for the specific language governing permissions and  </span></span><br><span class="line"><span class="comment"> - limitations under the License.  </span></span><br><span class="line"><span class="comment">--&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span>  </span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span>  </span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:dubbo</span>=<span class="string">"http://code.alibabatech.com/schema/dubbo"</span>  </span></span><br><span class="line"><span class="tag">    <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.5.xsd  </span></span></span><br><span class="line"><span class="tag"><span class="string">    http://code.alibabatech.com/schema/dubbo http://code.alibabatech.com/schema/dubbo/dubbo.xsd"</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:application</span> <span class="attr">name</span>=<span class="string">"service-provider"</span> <span class="attr">owner</span>=<span class="string">"egova"</span> <span class="attr">organization</span>=<span class="string">"goutu"</span>/&gt;</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:registry</span> <span class="attr">address</span>=<span class="string">"zookeeper://127.0.0.1:2181"</span> <span class="attr">check</span>=<span class="string">"false"</span>/&gt;</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">&lt;!--使Dubbo在Spring容器初始化完后，再暴露服务--&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:provider</span> <span class="attr">delay</span>=<span class="string">"-1"</span>/&gt;</span>  </span><br><span class="line">    <span class="comment">&lt;!--uncomment this if you want to test dubbo's monitor--&gt;</span>  </span><br><span class="line">    <span class="comment">&lt;!--&lt;dubbo:monitor protocol="registry"/&gt;--&gt;</span>  </span><br><span class="line">    <span class="comment">&lt;!-- use tomcat server --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:protocol</span> <span class="attr">name</span>=<span class="string">"rest"</span> <span class="attr">port</span>=<span class="string">"8888"</span> <span class="attr">threads</span>=<span class="string">"500"</span> <span class="attr">contextpath</span>=<span class="string">"services"</span> <span class="attr">server</span>=<span class="string">"tomcat"</span> <span class="attr">accepts</span>=<span class="string">"1000"</span>  </span></span><br><span class="line"><span class="tag">    <span class="attr">extension</span>=<span class="string">"cn.com.egova.easyshare.api.extension.CustomExceptionMapper"</span>/&gt;</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:protocol</span> <span class="attr">name</span>=<span class="string">"webservice"</span> <span class="attr">port</span>=<span class="string">"8892"</span> <span class="attr">server</span>=<span class="string">"tomcat"</span> <span class="attr">contextpath</span>=<span class="string">"services"</span>/&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>这里我们定义了rest和webservice协议，rest协议在8888下而webservice在8892下访问。需要注意的是，我们把这两个服务都跑在tomcat下。这样我们的接口实现部分可以打成war包部署在多个tomcat下，从而实现了接口服务的分布式部署。</p>
<p>这里只是作为演示，所以app-db.xml中的数据源定义都已经注释掉了。如果你想采用spring-data-jpa进行数据操作的话可以把注释去掉，然后去实现自己的Repository 。</p>
<h2 id="web应用部分"><a href="#web应用部分" class="headerlink" title="web应用部分"></a>web应用部分</h2><p>这个就不用提了，我提供了一个测试页面测试接口。需要注意的是，web调用接口的配置是在dubbo-consumer.xml中</p>
<pre><code class="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;  
<span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span>  </span>
<span class="tag">    <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span>  </span>
<span class="tag">    <span class="attr">xmlns:dubbo</span>=<span class="string">"http://code.alibabatech.com/schema/dubbo"</span>  </span>
<span class="tag">    <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans  </span></span>
<span class="tag"><span class="string">        http://www.springframework.org/schema/beans/spring-beans.xsd  </span></span>
<span class="tag"><span class="string">        http://code.alibabatech.com/schema/dubbo  </span></span>
<span class="tag"><span class="string">        http://code.alibabatech.com/schema/dubbo/dubbo.xsd"</span>&gt;</span>  
    <span class="comment">&lt;!-- 消费方应用名，用于计算依赖关系，不是匹配条件，不要与提供方一样 --&gt;</span>  
    <span class="tag">&lt;<span class="name">dubbo:application</span> <span class="attr">name</span>=<span class="string">"dubbo-client"</span> <span class="attr">owner</span>=<span class="string">"egova-client"</span> <span class="attr">organization</span>=<span class="string">"goutu-client"</span> /&gt;</span>  
    <span class="comment">&lt;!-- zookeeper注册中心 --&gt;</span>  
    <span class="tag">&lt;<span class="name">dubbo:registry</span>  <span class="attr">protocol</span>=<span class="string">"zookeeper"</span> <span class="attr">address</span>=<span class="string">"127.0.0.1:2181"</span> <span class="attr">check</span>=<span class="string">"false"</span>/&gt;</span>  
    <span class="comment">&lt;!-- 监控中心配置 --&gt;</span>  
    <span class="comment">&lt;!--&lt;dubbo:monitor protocol="registry"/&gt;--&gt;</span>  

    <span class="comment">&lt;!--关闭所有服务的启动可用性检查--&gt;</span>  
    <span class="tag">&lt;<span class="name">dubbo:consumer</span> <span class="attr">check</span>=<span class="string">"false"</span> /&gt;</span>  

     <span class="comment">&lt;!-- dubbo远程服务--&gt;</span>  
    <span class="tag">&lt;<span class="name">dubbo:reference</span> <span class="attr">id</span>=<span class="string">"humanAction"</span>   <span class="attr">interface</span>=<span class="string">"cn.com.egova.easyshare.api.human.HumanActionApi"</span>/&gt;</span>  
    <span class="tag">&lt;<span class="name">dubbo:reference</span> <span class="attr">id</span>=<span class="string">"wSDLService"</span>   <span class="attr">interface</span>=<span class="string">"cn.com.egova.easyshare.webservice.WSDLServiceApi"</span> /&gt;</span>  
<span class="tag">&lt;/<span class="name">beans</span>&gt;</span>
</code></pre>
<p>在这里配置好zookeeper和api端的service,然后在contoller里就可以调用接口方法了。</p>
<h2 id="end"><a href="#end" class="headerlink" title="end"></a>end</h2><p>代码下载地址:<a href="http://download.csdn.net/download/qq381332153/9840564" target="_blank" rel="external">csdn下载</a><br>github: <a href="https://github.com/gongxufan/dubbo-demo" target="_blank" rel="external">https://github.com/gongxufan/dubbo-demo</a></p>
]]></content>
      
        <categories>
            
            <category> 随笔 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> java </tag>
            
            <tag> spring </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[spring-data-jpa只查询实体部分字段的情况]]></title>
      <url>/2017/03/29/spring-data-jpa-query-part/</url>
      <content type="html"><![CDATA[<p>不论是nativequery还是hql的query，都可以指定需要查询的字段，只是必须定义这些字段所对应的实体，而且需要一个构造函数，构造函数的参数就是查询的字段列表。举个栗子：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span>  </span><br><span class="line"><span class="meta">@Table</span>(name=<span class="string">"tcHuman"</span>)  </span><br><span class="line"><span class="meta">@JsonInclude</span>(JsonInclude.Include.NON_NULL)  </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Human</span> </span>&#123;  </span><br><span class="line">    <span class="meta">@Id</span>  </span><br><span class="line">    <span class="meta">@GeneratedValue</span>(strategy = GenerationType.TABLE, generator = <span class="string">"tableKeyGenerator"</span>)  </span><br><span class="line">    <span class="meta">@TableGenerator</span>(name = <span class="string">"tableKeyGenerator"</span>, table = <span class="string">"tcTableKeyGenerator"</span>,  </span><br><span class="line">            pkColumnName = <span class="string">"pk_key"</span>, valueColumnName = <span class="string">"pk_value"</span>, pkColumnValue = <span class="string">"humanID"</span>,  </span><br><span class="line">            initialValue = <span class="number">1</span>, allocationSize = <span class="number">1</span>)  </span><br><span class="line">    <span class="keyword">private</span> Integer humanID;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> String humanName;  </span><br><span class="line">    <span class="comment">//人员代码  </span></span><br><span class="line">    <span class="keyword">private</span> String humanCode;  </span><br><span class="line">    <span class="keyword">private</span> String humanPassword;  </span><br><span class="line">    <span class="keyword">private</span> String description;  </span><br><span class="line">    <span class="comment">//所属单位  </span></span><br><span class="line">    <span class="keyword">private</span> Integer unitID;  </span><br><span class="line">    <span class="keyword">private</span> Integer displayOrder;  </span><br><span class="line">    <span class="keyword">private</span> Integer identifyType;  </span><br><span class="line">    <span class="keyword">private</span> Integer activeFlag;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Human</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Human</span><span class="params">(String humanName)</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">this</span>.humanName = humanName;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getHumanID</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> humanID;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setHumanID</span><span class="params">(Integer humanID)</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">this</span>.humanID = humanID;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getHumanName</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> humanName;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setHumanName</span><span class="params">(String humanName)</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">this</span>.humanName = humanName;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getHumanCode</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> humanCode;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setHumanCode</span><span class="params">(String humanCode)</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">this</span>.humanCode = humanCode;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getHumanPassword</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> humanPassword;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setHumanPassword</span><span class="params">(String humanPassword)</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">this</span>.humanPassword = humanPassword;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getDescription</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> description;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDescription</span><span class="params">(String description)</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">this</span>.description = description;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getUnitID</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> unitID;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUnitID</span><span class="params">(Integer unitID)</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">this</span>.unitID = unitID;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getDisplayOrder</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> displayOrder;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDisplayOrder</span><span class="params">(Integer displayOrder)</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">this</span>.displayOrder = displayOrder;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getIdentifyType</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> identifyType;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setIdentifyType</span><span class="params">(Integer identifyType)</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">this</span>.identifyType = identifyType;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getActiveFlag</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> activeFlag;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setActiveFlag</span><span class="params">(Integer activeFlag)</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">this</span>.activeFlag = activeFlag;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>查询人员的实体，我需要返回所有人员的名字。查询如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Query</span>(<span class="string">"select new Human (h.humanName) from Human  h "</span>)  </span><br><span class="line">   <span class="function">List&lt;Human&gt; <span class="title">getHumanList</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure></p>
<p>我们需要查询humanName,所以必须要有public Human(String humanName)这个构造函数，而且必须提供默认的构造函数,否则entity无法构造。</p>
<p>这样虽然方便，但是如果返回的字段偏多，那么这个构造函数就参数列表就很长。这种情况最好还是用nativequery,定义的接口其返回类型为List<object[]>。</object[]></p>
<p>对于Object[]返回结果的处理如果想做成通用的，可以参考下GSON的反序列化，通过传递T.class，通过反射去构造对象并设置字段。</p>
]]></content>
      
        <categories>
            
            <category> 随笔 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> java </tag>
            
            <tag> spring </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[ Java实现转发基于soap协议的webservice接口调用]]></title>
      <url>/2017/03/08/dispatch-soap-webervice/</url>
      <content type="html"><![CDATA[<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>现在有这么一个需求，我们的系统(M)作为各个系统信息交换中间平台。系统Ａ和系统Ｂ需要交互，但是他们的网络是隔离的。系统Ｂ通过webservice发布了一些接口服务，然后提供WSDL给系统Ａ调用，然而系统A是无法访问系统B的网络，所以数据先要发送中间系统M。其实也就是一个简单的服务转发代理的功能，只是涉及到soap协议的交互。</p>
<h2 id="一种简单的方式"><a href="#一种简单的方式" class="headerlink" title="一种简单的方式"></a>一种简单的方式</h2><p>系统Ａ使用soapui导入WSDL文件，获取每个方法的请求报文-&gt;提交M-&gt;原样提交到系统B－&gt;将系统B的处理结果返回<br>其中主要涉及到soap协议的一些报文头的设置，下边会有调用代码说明。</p>
<h3 id="转发的实现"><a href="#转发的实现" class="headerlink" title="转发的实现"></a>转发的实现</h3><p>主要是在中间系统Ｍ注册filter来拦截webservice请求，然后将请求数据流构造一个新的http请求发送给系统B。这里请求的发送和转换采用httpcomponents实现。引入依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">       <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.httpcomponents<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">       <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>httpclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">       <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">   <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">   <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">       <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.httpcomponents<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">       <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>httpcore<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">       <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">   <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">       <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.httpcomponents<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">       <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>httpclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">       <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">   <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">   <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">       <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.httpcomponents<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">       <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>httpcore<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">       <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">   <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>filter代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.com.egova.easyshare.web.filter;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auth</span> gongxufan </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2017/9/20 </span></span><br><span class="line"><span class="comment"> **/</span>  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> org.apache.cxf.helpers.IOUtils;  </span><br><span class="line"><span class="keyword">import</span> org.apache.http.Header;  </span><br><span class="line"><span class="keyword">import</span> org.apache.http.client.methods.CloseableHttpResponse;  </span><br><span class="line"><span class="keyword">import</span> org.apache.http.client.methods.HttpPost;  </span><br><span class="line"><span class="keyword">import</span> org.apache.http.entity.InputStreamEntity;  </span><br><span class="line"><span class="keyword">import</span> org.apache.http.impl.client.CloseableHttpClient;  </span><br><span class="line"><span class="keyword">import</span> org.apache.http.impl.client.HttpClients;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.Filter;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.FilterChain;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.FilterConfig;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequest;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletResponse;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;  </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line"><span class="keyword">import</span> java.util.Enumeration;  </span><br><span class="line"><span class="keyword">import</span> java.util.ResourceBundle;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * WSDL服务器请求转发 </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebServiceDispatchFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String WEBSERVICE_URL;  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String WEBSERVICE_HOST;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">static</span> &#123;  </span><br><span class="line">        ResourceBundle bundler = ResourceBundle.getBundle(<span class="string">"config"</span>);  </span><br><span class="line">        <span class="comment">// 获取调用接口的路径  </span></span><br><span class="line">        WEBSERVICE_URL = bundler.getString(<span class="string">"WEBSERVICE_URL"</span>);  </span><br><span class="line">        WEBSERVICE_HOST = bundler.getString(<span class="string">"WEBSERVICE_HOST"</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest req, ServletResponse resp,  </span></span></span><br><span class="line"><span class="function"><span class="params">                         FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;  </span><br><span class="line">        HttpServletRequest request = (HttpServletRequest) req;  </span><br><span class="line">        HttpServletResponse response = (HttpServletResponse) resp;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            CloseableHttpClient httpClient = HttpClients.createDefault();  </span><br><span class="line">            HttpPost httpPost = <span class="keyword">new</span> HttpPost(WEBSERVICE_URL);  </span><br><span class="line">            <span class="comment">//构造新的请求数据流  </span></span><br><span class="line">            InputStreamEntity entity = <span class="keyword">new</span> InputStreamEntity(  </span><br><span class="line">                    request.getInputStream());  </span><br><span class="line">            httpPost.setEntity(entity);  </span><br><span class="line">            <span class="comment">//复制请求参数  </span></span><br><span class="line">            <span class="keyword">for</span> (Enumeration&lt;String&gt; e = request.getHeaderNames(); e  </span><br><span class="line">                    .hasMoreElements(); ) &#123;  </span><br><span class="line">                String name = e.nextElement().toString();  </span><br><span class="line">                <span class="comment">//注意这里不要设置，发送请求会抛异常  </span></span><br><span class="line">                <span class="keyword">if</span> (<span class="string">"Content-Length"</span>.equalsIgnoreCase(name)) &#123;  </span><br><span class="line">                    <span class="keyword">continue</span>;  </span><br><span class="line">                &#125;  </span><br><span class="line">                httpPost.setHeader(name, request.getHeader(name));  </span><br><span class="line">            &#125;  </span><br><span class="line">            <span class="comment">//host参数需要覆盖，设置为webservice服务提供这的主机  </span></span><br><span class="line">            httpPost.setHeader(<span class="string">"host"</span>, WEBSERVICE_HOST);  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">            <span class="comment">//提交soap请求  </span></span><br><span class="line">            CloseableHttpResponse httpResponse = httpClient.execute(httpPost);  </span><br><span class="line">            <span class="comment">//复制soap相应的消息头  </span></span><br><span class="line">            <span class="keyword">for</span> (Header h : httpResponse.getAllHeaders()) &#123;  </span><br><span class="line">                response.setHeader(h.getName(), h.getValue());  </span><br><span class="line">            &#125;  </span><br><span class="line">            <span class="comment">//讲soap的返回流复制到filter的输出流  </span></span><br><span class="line">            IOUtils.copyAndCloseInput(httpResponse.getEntity().getContent(),  </span><br><span class="line">                    response.getOutputStream());  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">            response.setContentType(<span class="string">"text/xml;charset=UTF-8"</span>);  </span><br><span class="line">            String result = <span class="string">"&lt;soap:Envelope xmlns:soap=\"http://schemas.xmlsoap.org/soap/envelope/\"&gt;"</span>  </span><br><span class="line">                    + <span class="string">"&lt;soap:Body&gt;&lt;soap:Fault&gt;&lt;faultcode&gt;"</span>  </span><br><span class="line">                    + <span class="string">"9999"</span>  </span><br><span class="line">                    + <span class="string">"&lt;/faultcode&gt;"</span>  </span><br><span class="line">                    + <span class="string">"&lt;faultstring&gt;"</span>  </span><br><span class="line">                    + <span class="string">"失败:"</span>  </span><br><span class="line">                    + e.getMessage()  </span><br><span class="line">                    + <span class="string">"&lt;/faultstring&gt;&lt;/soap:Fault&gt;&lt;/soap:Body&gt;&lt;/soap:Envelope&gt;"</span>;  </span><br><span class="line">            response.getWriter().print(result);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException </span>&#123;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>代码实现也很简单：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CloseableHttpClient httpClient = HttpClients.createDefault();</span><br><span class="line">HttpPost httpPost = <span class="keyword">new</span> HttpPost(WEBSERVICE_URL);</span><br></pre></td></tr></table></figure></p>
<p>这里构造了一个新的httpPost对象，然后读取请求流构造InputStreamEntity，接着设置httpPost的header。执行CloseableHttpResponse httpResponse = httpClient.execute(httpPost);这样就获取了接口调用的结果最后将httpResponse原样输出到系统A的调用者。</p>
<p>为了测试方便，我们使用天气预报的webservice接口进行测试，上面代码的主机和服务地址是写在配置文件的，其内容如下：</p>
<blockquote>
<p>WEBSERVICE_HOST=www.webxml.com.cn<br> WEBSERVICE_URL=<a href="http://www.webxml.com.cn/WebServices/WeatherWebService.asmx?wsdl" target="_blank" rel="external">http://www.webxml.com.cn/WebServices/WeatherWebService.asmx?wsdl</a></p>
</blockquote>
<p>配置filter拦截：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>WsTransFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>cn.com.egova.easyshare.web.filter.WebServiceDispatchFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>WsTransFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/webservice/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h3 id="使用soapUI进行接口测试"><a href="#使用soapUI进行接口测试" class="headerlink" title="使用soapUI进行接口测试"></a>使用soapUI进行接口测试</h3><p>用浏览器访问<a href="http://www.webxml.com.cn/WebServices/WeatherWebService.asmx?wsdl，并保存为WeatherWebService.xml。文件内容较多这里就不展示了。" target="_blank" rel="external">http://www.webxml.com.cn/WebServices/WeatherWebService.asmx?wsdl，并保存为WeatherWebService.xml。文件内容较多这里就不展示了。</a></p>
<p>打开soapUI，新建一个soap工程，并导入wsdl文件，这样就可以测试接口了.我们测试下getSupportCity这个方法,只要把地址栏的地址替换成filter的访问地址即可:<a href="http://localhost:8080/easyshare-web/" target="_blank" rel="external">http://localhost:8080/easyshare-web/</a><br><img src="/upload/images/webservice-dispatch/soapui-test.png" alt="img"></p>
<h3 id="使用HttpClient测试接口"><a href="#使用HttpClient测试接口" class="headerlink" title="使用HttpClient测试接口"></a>使用HttpClient测试接口</h3><p>只要按照soapUI测试接口的头部信息发送请求报文，就可以成功调用接口。因此我们的客户端调用代码按照这个模式就可以执行接口的调用了，只是要注意我们调用的目标是转发服务的地址。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.com.egova.easyshare.test.web;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> cn.com.egova.easyshare.web.utils.HttpUtils;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> java.util.ResourceBundle;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auth</span> gongxufan </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2017/9/27 </span></span><br><span class="line"><span class="comment"> **/</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SoapInvokeTest</span> </span>&#123;  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] arg)</span> </span>&#123;  </span><br><span class="line">        <span class="comment">//soap测试  </span></span><br><span class="line">        String postUrl = <span class="string">"http://localhost:8080/easyshare-web/webservice"</span>;  </span><br><span class="line">        <span class="comment">//采用SOAP1.1调用服务端，这种方式能调用服务端为soap1.1和soap1.2的服务  </span></span><br><span class="line">        String orderSoapXml = <span class="string">"&lt;soapenv:Envelope xmlns:soapenv=\"http://schemas.xmlsoap.org/soap/envelope/\" xmlns:web=\"http://WebXml.com.cn/\"&gt;\n"</span> +  </span><br><span class="line">                <span class="string">"   &lt;soapenv:Header/&gt;\n"</span> +  </span><br><span class="line">                <span class="string">"   &lt;soapenv:Body&gt;\n"</span> +  </span><br><span class="line">                <span class="string">"      &lt;web:getSupportCity&gt;\n"</span> +  </span><br><span class="line">                <span class="string">"         &lt;!--Optional:--&gt;\n"</span> +  </span><br><span class="line">                <span class="string">"         &lt;web:byProvinceName&gt;云南&lt;/web:byProvinceName&gt;\n"</span> +  </span><br><span class="line">                <span class="string">"      &lt;/web:getSupportCity&gt;\n"</span> +  </span><br><span class="line">                <span class="string">"   &lt;/soapenv:Body&gt;\n"</span> +  </span><br><span class="line">                <span class="string">"&lt;/soapenv:Envelope&gt;"</span>;  </span><br><span class="line">        String soap1_1 = HttpUtils.doPostSoap1_1(postUrl, orderSoapXml, <span class="string">"http://WebXml.com.cn/getSupportCity"</span>);  </span><br><span class="line">        System.out.println(soap1_1);  </span><br><span class="line">        <span class="comment">//soap1.2没有soapAction头，直接设置在content-type  </span></span><br><span class="line">        String soap1_2 = HttpUtils.doPostSoap1_2(postUrl, orderSoapXml, <span class="string">"http://WebXml.com.cn/getSupportCity"</span>);  </span><br><span class="line">        System.out.println(soap1_2);  </span><br><span class="line">        System.out.println(<span class="string">"end"</span>);  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">doPostSoap1_1</span><span class="params">(String postUrl, String soapXml,  </span></span></span><br><span class="line"><span class="function"><span class="params">                                      String soapAction)</span> </span>&#123;  </span><br><span class="line">       LOGGER.info(<span class="string">"开始转发webservice："</span> + postUrl);  </span><br><span class="line">       String retStr = <span class="string">""</span>;  </span><br><span class="line">       <span class="comment">// 创建HttpClientBuilder  </span></span><br><span class="line">       HttpClientBuilder httpClientBuilder = HttpClientBuilder.create();  </span><br><span class="line">       <span class="comment">// HttpClient  </span></span><br><span class="line">       CloseableHttpClient closeableHttpClient = httpClientBuilder.build();  </span><br><span class="line">       HttpPost httpPost = <span class="keyword">new</span> HttpPost(postUrl);  </span><br><span class="line">       <span class="comment">//  设置请求和传输超时时间  </span></span><br><span class="line">      <span class="comment">/* RequestConfig requestConfig = RequestConfig.custom() </span></span><br><span class="line"><span class="comment">               .setSocketTimeout(socketTimeout) </span></span><br><span class="line"><span class="comment">               .setConnectTimeout(connectTimeout).build(); </span></span><br><span class="line"><span class="comment">       httpPost.setConfig(requestConfig);*/</span>  </span><br><span class="line">       <span class="keyword">try</span> &#123;  </span><br><span class="line">           httpPost.setHeader(<span class="string">"Content-Type"</span>, <span class="string">"text/xml;charset=UTF-8"</span>);  </span><br><span class="line">           httpPost.setHeader(<span class="string">"SOAPAction"</span>, soapAction);  </span><br><span class="line">           StringEntity data = <span class="keyword">new</span> StringEntity(soapXml,  </span><br><span class="line">                   Charset.forName(<span class="string">"UTF-8"</span>));  </span><br><span class="line">           httpPost.setEntity(data);  </span><br><span class="line">           CloseableHttpResponse response = closeableHttpClient  </span><br><span class="line">                   .execute(httpPost);  </span><br><span class="line">           HttpEntity httpEntity = response.getEntity();  </span><br><span class="line">           <span class="keyword">if</span> (httpEntity != <span class="keyword">null</span>) &#123;  </span><br><span class="line">               <span class="comment">// 打印响应内容  </span></span><br><span class="line">               retStr = EntityUtils.toString(httpEntity, <span class="string">"UTF-8"</span>);  </span><br><span class="line">               LOGGER.info(<span class="string">"response:"</span> + retStr);  </span><br><span class="line">           &#125;  </span><br><span class="line">  </span><br><span class="line">       &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">           LOGGER.error(<span class="string">"exception in doPostSoap1_1"</span>, e);  </span><br><span class="line">       &#125; <span class="keyword">finally</span> &#123;  </span><br><span class="line">           <span class="comment">// 释放资源  </span></span><br><span class="line">           <span class="keyword">try</span> &#123;  </span><br><span class="line">               closeableHttpClient.close();  </span><br><span class="line">           &#125; <span class="keyword">catch</span> (IOException e) &#123;  </span><br><span class="line">               e.printStackTrace();  </span><br><span class="line">           &#125;  </span><br><span class="line">       &#125;  </span><br><span class="line">       <span class="keyword">return</span> retStr;  </span><br><span class="line">   &#125;  </span><br><span class="line">  </span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">doPostSoap1_2</span><span class="params">(String postUrl, String soapXml,  </span></span></span><br><span class="line"><span class="function"><span class="params">                                      String soapAction)</span> </span>&#123;  </span><br><span class="line">       String retStr = <span class="string">""</span>;  </span><br><span class="line">       <span class="comment">// 创建HttpClientBuilder  </span></span><br><span class="line">       HttpClientBuilder httpClientBuilder = HttpClientBuilder.create();  </span><br><span class="line">       <span class="comment">// HttpClient  </span></span><br><span class="line">       CloseableHttpClient closeableHttpClient = httpClientBuilder.build();  </span><br><span class="line">       HttpPost httpPost = <span class="keyword">new</span> HttpPost(postUrl);  </span><br><span class="line">     <span class="comment">/*  // 设置请求和传输超时时间 </span></span><br><span class="line"><span class="comment">       RequestConfig requestConfig = RequestConfig.custom() </span></span><br><span class="line"><span class="comment">               .setSocketTimeout(socketTimeout) </span></span><br><span class="line"><span class="comment">               .setConnectTimeout(connectTimeout).build(); </span></span><br><span class="line"><span class="comment">       httpPost.setConfig(requestConfig);*/</span>  </span><br><span class="line">       <span class="keyword">try</span> &#123;  </span><br><span class="line">           httpPost.setHeader(<span class="string">"Content-Type"</span>,  </span><br><span class="line">                   <span class="string">"text/xml;charset=UTF-8;action=\""</span> + soapAction + <span class="string">"\""</span>);  </span><br><span class="line">           StringEntity data = <span class="keyword">new</span> StringEntity(soapXml,  </span><br><span class="line">                   Charset.forName(<span class="string">"UTF-8"</span>));  </span><br><span class="line">           httpPost.setEntity(data);  </span><br><span class="line">           CloseableHttpResponse response = closeableHttpClient  </span><br><span class="line">                   .execute(httpPost);  </span><br><span class="line">           HttpEntity httpEntity = response.getEntity();  </span><br><span class="line">           <span class="keyword">if</span> (httpEntity != <span class="keyword">null</span>) &#123;  </span><br><span class="line">               <span class="comment">// 打印响应内容  </span></span><br><span class="line">               retStr = EntityUtils.toString(httpEntity, <span class="string">"UTF-8"</span>);  </span><br><span class="line">               LOGGER.info(<span class="string">"response:"</span> + retStr);  </span><br><span class="line">           &#125;  </span><br><span class="line">           <span class="comment">// 释放资源  </span></span><br><span class="line">           closeableHttpClient.close();  </span><br><span class="line">       &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">           LOGGER.error(<span class="string">"exception in doPostSoap1_2"</span>, e);  </span><br><span class="line">       &#125;  </span><br><span class="line">       <span class="keyword">return</span> retStr;  </span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>上面1.1和1.2方法的区别就是头部设置的差异，这个是按照soapUI调用时自动生成的header来设置的。</p>
<p><img src="/upload/images/webservice-dispatch/http-test.png" alt="img"></p>
<h2 id="end"><a href="#end" class="headerlink" title="end"></a>end</h2><p>本文实现的方法就是按照原始的soapUI调用，主要导入WSDL文件根据其定义的方法，将请求报文和请求头发送到代理服务器然后在转发到webservice服务方即可实现调用的转发。</p>
<p>其实我们还可以采用apache camel进行服务的转发，不过camel适用于较复杂的规则路由场景。其具体使用也很方便，只要配置好路由规则即可实现的服务的路由和转发，具体可参考其文档。</p>
]]></content>
      
        <categories>
            
            <category> 工作日志 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> java </tag>
            
            <tag> webservice </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[easyUI实现类似搜索框关键词自动提示功能]]></title>
      <url>/2016/12/23/easyui-search-commbox/</url>
      <content type="html"><![CDATA[<p>在一个DataGrid里面，搜索行所在位置，实现的效果如下：</p>
<p><img src="/upload/images/easyui-search/demo.gif" alt="img"></p>
<p>在搜索框中输入部分列名关键字，即可匹配到行的位置。</p>
<p>EasyUI的SearchBox组件只提供了静态搜索框，我们可以使用ComboBox来实现动态的自动关键匹配效果，并且不需要加载远程数据。当前页面的DataGrid的数据我们可以直接在本地获取之。代码如下：</p>
<h2 id="setp1-创建combobox"><a href="#setp1-创建combobox" class="headerlink" title="setp1 创建combobox"></a>setp1 创建combobox</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"text-align: left;background-color: #E0ECFF;padding-left: 10px;padding-top: 5px;"</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"searchField"</span>  <span class="attr">style</span>=<span class="string">"width:250px"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="step2-实现本地数据加载"><a href="#step2-实现本地数据加载" class="headerlink" title="step2 实现本地数据加载"></a>step2 实现本地数据加载</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="string">"#searchField"</span>).combobox(&#123;</span><br><span class="line">    loader: <span class="function"><span class="keyword">function</span>(<span class="params">param,success,error</span>)</span>&#123;</span><br><span class="line">        <span class="comment">//获取输入的值</span></span><br><span class="line">        <span class="keyword">var</span> q = param.q || <span class="string">""</span>;</span><br><span class="line">        <span class="comment">//此处q的length代表输入多少个字符后开始查询</span></span><br><span class="line">        <span class="keyword">if</span>(q.length &lt;= <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">var</span> rows = $(<span class="string">'#fieldList'</span>).datagrid(<span class="string">'getRows'</span>);</span><br><span class="line">        <span class="keyword">var</span> items = $.map(rows, <span class="function"><span class="keyword">function</span> (<span class="params">item, index</span>) </span>&#123;</span><br><span class="line">            <span class="comment">//匹配条件，忽略大小写</span></span><br><span class="line">            <span class="keyword">if</span>(item.fieldName &amp;&amp; (item.fieldName.toLowerCase().indexOf(q.toLowerCase()) != <span class="number">-1</span>))&#123;</span><br><span class="line">                <span class="keyword">return</span> &#123;</span><br><span class="line">                    <span class="string">"fieldName"</span>: item.fieldName</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        success(items);</span><br><span class="line">    &#125;,</span><br><span class="line">    onBeforeLoad:<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">//设置placeholder</span></span><br><span class="line">        $(<span class="string">"input[class='textbox-text validatebox-text textbox-prompt']"</span>).attr(<span class="string">"placeholder"</span>,<span class="string">"输入标注字段，定位所在行"</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    mode: <span class="string">'remote'</span>,</span><br><span class="line">    textField:<span class="string">'fieldName'</span>,</span><br><span class="line">    valueField:<span class="string">'fieldName'</span>,</span><br><span class="line">    onSelect : <span class="function"><span class="keyword">function</span>(<span class="params">record</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> $filedList = $(<span class="string">'#fieldList'</span>);</span><br><span class="line">        <span class="keyword">var</span> rows = $filedList.datagrid(<span class="string">'getRows'</span>);</span><br><span class="line">        <span class="keyword">if</span>(rows &amp;&amp; rows.length &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">var</span> r = <span class="number">0</span> ; r &lt; rows.length ; r++)&#123;</span><br><span class="line">                <span class="keyword">if</span>(rows[r].fieldName == record.fieldName)&#123;</span><br><span class="line">                    $filedList.datagrid(<span class="string">'selectRow'</span>,r);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>load是一个适配器，它将本地数据转换成combobox所需的数据格式：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> rows = $(<span class="string">'#fieldList'</span>).datagrid(<span class="string">'getRows'</span>);</span><br><span class="line">       <span class="keyword">var</span> items = $.map(rows, <span class="function"><span class="keyword">function</span> (<span class="params">item, index</span>) </span>&#123;</span><br><span class="line">           <span class="comment">//匹配条件，忽略大小写</span></span><br><span class="line">           <span class="keyword">if</span>(item.fieldName &amp;&amp; (item.fieldName.toLowerCase().indexOf(q.toLowerCase()) != <span class="number">-1</span>))&#123;</span><br><span class="line">               <span class="keyword">return</span> &#123;</span><br><span class="line">                   <span class="string">"fieldName"</span>: item.fieldName</span><br><span class="line">               &#125;;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br></pre></td></tr></table></figure></p>
<p>首先我们通过datagrid的getRows方法获取当前数据表的所有行，然后通过map转换,调用<code>success(items);</code>，到此就完成了数据的转换。</p>
<h2 id="step3、实现行的选中"><a href="#step3、实现行的选中" class="headerlink" title="step3、实现行的选中"></a>step3、实现行的选中</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">onSelect : <span class="function"><span class="keyword">function</span>(<span class="params">record</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> $filedList = $(<span class="string">'#fieldList'</span>);</span><br><span class="line">        <span class="keyword">var</span> rows = $filedList.datagrid(<span class="string">'getRows'</span>);</span><br><span class="line">        <span class="keyword">if</span>(rows &amp;&amp; rows.length &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">var</span> r = <span class="number">0</span> ; r &lt; rows.length ; r++)&#123;</span><br><span class="line">                <span class="keyword">if</span>(rows[r].fieldName == record.fieldName)&#123;</span><br><span class="line">                    $filedList.datagrid(<span class="string">'selectRow'</span>,r);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="end"><a href="#end" class="headerlink" title="end"></a>end</h2><p>在onSelect事件中，匹配所在行调用selectRow即可。</p>
]]></content>
      
        <categories>
            
            <category> 随笔 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> javascript </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Javascript树形结构的数组表示和转换]]></title>
      <url>/2016/12/08/javascript-tree-data/</url>
      <content type="html"><![CDATA[<p>在做微信公众号开发的时候，对自定义菜单进行管理就涉及到父子菜单的操作。我们在数据中一般保存为(id,pid,…)这样的平级结构，而在调用微信接口的时候一般是一个层级的数组结构，我们可以用JS进行转换。</p>
<h2 id="数组降级"><a href="#数组降级" class="headerlink" title="数组降级"></a>数组降级</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将一个层次的数据结构，转换为平行的父子数据结构</span></span><br><span class="line"><span class="comment"> * @param nodesArray</span></span><br><span class="line"><span class="comment"> * @returns &#123;*&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">array2Nodes</span>(<span class="params">nodesArray</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> i, l,</span><br><span class="line">        key = <span class="string">"id"</span>,</span><br><span class="line">        parentKey = <span class="string">"pId"</span>,</span><br><span class="line">        childKey = <span class="string">"sub_button"</span>;</span><br><span class="line">    <span class="keyword">if</span> (!key || key == <span class="string">""</span> || !nodesArray) <span class="keyword">return</span> [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (nodesArray <span class="keyword">instanceof</span> <span class="built_in">Array</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> r = [];</span><br><span class="line">        <span class="keyword">var</span> tmpMap = &#123;&#125;;</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>, l = nodesArray.length; i &lt; l; i++) &#123;</span><br><span class="line">            tmpMap[nodesArray[i][key]] = nodesArray[i];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>, l = nodesArray.length; i &lt; l; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (tmpMap[nodesArray[i][parentKey]] &amp;&amp; nodesArray[i][key] != nodesArray[i][parentKey]) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!tmpMap[nodesArray[i][parentKey]][childKey])</span><br><span class="line">                    tmpMap[nodesArray[i][parentKey]][childKey] = [];</span><br><span class="line">                tmpMap[nodesArray[i][parentKey]][childKey].push(nodesArray[i]);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                r.push(nodesArray[i]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> [nodesArray];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>array2Nodes将带有子节点的数据展开，变成平级的一维数组</p>
<h2 id="维度提升"><a href="#维度提升" class="headerlink" title="维度提升"></a>维度提升</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将平行父子数据结构转为层次结构</span></span><br><span class="line"><span class="comment"> * @param nodes</span></span><br><span class="line"><span class="comment"> * @returns &#123;Array&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">nodes2Array</span>(<span class="params">nodes</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!nodes) <span class="keyword">return</span> [];</span><br><span class="line">    <span class="keyword">var</span> childKey = <span class="string">"sub_button"</span>,</span><br><span class="line">        r = [];</span><br><span class="line">    <span class="keyword">if</span> (nodes <span class="keyword">instanceof</span> <span class="built_in">Array</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, l = nodes.length; i &lt; l; i++) &#123;</span><br><span class="line">            r.push(nodes[i]);</span><br><span class="line">            <span class="keyword">if</span> (nodes[i][childKey])</span><br><span class="line">                r = r.concat(nodes2Array(nodes[i][childKey]));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        r.push(nodes);</span><br><span class="line">        <span class="keyword">if</span> (nodes[childKey])</span><br><span class="line">            r = r.concat(nodes2Array(nodes[childKey]));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>nodes2Array按照指定的key生成自包含的数组，这里是微信的sub_button(其他场景可以自定义key)。</p>
<p>##　测试<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> menuArray = [&#123;</span><br><span class="line">    <span class="string">"id"</span>: <span class="string">"AE9CB92989FFB1523D8C63C3124AB372F074F8898BE7B930FABCE06BF60CB237"</span>,</span><br><span class="line">    <span class="string">"pId"</span>: <span class="string">"-1"</span>,</span><br><span class="line">    <span class="string">"key"</span>: <span class="string">"4C0F11D31571F75A00F620C82E5847E89837FDD758C5027E4D1DDFE959697F85"</span>,</span><br><span class="line">    <span class="string">"url"</span>: <span class="string">"http://"</span>,</span><br><span class="line">    <span class="string">"media_id"</span>: <span class="string">"null"</span>,</span><br><span class="line">    <span class="string">"name"</span>: <span class="string">"菜单名称"</span>,</span><br><span class="line">    <span class="string">"type"</span>: <span class="string">"view"</span>,</span><br><span class="line">    <span class="string">"orderId"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">"msgText"</span>: <span class="string">"null"</span></span><br><span class="line">&#125;, &#123;</span><br><span class="line">    <span class="string">"id"</span>: <span class="string">"FD5C1B24A580DB7DE7F472736B7A06277FE8C17BB8739F9D3BE2B19D866C8470"</span>,</span><br><span class="line">    <span class="string">"pId"</span>: <span class="string">"-1"</span>,</span><br><span class="line">    <span class="string">"key"</span>: <span class="string">"909CE8ADA256BEEE2E37A78C0CDD823B273B04C60F797A537EC174A0377D7B8C"</span>,</span><br><span class="line">    <span class="string">"url"</span>: <span class="string">"null"</span>,</span><br><span class="line">    <span class="string">"media_id"</span>: <span class="string">"null"</span>,</span><br><span class="line">    <span class="string">"name"</span>: <span class="string">"菜单名称"</span>,</span><br><span class="line">    <span class="string">"type"</span>: <span class="string">"click"</span>,</span><br><span class="line">    <span class="string">"orderId"</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="string">"msgText"</span>: <span class="string">"null"</span></span><br><span class="line">&#125;, &#123;</span><br><span class="line">    <span class="string">"id"</span>: <span class="string">"324703D728232820DE9A8305D183B3289AE708DBBF4B8F4D044F7BC9714B7F80"</span>,</span><br><span class="line">    <span class="string">"pId"</span>: <span class="string">"FD5C1B24A580DB7DE7F472736B7A06277FE8C17BB8739F9D3BE2B19D866C8470"</span>,</span><br><span class="line">    <span class="string">"key"</span>: <span class="string">"C9B73D24A5EAD91772CFEC5BD129B7EB2C2A9A96E3EF743BAF54B53E29758837"</span>,</span><br><span class="line">    <span class="string">"url"</span>: <span class="string">"null"</span>,</span><br><span class="line">    <span class="string">"media_id"</span>: <span class="string">"null"</span>,</span><br><span class="line">    <span class="string">"name"</span>: <span class="string">"菜单名称"</span>,</span><br><span class="line">    <span class="string">"type"</span>: <span class="string">"click"</span>,</span><br><span class="line">    <span class="string">"orderId"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">"msgText"</span>: <span class="string">"null"</span></span><br><span class="line">&#125;, &#123;</span><br><span class="line">    <span class="string">"id"</span>: <span class="string">"00DB54295F5A87248BEE3B7160C217066A6CE77C00B9EC2A415CE15898390425"</span>,</span><br><span class="line">    <span class="string">"pId"</span>: <span class="string">"AE9CB92989FFB1523D8C63C3124AB372F074F8898BE7B930FABCE06BF60CB237"</span>,</span><br><span class="line">    <span class="string">"key"</span>: <span class="string">"05810B96BBDC28AAB99EBC69E70F9196C42434A042C0468F6A8DDB0875D22972"</span>,</span><br><span class="line">    <span class="string">"url"</span>: <span class="string">"null"</span>,</span><br><span class="line">    <span class="string">"media_id"</span>: <span class="string">"null"</span>,</span><br><span class="line">    <span class="string">"name"</span>: <span class="string">"菜单名称"</span>,</span><br><span class="line">    <span class="string">"type"</span>: <span class="string">"click"</span>,</span><br><span class="line">    <span class="string">"orderId"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">"msgText"</span>: <span class="string">"null"</span></span><br><span class="line">&#125;, &#123;</span><br><span class="line">    <span class="string">"id"</span>: <span class="string">"547B7E126D694B4DC9B831951B3F5A2A378ED4AA0DA9955C088A076F865BC1B1"</span>,</span><br><span class="line">    <span class="string">"pId"</span>: <span class="string">"AE9CB92989FFB1523D8C63C3124AB372F074F8898BE7B930FABCE06BF60CB237"</span>,</span><br><span class="line">    <span class="string">"key"</span>: <span class="string">"4EA0242BE5E66E90FB7931B804472DE68CE17D46817CD699F38E21903B1DEAE6"</span>,</span><br><span class="line">    <span class="string">"url"</span>: <span class="string">"null"</span>,</span><br><span class="line">    <span class="string">"media_id"</span>: <span class="string">"null"</span>,</span><br><span class="line">    <span class="string">"name"</span>: <span class="string">"菜单名称"</span>,</span><br><span class="line">    <span class="string">"type"</span>: <span class="string">"click"</span>,</span><br><span class="line">    <span class="string">"orderId"</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="string">"msgText"</span>: <span class="string">"null"</span></span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> nodes = array2Nodes(menuArray);</span><br><span class="line"><span class="built_in">console</span>.log(array2Nodes(nodes));</span><br><span class="line"><span class="built_in">console</span>.log(nodes2Array(nodes));</span><br></pre></td></tr></table></figure></p>
<p>在控制台的输出如下：<br><img src="/upload/images/javascript-tree-data/result.png" alt="img"></p>
<h2 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h2><p>在后台管理系统中树的操作是很频繁的，一般在后台查询采用递归，而这样往往逻辑复杂不易维护。比如要展示一颗部门的树，我们先定义个Unit类：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by gongxufan on 2017/3/13.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table</span>(name=<span class="string">"tcUnit"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Unit</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue</span>(strategy = GenerationType.TABLE, generator = <span class="string">"tableKeyGenerator"</span>)</span><br><span class="line">    <span class="meta">@TableGenerator</span>(name = <span class="string">"tableKeyGenerator"</span>, table = <span class="string">"tcTableKeyGenerator"</span>,</span><br><span class="line">            pkColumnName = <span class="string">"pk_key"</span>, valueColumnName = <span class="string">"pk_value"</span>, pkColumnValue = <span class="string">"unitID"</span>,</span><br><span class="line">            initialValue = <span class="number">1</span>, allocationSize = <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">private</span> Integer unitID;</span><br><span class="line">    <span class="keyword">private</span> Integer seniorUnitID;</span><br><span class="line">    <span class="keyword">private</span> String unitName;</span><br><span class="line">    <span class="keyword">private</span> String description;</span><br><span class="line">    <span class="keyword">private</span> Integer displayOrder;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getUnitID</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> unitID;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUnitID</span><span class="params">(Integer unitID)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.unitID = unitID;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getSeniorUnitID</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> seniorUnitID;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSeniorUnitID</span><span class="params">(Integer seniorUnitID)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.seniorUnitID = seniorUnitID;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUnitName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> unitName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUnitName</span><span class="params">(String unitName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.unitName = unitName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getDescription</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> description;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDescription</span><span class="params">(String description)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.description = description;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getDisplayOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> displayOrder;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDisplayOrder</span><span class="params">(Integer displayOrder)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.displayOrder = displayOrder;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>里边的注解大可不必在意，那是spring-data-jpa的一些注解。这是经典的自包含结构，一个unitID再来一个 seniorUnitID在指向父节点。这个是业务节点，然后咱们定义一个easyUI树所需的节点数据结构。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TreeNode</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">    <span class="keyword">private</span> String  pId;</span><br><span class="line">    <span class="keyword">private</span> String text;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> checked;</span><br><span class="line">    <span class="keyword">private</span> String state;</span><br><span class="line">    <span class="keyword">private</span> String iconCls;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> type;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String,Object&gt; attributes;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">getAttributes</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> attributes;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAttributes</span><span class="params">(Map&lt;String, Object&gt; attributes)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.attributes = attributes;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setType</span><span class="params">(<span class="keyword">int</span> type)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.type = type;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getpId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> pId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setpId</span><span class="params">(String pId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.pId = pId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> type;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getText</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> text;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setText</span><span class="params">(String text)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.text = text;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isChecked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> checked;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setChecked</span><span class="params">(<span class="keyword">boolean</span> checked)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.checked = checked;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> state;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setState</span><span class="params">(String state)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.state = state;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getIconCls</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> iconCls;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setIconCls</span><span class="params">(String iconCls)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.iconCls = iconCls;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>里边包含id,pId以及树节点的基本信息，显然前端展示所需的数据需要从Unit结构进行一次转换。现在我们需要展示所有单位的树形结构，那么我们只需要查询所有的Unit记录保存到List，然后将这个List转换为TreeNode类型即可：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/unit/getUnitTree"</span>,method = RequestMethod.POST)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getUnitTree</span><span class="params">(Integer humanId,Integer fetchHumans, Integer fetchWhole,HttpServletRequest request)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(humanId == <span class="keyword">null</span>)&#123;</span><br><span class="line">        humanId = EgovaWebUtil.getHumanInSession(request).getHumanID();</span><br><span class="line">    &#125;</span><br><span class="line">    List&lt;TreeNode&gt; treeNodes = <span class="keyword">new</span> ArrayList&lt;TreeNode&gt;();</span><br><span class="line">    ResultDto&lt;List&lt;Unit&gt;&gt; resultDto =  humanAction.getHumanUnitTree(humanId,fetchWhole);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(ApiInvokeUtil.validateAPiInvoke(resultDto))&#123;</span><br><span class="line">        List&lt;Unit&gt; unitList = resultDto.getData();</span><br><span class="line">        <span class="comment">//将单位列表转换为easyUI树形结构所需的格式</span></span><br><span class="line">        <span class="keyword">if</span>(unitList != <span class="keyword">null</span> &amp;&amp; unitList.size() &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; unitList.size();i++)&#123;</span><br><span class="line">                TreeNode treeNode = <span class="keyword">new</span> TreeNode();</span><br><span class="line">                Unit unit = unitList.get(i);</span><br><span class="line">                treeNode.setText(unit.getUnitName());</span><br><span class="line">                treeNode.setChecked(<span class="keyword">false</span>);</span><br><span class="line">                treeNode.setId(<span class="string">"unit:"</span> + unit.getUnitID());</span><br><span class="line">                treeNode.setIconCls(TreeNodeConst.NODE_ICON_UNIT);</span><br><span class="line">                treeNode.setType(TreeNodeConst.NODE_TYPE_UNIT);</span><br><span class="line">                treeNode.setState(<span class="string">"open"</span>);</span><br><span class="line">                treeNode.setpId(<span class="string">"unit:"</span> + unit.getSeniorUnitID());</span><br><span class="line">                Map&lt;String,Object&gt; attrs = ObjectUtil.Object2Map(unit);</span><br><span class="line">                attrs.put(<span class="string">"nodeType"</span>,TreeNodeConst.NODE_TYPE_UNIT);</span><br><span class="line">                treeNode.setAttributes(attrs);</span><br><span class="line">                treeNodes.add(treeNode);</span><br><span class="line">                <span class="comment">//查询单位下的人员</span></span><br><span class="line">                <span class="keyword">if</span>(fetchHumans == <span class="keyword">null</span>)</span><br><span class="line">                    dealHumansInUnit(unit,treeNodes);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> resultDto;</span><br><span class="line">    &#125;</span><br><span class="line">    ResultDto&lt;List&lt;TreeNode&gt;&gt; treeNodesDTO = <span class="keyword">new</span> ResultDto&lt;List&lt;TreeNode&gt;&gt;();</span><br><span class="line">    treeNodesDTO.setData(treeNodes);</span><br><span class="line">    treeNodesDTO.setCode(ErrorCode.OK.getCode());</span><br><span class="line">    treeNodesDTO.setDesc(ErrorCode.OK.getDesc());</span><br><span class="line">    <span class="keyword">return</span> treeNodesDTO;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里是springmvc的控制器的业务处理逻辑了，这里包含对单位下人员的子节点的构造。不管里面的业务，最终目的就是生成树节点的一个List结构。</p>
<p>后台就干这么个事儿，不用去递归生成一个TreeNode(TreeNode parent)这样的自包含数据。递归结构交给Js去做，前端只需用array2Nodes函数进行转换即可：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">$.post(BASEPATH + <span class="string">'/config/unit/getUnitTree'</span>,<span class="function"><span class="keyword">function</span> (<span class="params">response</span>) </span>&#123;</span><br><span class="line">          <span class="keyword">if</span>(common.dealResponse(response))&#123;</span><br><span class="line">              <span class="comment">//转换List为树形结构</span></span><br><span class="line">              <span class="keyword">var</span> nodes = common.array2Nodes(response.data);</span><br><span class="line">              <span class="comment">//加载部门树</span></span><br><span class="line">              $(<span class="string">'#unit-tree'</span>).tree(&#123;</span><br><span class="line">                  data : nodes,</span><br><span class="line">                  onClick : <span class="function"><span class="keyword">function</span>(<span class="params">node</span>)</span>&#123;</span><br><span class="line">                      <span class="comment">//获取节点对应的目录属性信息</span></span><br><span class="line">                      <span class="keyword">var</span> attributes = node.attributes;</span><br><span class="line">                      <span class="keyword">if</span> (attributes) &#123;</span><br><span class="line">                          <span class="comment">//根据单位节点和人员节点显示不同的面板</span></span><br><span class="line">                          <span class="keyword">if</span>(attributes.nodeType == common.constant.NODE_TYPE_UNIT)&#123;</span><br><span class="line">                              $(<span class="string">"#unitPanel"</span>).show();</span><br><span class="line">                              $(<span class="string">"#humanPanel"</span>).hide();</span><br><span class="line">                              $(<span class="string">"#unitForm"</span>).form(<span class="string">'load'</span>,attributes);</span><br><span class="line">                          &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                              $(<span class="string">"#humanPanel"</span>).show();</span><br><span class="line">                              $(<span class="string">"#unitPanel"</span>).hide();</span><br><span class="line">                              $(<span class="string">"#humanForm"</span>).form(<span class="string">'load'</span>,attributes);</span><br><span class="line">                          &#125;</span><br><span class="line">                      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                          $(<span class="string">"#unitPanel"</span>).hide();</span><br><span class="line">                          $(<span class="string">"#humanPanel"</span>).hide();</span><br><span class="line">                      &#125;</span><br><span class="line">                  &#125;,</span><br><span class="line">                  onLoadSuccess: <span class="function"><span class="keyword">function</span> (<span class="params">node</span>) </span>&#123;</span><br><span class="line">                      <span class="keyword">var</span> $tree = $(<span class="keyword">this</span>);</span><br><span class="line">                      <span class="keyword">var</span> root = $tree.tree(<span class="string">'getRoot'</span>);</span><br><span class="line">                      <span class="keyword">var</span> treeNodes = $tree.tree(<span class="string">'getChildren'</span>);</span><br><span class="line">                      <span class="keyword">var</span> root = treeNodes[<span class="number">0</span>];</span><br><span class="line">                      $(root.target).trigger(<span class="string">'click'</span>);</span><br><span class="line">                      <span class="comment">// 展开该节点</span></span><br><span class="line">                      $tree.tree(<span class="string">'expand'</span>, root.target);</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;);</span><br></pre></td></tr></table></figure></p>
<h2 id="end"><a href="#end" class="headerlink" title="end"></a>end</h2><p>在如今js大前端大行其道加之客户端浏览器性能得到改善的情况，把一些计算任务交给客户端，能减少服务端的访问压力。</p>
]]></content>
      
        <categories>
            
            <category> 随笔 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> javascript </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[基于Jtopo的网络拓扑编辑器初探]]></title>
      <url>/2016/12/07/topology-editor/</url>
      <content type="html"><![CDATA[<h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><p>本文实现了基于Jtopo的在线网络拓扑设计和编辑，可以创建复杂网络并对网络和设备进行各种操作，提供拓扑的序列化和反序列操作。</p>
<p>为了方便演示，我已经把一个静态DEMO部署到github，<a href="https://gongxufan.github.io/web-topology/topologyEditor.html">传送门</a></p>
<p>关于项目访问,因为读取远程json数据,直接用浏览器打开会有安全限制.请将项目放到tomcat启动访问或者直接用idea/webstorm打开项目直接右键打开,如下图所示:<br><img src="/upload/images/topology/how-to-open.png" alt="img"></p>
<p>完整代码单独放到了github：<a href="https://github.com/gongxufan/web-topology" target="_blank" rel="external">https://github.com/gongxufan/web-topology</a></p>
<h2 id="功能简介"><a href="#功能简介" class="headerlink" title="功能简介"></a>功能简介</h2><p>基本的操作可以看下面的GIF图，节点从左边图标栏拖拽至编辑区，通过单击节点图标，然后松开鼠标按键则可拖动一条连线。在目标节点单击，怎完成一次连线操作。左栏可以选择多种连线方式。<br><img src="/upload/images/topology/demo.gif" alt="img"></p>
<p>这个拓扑编辑器UI是easyUI做的布局，节点的编辑和连线则是基于jTopo二次开发的。jTopo提供了Stage、Scene、Node、Container以及对动画的支持，API使用相对简单易用。缺点是文档缺乏，但是我们可以通过作者提供的DEMO进行熟悉。一旦熟悉其源码，则十分便于二次开发。用来实现一些动画也是轻而易举的。由于是基于canvas的绘画，所以每次更改和操作其实都会重绘整个画布。当中还是有不少可以优化的地方。其实想D3.js也可以走到这样的效果，只是近期工作都在后端就没去探究了。<br>由于只是摘取个人开发项目的前端部分，由于公司许可原因只能开发这一部分了，有兴趣的可以去我的github上clone下来参考。核心部分代码都在editor.js，提供了节点拖拽、节点连线、布局等方法支持。这个是一个初始版本。代码粗糙，仅供参考。<br>下面摘取几个重要的地方稍微讲解：</p>
<h3 id="编辑器初始化代码"><a href="#编辑器初始化代码" class="headerlink" title="编辑器初始化代码"></a>编辑器初始化代码</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建JTOP舞台屏幕对象  </span></span><br><span class="line">   <span class="keyword">var</span> canvas = <span class="built_in">document</span>.getElementById(<span class="string">'drawCanvas'</span>);  </span><br><span class="line">   canvas.width = $(<span class="string">"#contextBody"</span>).width();  </span><br><span class="line">   canvas.height = $(<span class="string">"#contextBody"</span>).height();  </span><br><span class="line">   <span class="comment">//加载空白的编辑器  </span></span><br><span class="line">   <span class="keyword">if</span>(stageJson == <span class="string">"-1"</span>)&#123;  </span><br><span class="line">       <span class="keyword">this</span>.stage = <span class="keyword">new</span> JTopo.Stage(canvas);  </span><br><span class="line">       <span class="keyword">this</span>.stage.topoLevel = <span class="number">1</span>;  </span><br><span class="line">       <span class="keyword">this</span>.stage.parentLevel = <span class="number">0</span>;  </span><br><span class="line">       <span class="keyword">this</span>.modeIdIndex = <span class="number">1</span>;  </span><br><span class="line">       <span class="keyword">this</span>.scene=  <span class="keyword">new</span> JTopo.Scene(<span class="keyword">this</span>.stage);  </span><br><span class="line">       <span class="keyword">this</span>.scene.totalLevel = <span class="number">1</span>;  </span><br><span class="line">   &#125;<span class="keyword">else</span>&#123;  </span><br><span class="line">       <span class="keyword">this</span>.stage = JTopo.createStageFromJson(stageJson, canvas);  </span><br><span class="line">       <span class="keyword">this</span>.scene = <span class="keyword">this</span>.stage.childs[<span class="number">0</span>];  </span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>我们可以调用JTopo.Stage(canvas)来初始化一个画图区域，接下来就可以使用API进行节点和动画的操作了。整个画图对象的JSON层次结构如下所示：<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">&#123;  </span><br><span class="line">  <span class="attr">"version"</span>: <span class="string">"0.4.8"</span>,  </span><br><span class="line">  <span class="attr">"deviceNum"</span>: <span class="string">"19"</span>,  </span><br><span class="line">  <span class="attr">"wheelZoom"</span>: <span class="number">0.95</span>,  </span><br><span class="line">  <span class="attr">"width"</span>: <span class="number">864</span>,  </span><br><span class="line">  <span class="attr">"height"</span>: <span class="number">569</span>,  </span><br><span class="line">  <span class="attr">"id"</span>: <span class="string">"ST172.19.105.52015100809430700001"</span>,  </span><br><span class="line">  <span class="attr">"topoLevel"</span>: <span class="string">"1"</span>,  </span><br><span class="line">  <span class="attr">"parentLevel"</span>: <span class="string">"0"</span>,  </span><br><span class="line">  <span class="attr">"nextLevel"</span>: <span class="string">"0"</span>,  </span><br><span class="line">  <span class="attr">"childs"</span>: [  </span><br><span class="line">    &#123;  </span><br><span class="line">      <span class="attr">"elementType"</span>: <span class="string">"scene"</span>,  </span><br><span class="line">      <span class="attr">"id"</span>: <span class="string">"S172.19.105.52015100809430700002"</span>,  </span><br><span class="line">      <span class="attr">"topoLevel"</span>: <span class="string">"1"</span>,  </span><br><span class="line">      <span class="attr">"parentLevel"</span>: <span class="string">"0"</span>,  </span><br><span class="line">      <span class="attr">"nextLevel"</span>: <span class="string">"0"</span>,  </span><br><span class="line">      <span class="attr">"translateX"</span>: <span class="number">106.5</span>,  </span><br><span class="line">      <span class="attr">"translateY"</span>: <span class="number">20</span>,  </span><br><span class="line">      <span class="attr">"scaleX"</span>: <span class="number">1</span>,  </span><br><span class="line">      <span class="attr">"scaleY"</span>: <span class="number">1</span>,  </span><br><span class="line">      <span class="attr">"totalLevel"</span>: <span class="string">"1"</span>,  </span><br><span class="line">      <span class="attr">"childs"</span>: [  </span><br><span class="line">        &#123;  </span><br><span class="line">          <span class="attr">"elementType"</span>: <span class="string">"node"</span>,  </span><br><span class="line">          <span class="attr">"id"</span>: <span class="string">""</span>,  </span><br><span class="line">          <span class="attr">"topoLevel"</span>: <span class="number">1</span>,  </span><br><span class="line">          <span class="attr">"parentLevel"</span>: <span class="string">"0"</span>,  </span><br><span class="line">          <span class="attr">"nextLevel"</span>: <span class="string">"0"</span>,  </span><br><span class="line">          <span class="attr">"x"</span>: <span class="number">211.5</span>,  </span><br><span class="line">          <span class="attr">"y"</span>: <span class="number">135</span>,  </span><br><span class="line">          <span class="attr">"width"</span>: <span class="number">32</span>,  </span><br><span class="line">          <span class="attr">"height"</span>: <span class="number">32</span>,  </span><br><span class="line">          <span class="attr">"visible"</span>: <span class="literal">true</span>,  </span><br><span class="line">          <span class="attr">"rotate"</span>: <span class="number">0</span>,  </span><br><span class="line">          <span class="attr">"scaleX"</span>: <span class="number">1</span>,  </span><br><span class="line">          <span class="attr">"scaleY"</span>: <span class="number">1</span>,  </span><br><span class="line">          <span class="attr">"zIndex"</span>: <span class="number">3</span>,  </span><br><span class="line">          <span class="attr">"deviceId"</span>: <span class="string">"1404683827351.4666"</span>,  </span><br><span class="line">          <span class="attr">"dataType"</span>: <span class="string">"VR"</span>,  </span><br><span class="line">          <span class="attr">"nodeImage"</span>: <span class="string">"tpIcon_9.png"</span>,  </span><br><span class="line">          <span class="attr">"text"</span>: <span class="string">"CS路由器"</span>,  </span><br><span class="line">          <span class="attr">"textPosition"</span>: <span class="string">"Bottom_Center"</span>,  </span><br><span class="line">          <span class="attr">"templateId"</span>: undefined  </span><br><span class="line">        &#125;  </span><br><span class="line">      ]  </span><br><span class="line">    &#125;  </span><br><span class="line">  ]  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>其结构为：<br><img src="/upload/images/topology/json.png" alt="img"></p>
<p>通常我们只需要一个 Scene对象即可管理所有的对象，当然如果要实现更复杂的分组对象管理则可以创建多个Scene对象进行单独管理。同时我们可以调用JTopo.createStageFromJson(stageJson, canvas)方法来讲一个保存好的拓扑结构重新渲染。</p>
<h3 id="节点的拖拽"><a href="#节点的拖拽" class="headerlink" title="节点的拖拽"></a>节点的拖拽</h3><p>节点的拖拽使用的原生H5的drag&amp;drop来实现<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * 图元拖放功能实现 </span></span><br><span class="line"><span class="comment"> * @param modeDiv </span></span><br><span class="line"><span class="comment"> * @param drawArea </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line">networkTopologyEditor.prototype.drag = <span class="function"><span class="keyword">function</span> (<span class="params">modeDiv, drawArea, text</span>) </span>&#123;  </span><br><span class="line">    <span class="keyword">if</span> (!text) text = <span class="string">""</span>;  </span><br><span class="line">    <span class="keyword">var</span> self = <span class="keyword">this</span>;  </span><br><span class="line">    <span class="comment">//拖拽开始,携带必要的参数  </span></span><br><span class="line">    modeDiv.ondragstart = <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;  </span><br><span class="line">        e = e || <span class="built_in">window</span>.event;  </span><br><span class="line">        <span class="keyword">var</span> dragSrc = <span class="keyword">this</span>;  </span><br><span class="line">        <span class="keyword">var</span> backImg = $(dragSrc).find(<span class="string">"img"</span>).eq(<span class="number">0</span>).attr(<span class="string">"src"</span>);  </span><br><span class="line">        backImg = backImg.substring(backImg.lastIndexOf(<span class="string">'/'</span>) + <span class="number">1</span>);  </span><br><span class="line">        <span class="keyword">var</span> datatype = $(<span class="keyword">this</span>).attr(<span class="string">"datatype"</span>);  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="comment">//IE只允许KEY为text和URL  </span></span><br><span class="line">            e.dataTransfer.setData(<span class="string">'text'</span>, backImg + <span class="string">";"</span> + text + <span class="string">";"</span> + datatype);  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (ex) &#123;  </span><br><span class="line">            <span class="built_in">console</span>.log(ex);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;;  </span><br><span class="line">    <span class="comment">//阻止默认事件  </span></span><br><span class="line">    drawArea.ondragover = <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;  </span><br><span class="line">        e.preventDefault();  </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;  </span><br><span class="line">    &#125;;  </span><br><span class="line">    <span class="comment">//创建节点  </span></span><br><span class="line">    drawArea.ondrop = <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;  </span><br><span class="line">        e = e || <span class="built_in">window</span>.event;  </span><br><span class="line">        <span class="keyword">var</span> data = e.dataTransfer.getData(<span class="string">"text"</span>);  </span><br><span class="line">        <span class="keyword">var</span> img, text,datatype;  </span><br><span class="line">        <span class="keyword">if</span> (data) &#123;  </span><br><span class="line">            <span class="keyword">var</span> datas = data.split(<span class="string">";"</span>);  </span><br><span class="line">            <span class="keyword">if</span> (datas &amp;&amp; datas.length == <span class="number">3</span>) &#123;  </span><br><span class="line">                img = datas[<span class="number">0</span>];  </span><br><span class="line">                text = datas[<span class="number">1</span>];  </span><br><span class="line">                datatype = datas[<span class="number">2</span>];  </span><br><span class="line">                <span class="keyword">var</span> node = <span class="keyword">new</span> JTopo.Node();  </span><br><span class="line">                node.fontColor = self.config.nodeFontColor;  </span><br><span class="line">                node.setBound((e.layerX ? e.layerX : e.offsetX) - self.scene.translateX - self.config.defaultWidth / <span class="number">2</span>, (e.layerY ? e.layerY : e.offsetY) - self.scene.translateY - self.config.defaultHeight / <span class="number">2</span>,self.config.defaultWidth,self.config.defaultHeight);  </span><br><span class="line">                <span class="comment">//设备图片  </span></span><br><span class="line">                node.setImage(context + <span class="string">'post/web-topology/icon/'</span> + img);  </span><br><span class="line">                <span class="comment">//var cuurId = "device" + (++self.modeIdIndex);  </span></span><br><span class="line">                <span class="keyword">var</span> cuurId = <span class="string">""</span> + <span class="keyword">new</span> <span class="built_in">Date</span>().getTime() * <span class="built_in">Math</span>.random();  </span><br><span class="line">                node.deviceId = cuurId;  </span><br><span class="line">                node.dataType = datatype;  </span><br><span class="line">                node.nodeImage = img;  </span><br><span class="line">                ++self.modeIdIndex;  </span><br><span class="line">                node.text = text;  </span><br><span class="line">                node.layout = self.layout;  </span><br><span class="line">                <span class="comment">//节点所属层次  </span></span><br><span class="line">                node.topoLevel = <span class="built_in">parseInt</span>($(<span class="string">"#selectLevel"</span>).find(<span class="string">"option:selected"</span>).val());  </span><br><span class="line">                <span class="comment">//节点所属父层次  </span></span><br><span class="line">                node.parentLevel = $(<span class="string">"#parentLevel"</span>).val();  </span><br><span class="line">                <span class="comment">//子网连接点的下一个层,默认为0  </span></span><br><span class="line">                node.nextLevel = <span class="string">"0"</span>;  </span><br><span class="line">                self.scene.add(node);  </span><br><span class="line">  </span><br><span class="line">                <span class="comment">//加载属性面板  </span></span><br><span class="line">                <span class="comment">/* if(self.currDataType) </span></span><br><span class="line"><span class="comment">                 self.clearOldPanels(self.currDataType) </span></span><br><span class="line"><span class="comment">                 self.currDeviceId = cuurId; </span></span><br><span class="line"><span class="comment">                 self.createNewPanels(datatype,self.templateId,self.currentModeId);*/</span>  </span><br><span class="line">                <span class="comment">//self.currDataType = datatype;  </span></span><br><span class="line">                self.currentNode = node;  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">if</span> (e.preventDefault()) &#123;  </span><br><span class="line">            e.preventDefault();  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">if</span> (e.stopPropagation()) &#123;  </span><br><span class="line">            e.stopPropagation();  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在ondragstart回调方法中传递底图以及必要参数，然后在ondrop进行节点的创建新建节点使用JTopo.Node()构造，设置好相关属性然后通过scene.add(node)加入到Stage。为何执行add操作在界面上就可以看到新的节点了呢？</p>
<p>原因是Stage有一个frames属性，它定义了画布重绘频率1000/frames</p>
<h4 id="frames属性"><a href="#frames属性" class="headerlink" title="frames属性"></a>frames属性</h4><p>设置当前舞台播放的帧数/秒</p>
<p>默认为:24</p>
<p>frames可以为0，表示：不自动绘制，由用户手工调用Stage对象的paint()方法来触发。</p>
<p>如果小于0意味着：只有键盘、鼠标有动作时才会重绘，例如：stage.frames = -24。</p>
<p>默认画面帧数为24帧，也就是每1000/24ms就会重绘屏幕。后台刷新的代码如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;  </span><br><span class="line">             <span class="number">0</span> == stage.frames ? setTimeout(<span class="built_in">arguments</span>.callee, <span class="number">100</span>) : stage.frames &lt; <span class="number">0</span> ? (stage.repaint(),  </span><br><span class="line">                        setTimeout(<span class="built_in">arguments</span>.callee, <span class="number">1e3</span> / -stage.frames)) : (stage.repaint(),  </span><br><span class="line">                        setTimeout(<span class="built_in">arguments</span>.callee, <span class="number">1e3</span> / stage.frames))  </span><br><span class="line">        &#125; ()</span><br></pre></td></tr></table></figure></p>
<p>setTimeout会调用下面的重绘函数，<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.paint = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;  </span><br><span class="line">      <span class="literal">null</span>  != <span class="keyword">this</span>.canvas &amp;&amp; (<span class="keyword">this</span>.graphics.save(),  </span><br><span class="line">          <span class="keyword">this</span>.graphics.clearRect(<span class="number">0</span>, <span class="number">0</span>, <span class="keyword">this</span>.width, <span class="keyword">this</span>.height),  </span><br><span class="line">          <span class="keyword">this</span>.childs.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">a</span>) </span>&#123;  </span><br><span class="line">                  <span class="number">1</span> == a.visible &amp;&amp; a.repaint(stage.graphics)  </span><br><span class="line">              &#125;  </span><br><span class="line">          ),  </span><br><span class="line">      <span class="number">1</span> == <span class="keyword">this</span>.eagleEye.visible &amp;&amp; <span class="keyword">this</span>.eagleEye.paint(<span class="keyword">this</span>),  </span><br><span class="line">          <span class="keyword">this</span>.graphics.restore())  </span><br><span class="line">  &#125;  </span><br><span class="line">  ,  </span><br><span class="line">  <span class="keyword">this</span>.repaint = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;  </span><br><span class="line">      <span class="number">0</span> != <span class="keyword">this</span>.frames &amp;&amp; (<span class="keyword">this</span>.frames &lt; <span class="number">0</span> &amp;&amp; <span class="number">0</span> == <span class="keyword">this</span>.needRepaint || (<span class="keyword">this</span>.paint(),  </span><br><span class="line">      <span class="keyword">this</span>.frames &lt; <span class="number">0</span> &amp;&amp; (<span class="keyword">this</span>.needRepaint = !<span class="number">1</span>)))  </span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>paint对遍历所有可见对象 ，依次调用repaint方法。</p>
<h3 id="节点连线"><a href="#节点连线" class="headerlink" title="节点连线"></a>节点连线</h3><p>这里采用的连线方法是在节点按下鼠标左键，然后松开鼠标则创建一个连线，起点是被点击的节点，终点则随鼠标移动而动态更新。因此单机一个节点松开鼠标则可以看到随鼠标移动的一条连线。然后在某个节点点击左键松开怎完成了两个节点的连线。效果如下：<br><img src="/upload/images/topology/line.gif" alt="img"></p>
<p>部分代码实现如下：<br><img src="/upload/images/topology/code.png" alt="img"></p>
<p>jTopo支持支线、折线、曲线等的常见，但是折线的拐角处长度现在只能在创建的时候指定。如需动态的秒点创建需要二次开发。代码如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(self.lineType == <span class="string">"line"</span>)&#123;</span><br><span class="line">    self.link = <span class="keyword">new</span> JTopo.Link(self.tempNodeA, self.tempNodeZ);</span><br><span class="line">    self.link.lineType = <span class="string">"line"</span>;</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(self.lineType == <span class="string">"foldLine"</span>)&#123;</span><br><span class="line">    self.link = <span class="keyword">new</span> JTopo.FoldLink(self.tempNodeA, self.tempNodeZ);</span><br><span class="line">    self.link.lineType = <span class="string">"foldLine"</span>;</span><br><span class="line">    self.link.direction =  self.config.direction;</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(self.lineType == <span class="string">"flexLine"</span>)&#123;</span><br><span class="line">    self.link = <span class="keyword">new</span> JTopo.FlexionalLink(self.tempNodeA, self.tempNodeZ);</span><br><span class="line">    self.link.direction =  self.config.direction;</span><br><span class="line">    self.link.lineType = <span class="string">"flexLine"</span>;</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(self.lineType == <span class="string">"curveLine"</span>)&#123;</span><br><span class="line">    self.link = <span class="keyword">new</span> JTopo.CurveLink(self.tempNodeA, self.tempNodeZ);</span><br><span class="line">    self.link.lineType = <span class="string">"curveLine"</span>;</span><br><span class="line">&#125;  xxxxx</span><br></pre></td></tr></table></figure></p>
<h2 id="关于拓扑的保存和加载"><a href="#关于拓扑的保存和加载" class="headerlink" title="关于拓扑的保存和加载"></a>关于拓扑的保存和加载</h2><p>因为本文只是拓扑编辑器的前端，后端部分因为商业限制原因暂未开源。而且因为整体项目很大，单独剥离也不容易。其实我们只要知道拓扑的加载和保存逻辑，实现拓扑结构的序列化操作也是很简单的。下面占用一个篇幅集中讨论：</p>
<h3 id="加载现有的拓扑图"><a href="#加载现有的拓扑图" class="headerlink" title="加载现有的拓扑图"></a>加载现有的拓扑图</h3><p>现在我们拥有一个拓扑结构，也就是文本传送门地址所展示的拓扑图，其序列化结构如下：<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"errorInfo"</span>: <span class="string">"ok"</span>,</span><br><span class="line">  <span class="attr">"topologyJson"</span>: &#123;</span><br><span class="line">    <span class="attr">"version"</span>: <span class="string">"0.4.8"</span>,</span><br><span class="line">    <span class="attr">"wheelZoom"</span>: <span class="string">"0.95"</span>,</span><br><span class="line">    <span class="attr">"deviceNum"</span>: <span class="string">"18"</span>,</span><br><span class="line">    <span class="attr">"width"</span>: <span class="string">"1098"</span>,</span><br><span class="line">    <span class="attr">"height"</span>: <span class="string">"671"</span>,</span><br><span class="line">    <span class="attr">"id"</span>: <span class="string">"ST172.19.105.52015100809430700001"</span>,</span><br><span class="line">    <span class="attr">"topoLevel"</span>: <span class="string">"1"</span>,</span><br><span class="line">    <span class="attr">"parentLevel"</span>: <span class="string">"0"</span>,</span><br><span class="line">    <span class="attr">"nextLevel"</span>: <span class="string">"0"</span>,</span><br><span class="line">    <span class="attr">"childs"</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"id"</span>: <span class="string">"S172.19.105.52015100809430700002"</span>,</span><br><span class="line">        <span class="attr">"elementType"</span>: <span class="string">"scene"</span>,</span><br><span class="line">        <span class="attr">"translateX"</span>: <span class="string">"106.5"</span>,</span><br><span class="line">        <span class="attr">"translateY"</span>: <span class="string">"20"</span>,</span><br><span class="line">        <span class="attr">"scaleX"</span>: <span class="string">"1"</span>,</span><br><span class="line">        <span class="attr">"scaleY"</span>: <span class="string">"1"</span>,</span><br><span class="line">        <span class="attr">"totalLevel"</span>: <span class="string">"1"</span>,</span><br><span class="line">        <span class="attr">"parentLevel"</span>: <span class="string">"0"</span>,</span><br><span class="line">        <span class="attr">"nextLevel"</span>: <span class="string">"0"</span>,</span><br><span class="line">        <span class="attr">"topoLevel"</span>: <span class="string">"1"</span>,</span><br><span class="line">        <span class="attr">"childs"</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">"id"</span>: <span class="string">"L172.19.105.52015100811153300001"</span>,</span><br><span class="line">            <span class="attr">"elementType"</span>: <span class="string">"link"</span>,</span><br><span class="line">            <span class="attr">"x"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"y"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"width"</span>: <span class="string">"32"</span>,</span><br><span class="line">            <span class="attr">"height"</span>: <span class="string">"32"</span>,</span><br><span class="line">            <span class="attr">"rotate"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"scaleX"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"scaleY"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"text"</span>: <span class="string">"undefined"</span>,</span><br><span class="line">            <span class="attr">"deviceA"</span>: <span class="string">"1136300297928.587"</span>,</span><br><span class="line">            <span class="attr">"deviceZ"</span>: <span class="string">"1406176935353.6848"</span>,</span><br><span class="line">            <span class="attr">"lineType"</span>: <span class="string">"line"</span>,</span><br><span class="line">            <span class="attr">"topoLevel"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"parentLevel"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"nextLevel"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"zindex"</span>: <span class="string">"2"</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">"id"</span>: <span class="string">"L172.19.105.52015100811153300002"</span>,</span><br><span class="line">            <span class="attr">"elementType"</span>: <span class="string">"link"</span>,</span><br><span class="line">            <span class="attr">"x"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"y"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"width"</span>: <span class="string">"32"</span>,</span><br><span class="line">            <span class="attr">"height"</span>: <span class="string">"32"</span>,</span><br><span class="line">            <span class="attr">"rotate"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"scaleX"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"scaleY"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"text"</span>: <span class="string">"undefined"</span>,</span><br><span class="line">            <span class="attr">"deviceA"</span>: <span class="string">"1394105924967.951"</span>,</span><br><span class="line">            <span class="attr">"deviceZ"</span>: <span class="string">"1136300297928.587"</span>,</span><br><span class="line">            <span class="attr">"lineType"</span>: <span class="string">"line"</span>,</span><br><span class="line">            <span class="attr">"topoLevel"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"parentLevel"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"nextLevel"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"zindex"</span>: <span class="string">"2"</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">"id"</span>: <span class="string">"L172.19.105.52015100811153300004"</span>,</span><br><span class="line">            <span class="attr">"elementType"</span>: <span class="string">"link"</span>,</span><br><span class="line">            <span class="attr">"x"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"y"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"width"</span>: <span class="string">"32"</span>,</span><br><span class="line">            <span class="attr">"height"</span>: <span class="string">"32"</span>,</span><br><span class="line">            <span class="attr">"rotate"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"scaleX"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"scaleY"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"text"</span>: <span class="string">"undefined"</span>,</span><br><span class="line">            <span class="attr">"deviceA"</span>: <span class="string">"564241624829.4331"</span>,</span><br><span class="line">            <span class="attr">"deviceZ"</span>: <span class="string">"318016674603.1266"</span>,</span><br><span class="line">            <span class="attr">"lineType"</span>: <span class="string">"line"</span>,</span><br><span class="line">            <span class="attr">"topoLevel"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"parentLevel"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"nextLevel"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"zindex"</span>: <span class="string">"2"</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">"id"</span>: <span class="string">"L172.19.105.52015100811153300005"</span>,</span><br><span class="line">            <span class="attr">"elementType"</span>: <span class="string">"link"</span>,</span><br><span class="line">            <span class="attr">"x"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"y"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"width"</span>: <span class="string">"32"</span>,</span><br><span class="line">            <span class="attr">"height"</span>: <span class="string">"32"</span>,</span><br><span class="line">            <span class="attr">"rotate"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"scaleX"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"scaleY"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"text"</span>: <span class="string">"undefined"</span>,</span><br><span class="line">            <span class="attr">"deviceA"</span>: <span class="string">"1062340763210.1544"</span>,</span><br><span class="line">            <span class="attr">"deviceZ"</span>: <span class="string">"564241624829.4331"</span>,</span><br><span class="line">            <span class="attr">"lineType"</span>: <span class="string">"line"</span>,</span><br><span class="line">            <span class="attr">"topoLevel"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"parentLevel"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"nextLevel"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"zindex"</span>: <span class="string">"2"</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">"id"</span>: <span class="string">"L172.19.105.52015100811153300006"</span>,</span><br><span class="line">            <span class="attr">"elementType"</span>: <span class="string">"link"</span>,</span><br><span class="line">            <span class="attr">"x"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"y"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"width"</span>: <span class="string">"32"</span>,</span><br><span class="line">            <span class="attr">"height"</span>: <span class="string">"32"</span>,</span><br><span class="line">            <span class="attr">"rotate"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"scaleX"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"scaleY"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"text"</span>: <span class="string">"undefined"</span>,</span><br><span class="line">            <span class="attr">"deviceA"</span>: <span class="string">"564241624829.4331"</span>,</span><br><span class="line">            <span class="attr">"deviceZ"</span>: <span class="string">"488323736331.2087"</span>,</span><br><span class="line">            <span class="attr">"lineType"</span>: <span class="string">"line"</span>,</span><br><span class="line">            <span class="attr">"topoLevel"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"parentLevel"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"nextLevel"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"zindex"</span>: <span class="string">"2"</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">"id"</span>: <span class="string">"L172.19.105.52015100811153300007"</span>,</span><br><span class="line">            <span class="attr">"elementType"</span>: <span class="string">"link"</span>,</span><br><span class="line">            <span class="attr">"x"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"y"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"width"</span>: <span class="string">"32"</span>,</span><br><span class="line">            <span class="attr">"height"</span>: <span class="string">"32"</span>,</span><br><span class="line">            <span class="attr">"rotate"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"scaleX"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"scaleY"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"text"</span>: <span class="string">"undefined"</span>,</span><br><span class="line">            <span class="attr">"deviceA"</span>: <span class="string">"564241624829.4331"</span>,</span><br><span class="line">            <span class="attr">"deviceZ"</span>: <span class="string">"827722371280.0199"</span>,</span><br><span class="line">            <span class="attr">"lineType"</span>: <span class="string">"line"</span>,</span><br><span class="line">            <span class="attr">"topoLevel"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"parentLevel"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"nextLevel"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"zindex"</span>: <span class="string">"2"</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">"id"</span>: <span class="string">"L172.19.105.52015100811153300008"</span>,</span><br><span class="line">            <span class="attr">"elementType"</span>: <span class="string">"link"</span>,</span><br><span class="line">            <span class="attr">"x"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"y"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"width"</span>: <span class="string">"32"</span>,</span><br><span class="line">            <span class="attr">"height"</span>: <span class="string">"32"</span>,</span><br><span class="line">            <span class="attr">"rotate"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"scaleX"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"scaleY"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"text"</span>: <span class="string">"undefined"</span>,</span><br><span class="line">            <span class="attr">"deviceA"</span>: <span class="string">"564241624829.4331"</span>,</span><br><span class="line">            <span class="attr">"deviceZ"</span>: <span class="string">"1045863334277.662"</span>,</span><br><span class="line">            <span class="attr">"lineType"</span>: <span class="string">"line"</span>,</span><br><span class="line">            <span class="attr">"topoLevel"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"parentLevel"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"nextLevel"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"zindex"</span>: <span class="string">"2"</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">"id"</span>: <span class="string">"L172.19.105.52015100811153300009"</span>,</span><br><span class="line">            <span class="attr">"elementType"</span>: <span class="string">"link"</span>,</span><br><span class="line">            <span class="attr">"x"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"y"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"width"</span>: <span class="string">"32"</span>,</span><br><span class="line">            <span class="attr">"height"</span>: <span class="string">"32"</span>,</span><br><span class="line">            <span class="attr">"rotate"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"scaleX"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"scaleY"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"text"</span>: <span class="string">"undefined"</span>,</span><br><span class="line">            <span class="attr">"deviceA"</span>: <span class="string">"1262070648024.5728"</span>,</span><br><span class="line">            <span class="attr">"deviceZ"</span>: <span class="string">"564241624829.4331"</span>,</span><br><span class="line">            <span class="attr">"lineType"</span>: <span class="string">"line"</span>,</span><br><span class="line">            <span class="attr">"topoLevel"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"parentLevel"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"nextLevel"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"zindex"</span>: <span class="string">"2"</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">"id"</span>: <span class="string">"L172.19.105.52015100811153300010"</span>,</span><br><span class="line">            <span class="attr">"elementType"</span>: <span class="string">"link"</span>,</span><br><span class="line">            <span class="attr">"x"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"y"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"width"</span>: <span class="string">"32"</span>,</span><br><span class="line">            <span class="attr">"height"</span>: <span class="string">"32"</span>,</span><br><span class="line">            <span class="attr">"rotate"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"scaleX"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"scaleY"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"text"</span>: <span class="string">"undefined"</span>,</span><br><span class="line">            <span class="attr">"deviceA"</span>: <span class="string">"1262070648024.5728"</span>,</span><br><span class="line">            <span class="attr">"deviceZ"</span>: <span class="string">"1136300297928.587"</span>,</span><br><span class="line">            <span class="attr">"lineType"</span>: <span class="string">"line"</span>,</span><br><span class="line">            <span class="attr">"topoLevel"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"parentLevel"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"nextLevel"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"zindex"</span>: <span class="string">"2"</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">"id"</span>: <span class="string">"L172.19.105.52015100811214600001"</span>,</span><br><span class="line">            <span class="attr">"elementType"</span>: <span class="string">"link"</span>,</span><br><span class="line">            <span class="attr">"x"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"y"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"width"</span>: <span class="string">"32"</span>,</span><br><span class="line">            <span class="attr">"height"</span>: <span class="string">"32"</span>,</span><br><span class="line">            <span class="attr">"rotate"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"scaleX"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"scaleY"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"text"</span>: <span class="string">"undefined"</span>,</span><br><span class="line">            <span class="attr">"deviceA"</span>: <span class="string">"253209434749.73596"</span>,</span><br><span class="line">            <span class="attr">"deviceZ"</span>: <span class="string">"564241624829.4331"</span>,</span><br><span class="line">            <span class="attr">"lineType"</span>: <span class="string">"line"</span>,</span><br><span class="line">            <span class="attr">"topoLevel"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"parentLevel"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"nextLevel"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"zindex"</span>: <span class="string">"2"</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">"id"</span>: <span class="string">"L172.19.105.52015100811214600002"</span>,</span><br><span class="line">            <span class="attr">"elementType"</span>: <span class="string">"link"</span>,</span><br><span class="line">            <span class="attr">"x"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"y"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"width"</span>: <span class="string">"32"</span>,</span><br><span class="line">            <span class="attr">"height"</span>: <span class="string">"32"</span>,</span><br><span class="line">            <span class="attr">"rotate"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"scaleX"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"scaleY"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"text"</span>: <span class="string">"undefined"</span>,</span><br><span class="line">            <span class="attr">"deviceA"</span>: <span class="string">"253209434749.73596"</span>,</span><br><span class="line">            <span class="attr">"deviceZ"</span>: <span class="string">"1136300297928.587"</span>,</span><br><span class="line">            <span class="attr">"lineType"</span>: <span class="string">"line"</span>,</span><br><span class="line">            <span class="attr">"topoLevel"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"parentLevel"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"nextLevel"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"zindex"</span>: <span class="string">"2"</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">"id"</span>: <span class="string">"L172.19.105.52015100811214600003"</span>,</span><br><span class="line">            <span class="attr">"elementType"</span>: <span class="string">"link"</span>,</span><br><span class="line">            <span class="attr">"x"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"y"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"width"</span>: <span class="string">"32"</span>,</span><br><span class="line">            <span class="attr">"height"</span>: <span class="string">"32"</span>,</span><br><span class="line">            <span class="attr">"rotate"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"scaleX"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"scaleY"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"text"</span>: <span class="string">"undefined"</span>,</span><br><span class="line">            <span class="attr">"deviceA"</span>: <span class="string">"520008948580.8119"</span>,</span><br><span class="line">            <span class="attr">"deviceZ"</span>: <span class="string">"564241624829.4331"</span>,</span><br><span class="line">            <span class="attr">"lineType"</span>: <span class="string">"line"</span>,</span><br><span class="line">            <span class="attr">"topoLevel"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"parentLevel"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"nextLevel"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"zindex"</span>: <span class="string">"2"</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">"id"</span>: <span class="string">"L172.19.105.52015100811214600004"</span>,</span><br><span class="line">            <span class="attr">"elementType"</span>: <span class="string">"link"</span>,</span><br><span class="line">            <span class="attr">"x"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"y"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"width"</span>: <span class="string">"32"</span>,</span><br><span class="line">            <span class="attr">"height"</span>: <span class="string">"32"</span>,</span><br><span class="line">            <span class="attr">"rotate"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"scaleX"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"scaleY"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"text"</span>: <span class="string">"undefined"</span>,</span><br><span class="line">            <span class="attr">"deviceA"</span>: <span class="string">"520008948580.8119"</span>,</span><br><span class="line">            <span class="attr">"deviceZ"</span>: <span class="string">"1136300297928.587"</span>,</span><br><span class="line">            <span class="attr">"lineType"</span>: <span class="string">"line"</span>,</span><br><span class="line">            <span class="attr">"topoLevel"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"parentLevel"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"nextLevel"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"zindex"</span>: <span class="string">"2"</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">"id"</span>: <span class="string">"L172.19.105.52015100811512000002"</span>,</span><br><span class="line">            <span class="attr">"elementType"</span>: <span class="string">"link"</span>,</span><br><span class="line">            <span class="attr">"x"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"y"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"width"</span>: <span class="string">"32"</span>,</span><br><span class="line">            <span class="attr">"height"</span>: <span class="string">"32"</span>,</span><br><span class="line">            <span class="attr">"rotate"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"scaleX"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"scaleY"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"text"</span>: <span class="string">"undefined"</span>,</span><br><span class="line">            <span class="attr">"deviceA"</span>: <span class="string">"809054608657.865"</span>,</span><br><span class="line">            <span class="attr">"deviceZ"</span>: <span class="string">"1394105924967.951"</span>,</span><br><span class="line">            <span class="attr">"lineType"</span>: <span class="string">"line"</span>,</span><br><span class="line">            <span class="attr">"topoLevel"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"parentLevel"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"nextLevel"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"zindex"</span>: <span class="string">"2"</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">"id"</span>: <span class="string">"L172.19.105.52015100811512000004"</span>,</span><br><span class="line">            <span class="attr">"elementType"</span>: <span class="string">"link"</span>,</span><br><span class="line">            <span class="attr">"x"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"y"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"width"</span>: <span class="string">"32"</span>,</span><br><span class="line">            <span class="attr">"height"</span>: <span class="string">"32"</span>,</span><br><span class="line">            <span class="attr">"rotate"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"scaleX"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"scaleY"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"text"</span>: <span class="string">"undefined"</span>,</span><br><span class="line">            <span class="attr">"deviceA"</span>: <span class="string">"1250687739831.9912"</span>,</span><br><span class="line">            <span class="attr">"deviceZ"</span>: <span class="string">"1062340763210.1544"</span>,</span><br><span class="line">            <span class="attr">"lineType"</span>: <span class="string">"line"</span>,</span><br><span class="line">            <span class="attr">"topoLevel"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"parentLevel"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"nextLevel"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"zindex"</span>: <span class="string">"2"</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">"id"</span>: <span class="string">"L172.19.105.52015100911051100001"</span>,</span><br><span class="line">            <span class="attr">"elementType"</span>: <span class="string">"link"</span>,</span><br><span class="line">            <span class="attr">"x"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"y"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"width"</span>: <span class="string">"32"</span>,</span><br><span class="line">            <span class="attr">"height"</span>: <span class="string">"32"</span>,</span><br><span class="line">            <span class="attr">"rotate"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"scaleX"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"scaleY"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"text"</span>: <span class="string">"undefined"</span>,</span><br><span class="line">            <span class="attr">"deviceA"</span>: <span class="string">"564241624829.4331"</span>,</span><br><span class="line">            <span class="attr">"deviceZ"</span>: <span class="string">"597645745716.1871"</span>,</span><br><span class="line">            <span class="attr">"lineType"</span>: <span class="string">"line"</span>,</span><br><span class="line">            <span class="attr">"topoLevel"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"parentLevel"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"nextLevel"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"zindex"</span>: <span class="string">"2"</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">"id"</span>: <span class="string">"N172.19.105.52015100809464700002"</span>,</span><br><span class="line">            <span class="attr">"elementType"</span>: <span class="string">"node"</span>,</span><br><span class="line">            <span class="attr">"x"</span>: <span class="string">"198"</span>,</span><br><span class="line">            <span class="attr">"y"</span>: <span class="string">"315"</span>,</span><br><span class="line">            <span class="attr">"width"</span>: <span class="string">"32"</span>,</span><br><span class="line">            <span class="attr">"height"</span>: <span class="string">"32"</span>,</span><br><span class="line">            <span class="attr">"rotate"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"scaleX"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"scaleY"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"text"</span>: <span class="string">"attack-network"</span>,</span><br><span class="line">            <span class="attr">"textPosition"</span>: <span class="string">"Bottom_Center"</span>,</span><br><span class="line">            <span class="attr">"deviceId"</span>: <span class="string">"1136300297928.587"</span>,</span><br><span class="line">            <span class="attr">"dataType"</span>: <span class="string">"EC"</span>,</span><br><span class="line">            <span class="attr">"nodeImage"</span>: <span class="string">"tpIcon_5.png"</span>,</span><br><span class="line">            <span class="attr">"templateId"</span>: <span class="string">"NK172.19.105.52015100809464700001"</span>,</span><br><span class="line">            <span class="attr">"topoLevel"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"parentLevel"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"nextLevel"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"zindex"</span>: <span class="string">"3"</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">"id"</span>: <span class="string">"N172.19.105.52015100809465000001"</span>,</span><br><span class="line">            <span class="attr">"elementType"</span>: <span class="string">"node"</span>,</span><br><span class="line">            <span class="attr">"x"</span>: <span class="string">"196"</span>,</span><br><span class="line">            <span class="attr">"y"</span>: <span class="string">"242"</span>,</span><br><span class="line">            <span class="attr">"width"</span>: <span class="string">"32"</span>,</span><br><span class="line">            <span class="attr">"height"</span>: <span class="string">"32"</span>,</span><br><span class="line">            <span class="attr">"rotate"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"scaleX"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"scaleY"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"text"</span>: <span class="string">"attackr-router"</span>,</span><br><span class="line">            <span class="attr">"textPosition"</span>: <span class="string">"Bottom_Center"</span>,</span><br><span class="line">            <span class="attr">"deviceId"</span>: <span class="string">"1394105924967.951"</span>,</span><br><span class="line">            <span class="attr">"dataType"</span>: <span class="string">"VR"</span>,</span><br><span class="line">            <span class="attr">"nodeImage"</span>: <span class="string">"tpIcon_9.png"</span>,</span><br><span class="line">            <span class="attr">"templateId"</span>: <span class="string">"RT172.19.105.52015100811241800001"</span>,</span><br><span class="line">            <span class="attr">"topoLevel"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"parentLevel"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"nextLevel"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"zindex"</span>: <span class="string">"3"</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">"id"</span>: <span class="string">"N172.19.105.52015100809500700002"</span>,</span><br><span class="line">            <span class="attr">"elementType"</span>: <span class="string">"node"</span>,</span><br><span class="line">            <span class="attr">"x"</span>: <span class="string">"104"</span>,</span><br><span class="line">            <span class="attr">"y"</span>: <span class="string">"383.5"</span>,</span><br><span class="line">            <span class="attr">"width"</span>: <span class="string">"32"</span>,</span><br><span class="line">            <span class="attr">"height"</span>: <span class="string">"32"</span>,</span><br><span class="line">            <span class="attr">"rotate"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"scaleX"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"scaleY"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"text"</span>: <span class="string">"attack-client"</span>,</span><br><span class="line">            <span class="attr">"textPosition"</span>: <span class="string">"Bottom_Center"</span>,</span><br><span class="line">            <span class="attr">"deviceId"</span>: <span class="string">"1406176935353.6848"</span>,</span><br><span class="line">            <span class="attr">"dataType"</span>: <span class="string">"VM"</span>,</span><br><span class="line">            <span class="attr">"nodeImage"</span>: <span class="string">"tpIcon_2.png"</span>,</span><br><span class="line">            <span class="attr">"templateId"</span>: <span class="string">"VT172.19.105.52015100910413200001"</span>,</span><br><span class="line">            <span class="attr">"topoLevel"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"parentLevel"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"nextLevel"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"zindex"</span>: <span class="string">"3"</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">"id"</span>: <span class="string">"N172.19.105.52015100810295700002"</span>,</span><br><span class="line">            <span class="attr">"elementType"</span>: <span class="string">"node"</span>,</span><br><span class="line">            <span class="attr">"x"</span>: <span class="string">"539"</span>,</span><br><span class="line">            <span class="attr">"y"</span>: <span class="string">"321.5"</span>,</span><br><span class="line">            <span class="attr">"width"</span>: <span class="string">"32"</span>,</span><br><span class="line">            <span class="attr">"height"</span>: <span class="string">"32"</span>,</span><br><span class="line">            <span class="attr">"rotate"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"scaleX"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"scaleY"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"text"</span>: <span class="string">"intert-networker"</span>,</span><br><span class="line">            <span class="attr">"textPosition"</span>: <span class="string">"Bottom_Center"</span>,</span><br><span class="line">            <span class="attr">"deviceId"</span>: <span class="string">"564241624829.4331"</span>,</span><br><span class="line">            <span class="attr">"dataType"</span>: <span class="string">"EC"</span>,</span><br><span class="line">            <span class="attr">"nodeImage"</span>: <span class="string">"tpIcon_5.png"</span>,</span><br><span class="line">            <span class="attr">"templateId"</span>: <span class="string">"NK172.19.105.52015100810295700001"</span>,</span><br><span class="line">            <span class="attr">"topoLevel"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"parentLevel"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"nextLevel"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"zindex"</span>: <span class="string">"3"</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">"id"</span>: <span class="string">"N172.19.105.52015100810320100002"</span>,</span><br><span class="line">            <span class="attr">"elementType"</span>: <span class="string">"node"</span>,</span><br><span class="line">            <span class="attr">"x"</span>: <span class="string">"719"</span>,</span><br><span class="line">            <span class="attr">"y"</span>: <span class="string">"160.5"</span>,</span><br><span class="line">            <span class="attr">"width"</span>: <span class="string">"32"</span>,</span><br><span class="line">            <span class="attr">"height"</span>: <span class="string">"32"</span>,</span><br><span class="line">            <span class="attr">"rotate"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"scaleX"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"scaleY"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"text"</span>: <span class="string">"ws-manage"</span>,</span><br><span class="line">            <span class="attr">"textPosition"</span>: <span class="string">"Bottom_Center"</span>,</span><br><span class="line">            <span class="attr">"deviceId"</span>: <span class="string">"318016674603.1266"</span>,</span><br><span class="line">            <span class="attr">"dataType"</span>: <span class="string">"VM"</span>,</span><br><span class="line">            <span class="attr">"nodeImage"</span>: <span class="string">"mypc.png"</span>,</span><br><span class="line">            <span class="attr">"templateId"</span>: <span class="string">"VT172.19.105.52015100810320100001"</span>,</span><br><span class="line">            <span class="attr">"topoLevel"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"parentLevel"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"nextLevel"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"zindex"</span>: <span class="string">"3"</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">"id"</span>: <span class="string">"N172.19.105.52015100810402700002"</span>,</span><br><span class="line">            <span class="attr">"elementType"</span>: <span class="string">"node"</span>,</span><br><span class="line">            <span class="attr">"x"</span>: <span class="string">"725"</span>,</span><br><span class="line">            <span class="attr">"y"</span>: <span class="string">"225.5"</span>,</span><br><span class="line">            <span class="attr">"width"</span>: <span class="string">"32"</span>,</span><br><span class="line">            <span class="attr">"height"</span>: <span class="string">"32"</span>,</span><br><span class="line">            <span class="attr">"rotate"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"scaleX"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"scaleY"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"text"</span>: <span class="string">"ws-browser"</span>,</span><br><span class="line">            <span class="attr">"textPosition"</span>: <span class="string">"Bottom_Center"</span>,</span><br><span class="line">            <span class="attr">"deviceId"</span>: <span class="string">"488323736331.2087"</span>,</span><br><span class="line">            <span class="attr">"dataType"</span>: <span class="string">"VM"</span>,</span><br><span class="line">            <span class="attr">"nodeImage"</span>: <span class="string">"tpIcon_2.png"</span>,</span><br><span class="line">            <span class="attr">"templateId"</span>: <span class="string">"VT172.19.105.52015100810402700001"</span>,</span><br><span class="line">            <span class="attr">"topoLevel"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"parentLevel"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"nextLevel"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"zindex"</span>: <span class="string">"3"</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">"id"</span>: <span class="string">"N172.19.105.52015100810461200002"</span>,</span><br><span class="line">            <span class="attr">"elementType"</span>: <span class="string">"node"</span>,</span><br><span class="line">            <span class="attr">"x"</span>: <span class="string">"726"</span>,</span><br><span class="line">            <span class="attr">"y"</span>: <span class="string">"293.5"</span>,</span><br><span class="line">            <span class="attr">"width"</span>: <span class="string">"32"</span>,</span><br><span class="line">            <span class="attr">"height"</span>: <span class="string">"32"</span>,</span><br><span class="line">            <span class="attr">"rotate"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"scaleX"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"scaleY"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"text"</span>: <span class="string">"internal-mssql"</span>,</span><br><span class="line">            <span class="attr">"textPosition"</span>: <span class="string">"Bottom_Center"</span>,</span><br><span class="line">            <span class="attr">"deviceId"</span>: <span class="string">"827722371280.0199"</span>,</span><br><span class="line">            <span class="attr">"dataType"</span>: <span class="string">"VM"</span>,</span><br><span class="line">            <span class="attr">"nodeImage"</span>: <span class="string">"tpIcon_6.png"</span>,</span><br><span class="line">            <span class="attr">"templateId"</span>: <span class="string">"VT172.19.105.52015100810461200001"</span>,</span><br><span class="line">            <span class="attr">"topoLevel"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"parentLevel"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"nextLevel"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"zindex"</span>: <span class="string">"3"</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">"id"</span>: <span class="string">"N172.19.105.52015100810485100002"</span>,</span><br><span class="line">            <span class="attr">"elementType"</span>: <span class="string">"node"</span>,</span><br><span class="line">            <span class="attr">"x"</span>: <span class="string">"726"</span>,</span><br><span class="line">            <span class="attr">"y"</span>: <span class="string">"361.5"</span>,</span><br><span class="line">            <span class="attr">"width"</span>: <span class="string">"32"</span>,</span><br><span class="line">            <span class="attr">"height"</span>: <span class="string">"32"</span>,</span><br><span class="line">            <span class="attr">"rotate"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"scaleX"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"scaleY"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"text"</span>: <span class="string">"internal-ossec"</span>,</span><br><span class="line">            <span class="attr">"textPosition"</span>: <span class="string">"Bottom_Center"</span>,</span><br><span class="line">            <span class="attr">"deviceId"</span>: <span class="string">"1045863334277.662"</span>,</span><br><span class="line">            <span class="attr">"dataType"</span>: <span class="string">"VM"</span>,</span><br><span class="line">            <span class="attr">"nodeImage"</span>: <span class="string">"tpIcon_6.png"</span>,</span><br><span class="line">            <span class="attr">"templateId"</span>: <span class="string">"VT172.19.105.52015100810485100001"</span>,</span><br><span class="line">            <span class="attr">"topoLevel"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"parentLevel"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"nextLevel"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"zindex"</span>: <span class="string">"3"</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">"id"</span>: <span class="string">"N172.19.105.52015100810523500002"</span>,</span><br><span class="line">            <span class="attr">"elementType"</span>: <span class="string">"node"</span>,</span><br><span class="line">            <span class="attr">"x"</span>: <span class="string">"369"</span>,</span><br><span class="line">            <span class="attr">"y"</span>: <span class="string">"245.5"</span>,</span><br><span class="line">            <span class="attr">"width"</span>: <span class="string">"32"</span>,</span><br><span class="line">            <span class="attr">"height"</span>: <span class="string">"32"</span>,</span><br><span class="line">            <span class="attr">"rotate"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"scaleX"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"scaleY"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"text"</span>: <span class="string">"internet-www"</span>,</span><br><span class="line">            <span class="attr">"textPosition"</span>: <span class="string">"Bottom_Center"</span>,</span><br><span class="line">            <span class="attr">"deviceId"</span>: <span class="string">"1262070648024.5728"</span>,</span><br><span class="line">            <span class="attr">"dataType"</span>: <span class="string">"ECVR"</span>,</span><br><span class="line">            <span class="attr">"nodeImage"</span>: <span class="string">"vr-selfdefined.png"</span>,</span><br><span class="line">            <span class="attr">"templateId"</span>: <span class="string">"RT172.19.105.52015100810523500001"</span>,</span><br><span class="line">            <span class="attr">"topoLevel"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"parentLevel"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"nextLevel"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"zindex"</span>: <span class="string">"3"</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">"id"</span>: <span class="string">"N172.19.105.52015100811153300003"</span>,</span><br><span class="line">            <span class="attr">"elementType"</span>: <span class="string">"node"</span>,</span><br><span class="line">            <span class="attr">"x"</span>: <span class="string">"536"</span>,</span><br><span class="line">            <span class="attr">"y"</span>: <span class="string">"237.5"</span>,</span><br><span class="line">            <span class="attr">"width"</span>: <span class="string">"32"</span>,</span><br><span class="line">            <span class="attr">"height"</span>: <span class="string">"32"</span>,</span><br><span class="line">            <span class="attr">"rotate"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"scaleX"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"scaleY"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"text"</span>: <span class="string">"intert-router"</span>,</span><br><span class="line">            <span class="attr">"textPosition"</span>: <span class="string">"Bottom_Center"</span>,</span><br><span class="line">            <span class="attr">"deviceId"</span>: <span class="string">"1062340763210.1544"</span>,</span><br><span class="line">            <span class="attr">"dataType"</span>: <span class="string">"VR"</span>,</span><br><span class="line">            <span class="attr">"nodeImage"</span>: <span class="string">"tpIcon_9.png"</span>,</span><br><span class="line">            <span class="attr">"templateId"</span>: <span class="string">"RT172.19.105.52015100811281200001"</span>,</span><br><span class="line">            <span class="attr">"topoLevel"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"parentLevel"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"nextLevel"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"zindex"</span>: <span class="string">"3"</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">"id"</span>: <span class="string">"N172.19.105.52015100811163200002"</span>,</span><br><span class="line">            <span class="attr">"elementType"</span>: <span class="string">"node"</span>,</span><br><span class="line">            <span class="attr">"x"</span>: <span class="string">"367.5"</span>,</span><br><span class="line">            <span class="attr">"y"</span>: <span class="string">"320"</span>,</span><br><span class="line">            <span class="attr">"width"</span>: <span class="string">"32"</span>,</span><br><span class="line">            <span class="attr">"height"</span>: <span class="string">"32"</span>,</span><br><span class="line">            <span class="attr">"rotate"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"scaleX"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"scaleY"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"text"</span>: <span class="string">"internet-blog"</span>,</span><br><span class="line">            <span class="attr">"textPosition"</span>: <span class="string">"Bottom_Center"</span>,</span><br><span class="line">            <span class="attr">"deviceId"</span>: <span class="string">"253209434749.73596"</span>,</span><br><span class="line">            <span class="attr">"dataType"</span>: <span class="string">"ECVR"</span>,</span><br><span class="line">            <span class="attr">"nodeImage"</span>: <span class="string">"vr-selfdefined.png"</span>,</span><br><span class="line">            <span class="attr">"templateId"</span>: <span class="string">"RT172.19.105.52015100811163200001"</span>,</span><br><span class="line">            <span class="attr">"topoLevel"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"parentLevel"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"nextLevel"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"zindex"</span>: <span class="string">"3"</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">"id"</span>: <span class="string">"N172.19.105.52015100811204100002"</span>,</span><br><span class="line">            <span class="attr">"elementType"</span>: <span class="string">"node"</span>,</span><br><span class="line">            <span class="attr">"x"</span>: <span class="string">"370.5"</span>,</span><br><span class="line">            <span class="attr">"y"</span>: <span class="string">"403"</span>,</span><br><span class="line">            <span class="attr">"width"</span>: <span class="string">"32"</span>,</span><br><span class="line">            <span class="attr">"height"</span>: <span class="string">"32"</span>,</span><br><span class="line">            <span class="attr">"rotate"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"scaleX"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"scaleY"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"text"</span>: <span class="string">"internet-vpn"</span>,</span><br><span class="line">            <span class="attr">"textPosition"</span>: <span class="string">"Bottom_Center"</span>,</span><br><span class="line">            <span class="attr">"deviceId"</span>: <span class="string">"520008948580.8119"</span>,</span><br><span class="line">            <span class="attr">"dataType"</span>: <span class="string">"ECVR"</span>,</span><br><span class="line">            <span class="attr">"nodeImage"</span>: <span class="string">"vr-selfdefined.png"</span>,</span><br><span class="line">            <span class="attr">"templateId"</span>: <span class="string">"RT172.19.105.52015100811204100001"</span>,</span><br><span class="line">            <span class="attr">"topoLevel"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"parentLevel"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"nextLevel"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"zindex"</span>: <span class="string">"3"</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">"id"</span>: <span class="string">"N172.19.105.52015100811512000001"</span>,</span><br><span class="line">            <span class="attr">"elementType"</span>: <span class="string">"node"</span>,</span><br><span class="line">            <span class="attr">"x"</span>: <span class="string">"194.5"</span>,</span><br><span class="line">            <span class="attr">"y"</span>: <span class="string">"166"</span>,</span><br><span class="line">            <span class="attr">"width"</span>: <span class="string">"32"</span>,</span><br><span class="line">            <span class="attr">"height"</span>: <span class="string">"32"</span>,</span><br><span class="line">            <span class="attr">"rotate"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"scaleX"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"scaleY"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"text"</span>: <span class="string">"attack-firewall"</span>,</span><br><span class="line">            <span class="attr">"textPosition"</span>: <span class="string">"Bottom_Center"</span>,</span><br><span class="line">            <span class="attr">"deviceId"</span>: <span class="string">"809054608657.865"</span>,</span><br><span class="line">            <span class="attr">"dataType"</span>: <span class="string">"FW"</span>,</span><br><span class="line">            <span class="attr">"nodeImage"</span>: <span class="string">"tpIcon_4.png"</span>,</span><br><span class="line">            <span class="attr">"templateId"</span>: <span class="string">"undefined"</span>,</span><br><span class="line">            <span class="attr">"topoLevel"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"parentLevel"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"nextLevel"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"zindex"</span>: <span class="string">"3"</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">"id"</span>: <span class="string">"N172.19.105.52015100811512000003"</span>,</span><br><span class="line">            <span class="attr">"elementType"</span>: <span class="string">"node"</span>,</span><br><span class="line">            <span class="attr">"x"</span>: <span class="string">"534.5"</span>,</span><br><span class="line">            <span class="attr">"y"</span>: <span class="string">"163"</span>,</span><br><span class="line">            <span class="attr">"width"</span>: <span class="string">"32"</span>,</span><br><span class="line">            <span class="attr">"height"</span>: <span class="string">"32"</span>,</span><br><span class="line">            <span class="attr">"rotate"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"scaleX"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"scaleY"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"text"</span>: <span class="string">"intert-firewall"</span>,</span><br><span class="line">            <span class="attr">"textPosition"</span>: <span class="string">"Bottom_Center"</span>,</span><br><span class="line">            <span class="attr">"deviceId"</span>: <span class="string">"1250687739831.9912"</span>,</span><br><span class="line">            <span class="attr">"dataType"</span>: <span class="string">"FW"</span>,</span><br><span class="line">            <span class="attr">"nodeImage"</span>: <span class="string">"tpIcon_4.png"</span>,</span><br><span class="line">            <span class="attr">"templateId"</span>: <span class="string">"undefined"</span>,</span><br><span class="line">            <span class="attr">"topoLevel"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"parentLevel"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"nextLevel"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"zindex"</span>: <span class="string">"3"</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">"id"</span>: <span class="string">"N172.19.105.52015100911045400002"</span>,</span><br><span class="line">            <span class="attr">"elementType"</span>: <span class="string">"node"</span>,</span><br><span class="line">            <span class="attr">"x"</span>: <span class="string">"727.5"</span>,</span><br><span class="line">            <span class="attr">"y"</span>: <span class="string">"430"</span>,</span><br><span class="line">            <span class="attr">"width"</span>: <span class="string">"32"</span>,</span><br><span class="line">            <span class="attr">"height"</span>: <span class="string">"32"</span>,</span><br><span class="line">            <span class="attr">"rotate"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"scaleX"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"scaleY"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"text"</span>: <span class="string">"defend-client"</span>,</span><br><span class="line">            <span class="attr">"textPosition"</span>: <span class="string">"Bottom_Center"</span>,</span><br><span class="line">            <span class="attr">"deviceId"</span>: <span class="string">"597645745716.1871"</span>,</span><br><span class="line">            <span class="attr">"dataType"</span>: <span class="string">"VM"</span>,</span><br><span class="line">            <span class="attr">"nodeImage"</span>: <span class="string">"tpIcon_2.png"</span>,</span><br><span class="line">            <span class="attr">"templateId"</span>: <span class="string">"VT172.19.105.52015100911045400001"</span>,</span><br><span class="line">            <span class="attr">"topoLevel"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"parentLevel"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"nextLevel"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"zindex"</span>: <span class="string">"3"</span></span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们在页面上只需要调用</p>
<blockquote>
<p>editor.loadTopology(“images/backimg.png”,’${templateId}’,’${topologyId}’,””);</p>
</blockquote>
<p>其中templateIdtemplateId和topologyId是涉及到后端数据表的主键id，在此完全可以不用在意。loadTopology方法代码如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 加载环境模板ID对应的拓扑图JSON数据结构</span></span><br><span class="line"><span class="comment"> * @param backImg 拓扑图的背景图片</span></span><br><span class="line"><span class="comment"> * @param templateId 环境模板ID</span></span><br><span class="line"><span class="comment"> * @param topologyId 拓扑 表记录ID</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">propertyPanel.prototype.loadTopology = <span class="function"><span class="keyword">function</span> (<span class="params">backImg,templateId,topologyId,topoLevel</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!topoLevel) topoLevel = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">var</span> self = <span class="keyword">this</span>;</span><br><span class="line">    self.showLoadingWindow();</span><br><span class="line">    <span class="keyword">if</span> (!templateId) &#123;</span><br><span class="line">        templateId = editor.templateId;</span><br><span class="line">    &#125;</span><br><span class="line">    $.ajax(&#123;</span><br><span class="line">        url: <span class="string">'./topology.html'</span>,</span><br><span class="line">        <span class="keyword">async</span>: <span class="literal">false</span>,</span><br><span class="line">        type: <span class="string">"GET"</span>,</span><br><span class="line">        dataType: <span class="string">"html"</span>,</span><br><span class="line">        data: &#123;</span><br><span class="line">            <span class="string">"templateId"</span>:templateId,</span><br><span class="line">            <span class="string">"topologyId"</span>:topologyId,</span><br><span class="line">            <span class="string">"topoLevel"</span>:topoLevel</span><br><span class="line">        &#125;,</span><br><span class="line">        error: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            self.closeLoadingWindow();</span><br><span class="line">            jAlert(<span class="string">"服务器异常，请稍后重试.."</span>);</span><br><span class="line">        &#125;,</span><br><span class="line">        success: <span class="function"><span class="keyword">function</span> (<span class="params">response</span>) </span>&#123;</span><br><span class="line">            response = <span class="built_in">JSON</span>.parse(response);</span><br><span class="line">            <span class="keyword">var</span> err = response.errorInfo;</span><br><span class="line">            <span class="comment">// 错误处理</span></span><br><span class="line">            <span class="keyword">if</span> (err &amp;&amp; err != <span class="string">"ok"</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span>(err == <span class="string">"-1"</span>)&#123;</span><br><span class="line">                    editor.init(backImg, templateId, topologyId,<span class="string">"-1"</span>,<span class="string">""</span>);</span><br><span class="line">                &#125;<span class="keyword">else</span> <span class="keyword">if</span> (err == <span class="string">"logout"</span>) &#123;</span><br><span class="line">                    handleSessionTimeOut();</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    self.closeLoadingWindow();</span><br><span class="line">                    jAlert(err);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">var</span> topologyJson = response.topologyJson;</span><br><span class="line">                editor.init(backImg, templateId, topologyId, topologyJson,<span class="string">""</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure></p>
<p>首先发送请求获取json数据，然后处理响应结构，真正实现拓扑加载的逻辑在editor.init方法中。这里如果发现请求的拓扑不存在，获取创建一个空白的拓扑图。<br>下面再看init的实现逻辑：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 编辑器初始化方法,根据请求返回结果加载空白的或者指定结构的拓扑编辑器</span></span><br><span class="line"><span class="comment"> * @param backImg     背景图片</span></span><br><span class="line"><span class="comment"> * @param templateId  环境模板ID</span></span><br><span class="line"><span class="comment"> * @param topologyId  拓扑记录ID</span></span><br><span class="line"><span class="comment"> * @param stageJson    拓扑JSON结构</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">networkTopologyEditor.prototype.init = <span class="function"><span class="keyword">function</span> (<span class="params">backImg,templateId,topologyId,stageJson,templateName</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!stageJson)&#123;</span><br><span class="line">        jAlert(<span class="string">"加载拓扑编辑器失败!"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.templateId = templateId;</span><br><span class="line">    <span class="keyword">this</span>.topologyId = topologyId;</span><br><span class="line">    <span class="comment">//创建JTOP舞台屏幕对象</span></span><br><span class="line">    <span class="keyword">var</span> canvas = <span class="built_in">document</span>.getElementById(<span class="string">'drawCanvas'</span>);</span><br><span class="line">    canvas.width = $(<span class="string">"#contextBody"</span>).width();</span><br><span class="line">    canvas.height = $(<span class="string">"#contextBody"</span>).height();</span><br><span class="line">    <span class="comment">//加载空白的编辑器</span></span><br><span class="line">    <span class="keyword">if</span>(stageJson == <span class="string">"-1"</span>)&#123;</span><br><span class="line">        <span class="keyword">this</span>.stage = <span class="keyword">new</span> JTopo.Stage(canvas);</span><br><span class="line">        <span class="keyword">this</span>.stage.topoLevel = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">this</span>.stage.parentLevel = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">this</span>.modeIdIndex = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">this</span>.scene=  <span class="keyword">new</span> JTopo.Scene(<span class="keyword">this</span>.stage);</span><br><span class="line">        <span class="keyword">this</span>.scene.totalLevel = <span class="number">1</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.stage = JTopo.createStageFromJson(stageJson, canvas);</span><br><span class="line">        <span class="keyword">this</span>.scene = <span class="keyword">this</span>.stage.childs[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    $(<span class="string">"#parentLevel"</span>).val(<span class="keyword">this</span>.stage.parentLevel);</span><br><span class="line">    <span class="comment">//拓扑层次切换</span></span><br><span class="line">    <span class="keyword">var</span> options = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">1</span>; i &lt;= <span class="keyword">this</span>.scene.totalLevel ;i++)&#123;</span><br><span class="line">        options += <span class="string">'&lt;option value="'</span> + i +<span class="string">'" '</span>;</span><br><span class="line">        <span class="keyword">if</span>( i == <span class="keyword">this</span>.stage.topoLevel)&#123;</span><br><span class="line">            options += <span class="string">'selected="selected" '</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        options += <span class="string">'&gt;编辑第'</span> + i + <span class="string">'层&lt;/option&gt;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    $(<span class="string">"#selectLevel"</span>).append(options);</span><br><span class="line">    <span class="comment">//滚轮缩放</span></span><br><span class="line">    <span class="keyword">this</span>.stage.frames = <span class="keyword">this</span>.config.stageFrames;</span><br><span class="line">    <span class="keyword">this</span>.stage.wheelZoom = <span class="keyword">this</span>.config.defaultScal;</span><br><span class="line">    <span class="keyword">this</span>.stage.eagleEye.visible = <span class="keyword">this</span>.config.eagleEyeVsibleDefault;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.scene.mode = <span class="string">"edit"</span>;</span><br><span class="line">    <span class="comment">//背景由样式指定</span></span><br><span class="line">    <span class="comment">//this.scene.background = backImg;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//用来连线的两个节点</span></span><br><span class="line">    <span class="keyword">this</span>.tempNodeA = <span class="keyword">new</span> JTopo.Node(<span class="string">'tempA'</span>);</span><br><span class="line">    <span class="keyword">this</span>.tempNodeA.setSize(<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">this</span>.tempNodeZ = <span class="keyword">new</span> JTopo.Node(<span class="string">'tempZ'</span>);</span><br><span class="line">    <span class="keyword">this</span>.tempNodeZ.setSize(<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">this</span>.beginNode = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">this</span>.link = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">var</span> self = <span class="keyword">this</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化菜单</span></span><br><span class="line">    <span class="keyword">this</span>.initMenus();</span><br><span class="line">    <span class="comment">//事件处理逻辑在此省略...</span></span><br><span class="line">    <span class="comment">//第一次进入拓扑编辑器,生成stage和scene对象</span></span><br><span class="line">    <span class="keyword">if</span>(stageJson == <span class="string">"-1"</span>)&#123;</span><br><span class="line">        <span class="keyword">this</span>.saveToplogy(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//编辑器初始化完毕关闭loading窗口</span></span><br><span class="line">    <span class="keyword">this</span>.closeLoadingWindow();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里的代码看似复杂，其实就是做了两件事:<br>1) 构建基本的stage和scene<br>2) 调用JTopo.createStageFromJson(stageJson, canvas)即可创建整个拓扑的结构<br>3) 初始化编辑其菜单<br>4) 最后绑定各种事件的处理逻辑<br>5) 最后在获取拓扑数据的时候如果发生错误则创建一个空白的拓扑<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//第一次进入拓扑编辑器,生成stage和scene对象</span></span><br><span class="line">   <span class="keyword">if</span>(stageJson == <span class="string">"-1"</span>)&#123;</span><br><span class="line">       <span class="keyword">this</span>.saveToplogy(<span class="literal">false</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>至此拓扑的加载和创建一个空白拓扑任务就完成了</p>
<h3 id="保存拓扑图"><a href="#保存拓扑图" class="headerlink" title="保存拓扑图"></a>保存拓扑图</h3><p>保存拓扑就是把编辑好的拓扑序列化成json，然后上传到服务端保存数据库。按照最简单的思路，我们需要按照Node,Scene,Stage。因此我们定义以下实体对象：</p>
<p>Node<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bjhit.cncert.common.beans.models;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.codehaus.jackson.map.annotate.JsonSerialize;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by gongxufan on 2014/11/20.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@JsonSerialize</span>(include=JsonSerialize.Inclusion.NON_NULL)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">    <span class="keyword">private</span> String elementType;</span><br><span class="line">    <span class="keyword">private</span> String x;</span><br><span class="line">    <span class="keyword">private</span> String y;</span><br><span class="line">    <span class="keyword">private</span> String width;</span><br><span class="line">    <span class="keyword">private</span> String height;</span><br><span class="line">    <span class="keyword">private</span> String alpha;</span><br><span class="line">    <span class="keyword">private</span> String rotate;</span><br><span class="line">    <span class="keyword">private</span> String scaleX;</span><br><span class="line">    <span class="keyword">private</span> String scaleY;</span><br><span class="line">    <span class="keyword">private</span> String strokeColor;</span><br><span class="line">    <span class="keyword">private</span> String fillColor;</span><br><span class="line">    <span class="keyword">private</span> String shadowColor;</span><br><span class="line">    <span class="keyword">private</span> String shadowOffsetX;</span><br><span class="line">    <span class="keyword">private</span> String shadowOffsetY;</span><br><span class="line">    <span class="keyword">private</span> String zIndex;</span><br><span class="line">    <span class="keyword">private</span> String text;</span><br><span class="line">    <span class="keyword">private</span> String font;</span><br><span class="line">    <span class="keyword">private</span> String fontColor;</span><br><span class="line">    <span class="keyword">private</span> String textPosition;</span><br><span class="line">    <span class="keyword">private</span> String textOffsetX;</span><br><span class="line">    <span class="keyword">private</span> String textOffsetY;</span><br><span class="line">    <span class="keyword">private</span> String borderRadius;</span><br><span class="line">    <span class="keyword">private</span> String deviceId;</span><br><span class="line">    <span class="keyword">private</span> String dataType;</span><br><span class="line">    <span class="keyword">private</span> String borderColor;</span><br><span class="line">    <span class="keyword">private</span> String offsetGap;</span><br><span class="line">    <span class="keyword">private</span> String childNodes;</span><br><span class="line">    <span class="keyword">private</span> String nodeImage;</span><br><span class="line">    <span class="keyword">private</span> String templateId;</span><br><span class="line">    <span class="keyword">private</span> String deviceA;</span><br><span class="line">    <span class="keyword">private</span> String deviceZ;</span><br><span class="line">    <span class="keyword">private</span> String lineType;</span><br><span class="line">    <span class="keyword">private</span> String direction;</span><br><span class="line">    <span class="keyword">private</span> String vmInstanceId;</span><br><span class="line">    <span class="keyword">private</span> String displayName;</span><br><span class="line">    <span class="keyword">private</span> String vmid;</span><br><span class="line">    <span class="keyword">private</span> String topoLevel;</span><br><span class="line">    <span class="keyword">private</span> String parentLevel;</span><br><span class="line">    <span class="keyword">private</span> String nextLevel;</span><br><span class="line">    <span class="comment">//getter/setter</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Scene<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bjhit.cncert.common.beans.models;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.codehaus.jackson.map.annotate.JsonSerialize;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by gongxufan on 2014/11/20.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@JsonSerialize</span>(include=JsonSerialize.Inclusion.NON_NULL)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Scene</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">    <span class="keyword">private</span> String elementType;</span><br><span class="line">    <span class="keyword">private</span> String background;</span><br><span class="line">    <span class="keyword">private</span> String backgroundColor;</span><br><span class="line">    <span class="keyword">private</span> String mode;</span><br><span class="line">    <span class="keyword">private</span> String translateX;</span><br><span class="line">    <span class="keyword">private</span> String translateY;</span><br><span class="line">    <span class="keyword">private</span> String alpha;</span><br><span class="line">    <span class="keyword">private</span> String scaleX;</span><br><span class="line">    <span class="keyword">private</span> String scaleY;</span><br><span class="line">    <span class="keyword">private</span> String totalLevel;</span><br><span class="line">    <span class="keyword">private</span> String parentLevel;</span><br><span class="line">    <span class="keyword">private</span> String nextLevel;</span><br><span class="line">    <span class="keyword">private</span> String topoLevel;</span><br><span class="line">    <span class="comment">//getter/setter</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Stage<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bjhit.cncert.common.beans.models;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.codehaus.jackson.map.annotate.JsonSerialize;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 拓扑编辑器舞台对象</span></span><br><span class="line"><span class="comment"> * Created by gongxufan on 2014/11/20.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@JsonSerialize</span>(include=JsonSerialize.Inclusion.NON_NULL)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Stage</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String version;</span><br><span class="line">    <span class="keyword">private</span> String frames;</span><br><span class="line">    <span class="keyword">private</span> String wheelZoom;</span><br><span class="line">    <span class="keyword">private</span> String deviceNum;</span><br><span class="line">    <span class="keyword">private</span> String width;</span><br><span class="line">    <span class="keyword">private</span> String height;</span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">    <span class="keyword">private</span> String totalLevel;</span><br><span class="line">    <span class="keyword">private</span> String topoLevel;</span><br><span class="line">    <span class="keyword">private</span> String parentLevel;</span><br><span class="line">    <span class="keyword">private</span> String nextLevel;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Scene&gt; childs;</span><br><span class="line">    <span class="comment">//getter/setter</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>定义好了这三个结构，我们在前后端就有了对照关系。接着再看前端如何序列化?<br>先看前端如何序列化拓扑结构：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 保存序列化的JSON数据到服务器,为减少请求参数长度,进行了字符串的替换</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">propertyPanel.prototype.saveToplogy = <span class="function"><span class="keyword">function</span> (<span class="params">showAlert</span>) </span>&#123;</span><br><span class="line">        editor.mainMenu.hide();</span><br><span class="line">        <span class="keyword">var</span> self = <span class="keyword">this</span>;</span><br><span class="line">        <span class="keyword">this</span>.showLoadingWindow();</span><br><span class="line">        <span class="comment">//先删除标尺线</span></span><br><span class="line">        editor.utils.clearRuleLines();</span><br><span class="line">        <span class="comment">//保存container状态</span></span><br><span class="line">        <span class="keyword">var</span> containers = editor.utils.getContainers();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> c=<span class="number">0</span> ; c &lt; containers.length ; c++)&#123;</span><br><span class="line">              <span class="keyword">var</span> temp = [];</span><br><span class="line">              <span class="keyword">var</span> nodes = containers[c].childs;</span><br><span class="line">              <span class="keyword">for</span>(<span class="keyword">var</span> n =<span class="number">0</span> ; n &lt; nodes.length ; n++)&#123;</span><br><span class="line">                  <span class="keyword">if</span>(nodes[n] <span class="keyword">instanceof</span> JTopo.Node)&#123;</span><br><span class="line">                      temp.push(nodes[n].deviceId);</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            containers[c].childNodes = temp.join(<span class="string">","</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//设置拓扑当前层次和最大层次数</span></span><br><span class="line">        <span class="keyword">var</span> selectLevel = $(<span class="string">"#selectLevel"</span>);</span><br><span class="line">        <span class="keyword">var</span> levels = selectLevel.find(<span class="string">"option:selected"</span>);</span><br><span class="line">        editor.stage.topoLevel = <span class="built_in">parseInt</span>(levels.eq(<span class="number">0</span>).val());</span><br><span class="line">        <span class="keyword">if</span>(editor.stage.topoLevel == <span class="number">-1</span>) editor.stage.topoLevel = <span class="number">1</span>;</span><br><span class="line">        editor.stage.parentLevel = $(<span class="string">"#parentLevel"</span>).val();</span><br><span class="line">        editor.scene.totalLevel = selectLevel.find(<span class="string">"option"</span>).size() - <span class="number">1</span>;</span><br><span class="line">        topologyJSON = editor.stage.toJson();</span><br><span class="line">        <span class="keyword">if</span>(topologyJSON)&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">var</span> key <span class="keyword">in</span> <span class="keyword">this</span>.jsonCode)&#123;<span class="comment">//字符压缩</span></span><br><span class="line">                topologyJSON = topologyJSON.replace(<span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">'"'</span>+ key +<span class="string">'"'</span>,<span class="string">"gm"</span>),<span class="keyword">this</span>.jsonCode[key]);</span><br><span class="line">            &#125;</span><br><span class="line">            topologyJSON = topologyJSON.replace(<span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">'",'</span>,<span class="string">"gm"</span>),<span class="string">';'</span>);</span><br><span class="line">            topologyJSON = topologyJSON.replace(<span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">'"'</span>,<span class="string">"gm"</span>),<span class="string">'@'</span>);</span><br><span class="line">            topologyJSON = topologyJSON.replace(<span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">'undefined'</span>,<span class="string">"gm"</span>),<span class="string">'#'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        $.ajax(&#123;</span><br><span class="line">            url: context + <span class="string">"topologyManage/saveTopologyJSON"</span>,</span><br><span class="line">            <span class="keyword">async</span>: <span class="literal">true</span>,</span><br><span class="line">            type: <span class="string">"POST"</span>,</span><br><span class="line">            dataType: <span class="string">"json"</span>,</span><br><span class="line">            data: &#123;</span><br><span class="line">                <span class="string">"topologyJSON"</span>: topologyJSON,</span><br><span class="line">                <span class="string">"templateId"</span>: editor.templateId,</span><br><span class="line">                <span class="string">"topologyId"</span>:editor.topologyId</span><br><span class="line">            &#125;,</span><br><span class="line">            error: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                self.closeLoadingWindow();</span><br><span class="line">                jAlert(<span class="string">"服务器异常，请稍后重试.."</span>);</span><br><span class="line">            &#125;,</span><br><span class="line">            success: <span class="function"><span class="keyword">function</span> (<span class="params">response</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">var</span> err = response.errorInfo;</span><br><span class="line">                <span class="comment">// 错误处理</span></span><br><span class="line">                <span class="keyword">if</span> (err &amp;&amp; err != <span class="string">"ok"</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (err == <span class="string">"logout"</span>) &#123;</span><br><span class="line">                        handleSessionTimeOut();</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        self.closeLoadingWindow();</span><br><span class="line">                        jAlert(err);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      s<span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 保存序列化的JSON数据到服务器,为减少请求参数长度,进行了字符串的替换</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">propertyPanel.prototype.saveToplogy = <span class="function"><span class="keyword">function</span> (<span class="params">showAlert</span>) </span>&#123;</span><br><span class="line">        editor.mainMenu.hide();</span><br><span class="line">        <span class="keyword">var</span> self = <span class="keyword">this</span>;</span><br><span class="line">        <span class="keyword">this</span>.showLoadingWindow();</span><br><span class="line">        <span class="comment">//先删除标尺线</span></span><br><span class="line">        editor.utils.clearRuleLines();</span><br><span class="line">        <span class="comment">//保存container状态</span></span><br><span class="line">        <span class="keyword">var</span> containers = editor.utils.getContainers();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> c=<span class="number">0</span> ; c &lt; containers.length ; c++)&#123;</span><br><span class="line">              <span class="keyword">var</span> temp = [];</span><br><span class="line">              <span class="keyword">var</span> nodes = containers[c].childs;</span><br><span class="line">              <span class="keyword">for</span>(<span class="keyword">var</span> n =<span class="number">0</span> ; n &lt; nodes.length ; n++)&#123;</span><br><span class="line">                  <span class="keyword">if</span>(nodes[n] <span class="keyword">instanceof</span> JTopo.Node)&#123;</span><br><span class="line">                      temp.push(nodes[n].deviceId);</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            containers[c].childNodes = temp.join(<span class="string">","</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//设置拓扑当前层次和最大层次数</span></span><br><span class="line">        <span class="keyword">var</span> selectLevel = $(<span class="string">"#selectLevel"</span>);</span><br><span class="line">        <span class="keyword">var</span> levels = selectLevel.find(<span class="string">"option:selected"</span>);</span><br><span class="line">        editor.stage.topoLevel = <span class="built_in">parseInt</span>(levels.eq(<span class="number">0</span>).val());</span><br><span class="line">        <span class="keyword">if</span>(editor.stage.topoLevel == <span class="number">-1</span>) editor.stage.topoLevel = <span class="number">1</span>;</span><br><span class="line">        editor.stage.parentLevel = $(<span class="string">"#parentLevel"</span>).val();</span><br><span class="line">        editor.scene.totalLevel = selectLevel.find(<span class="string">"option"</span>).size() - <span class="number">1</span>;</span><br><span class="line">        topologyJSON = editor.stage.toJson();</span><br><span class="line">        <span class="keyword">if</span>(topologyJSON)&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">var</span> key <span class="keyword">in</span> <span class="keyword">this</span>.jsonCode)&#123;<span class="comment">//字符压缩</span></span><br><span class="line">                topologyJSON = topologyJSON.replace(<span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">'"'</span>+ key +<span class="string">'"'</span>,<span class="string">"gm"</span>),<span class="keyword">this</span>.jsonCode[key]);</span><br><span class="line">            &#125;</span><br><span class="line">            topologyJSON = topologyJSON.replace(<span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">'",'</span>,<span class="string">"gm"</span>),<span class="string">';'</span>);</span><br><span class="line">            topologyJSON = topologyJSON.replace(<span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">'"'</span>,<span class="string">"gm"</span>),<span class="string">'@'</span>);</span><br><span class="line">            topologyJSON = topologyJSON.replace(<span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">'undefined'</span>,<span class="string">"gm"</span>),<span class="string">'#'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        $.ajax(&#123;</span><br><span class="line">            url: context + <span class="string">"topologyManage/saveTopologyJSON"</span>,</span><br><span class="line">            <span class="keyword">async</span>: <span class="literal">true</span>,</span><br><span class="line">            type: <span class="string">"POST"</span>,</span><br><span class="line">            dataType: <span class="string">"json"</span>,</span><br><span class="line">            data: &#123;</span><br><span class="line">                <span class="string">"topologyJSON"</span>: topologyJSON,</span><br><span class="line">                <span class="string">"templateId"</span>: editor.templateId,</span><br><span class="line">                <span class="string">"topologyId"</span>:editor.topologyId</span><br><span class="line">            &#125;,</span><br><span class="line">            error: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                self.closeLoadingWindow();</span><br><span class="line">                jAlert(<span class="string">"服务器异常，请稍后重试.."</span>);</span><br><span class="line">            &#125;,</span><br><span class="line">            success: <span class="function"><span class="keyword">function</span> (<span class="params">response</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">var</span> err = response.errorInfo;</span><br><span class="line">                <span class="comment">// 错误处理</span></span><br><span class="line">                <span class="keyword">if</span> (err &amp;&amp; err != <span class="string">"ok"</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (err == <span class="string">"logout"</span>) &#123;</span><br><span class="line">                        handleSessionTimeOut();</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        self.closeLoadingWindow();</span><br><span class="line">                        jAlert(err);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    self.replaceStage(editor.templateId,editor.topologyId,showAlert,editor.stage.topoLevel);</span><br><span class="line">                    self.closeLoadingWindow();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;;              self.replaceStage(editor.templateId,editor.topologyId,showAlert,editor.stage.topoLevel);</span><br><span class="line">                    self.closeLoadingWindow();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure>
<ol>
<li>删除标尺线（编辑区域显示的横向和竖向直线），这个对象需要从我们的结构中剔除，调用clearRuleLines方法即可。</li>
<li>containers区域的节点对象需要提取出来，因为这些节点在调用序列化的时候已经包含进去了，所以入库的时候只需要把他们的节点id和容器关联即可</li>
<li>如果支持分层编辑，还要保存当前拓扑结构的层级数量</li>
<li>调用editor.stage.toJson()就获取了整个拓扑的结构</li>
<li>json替换，仅仅为了减少传输数据</li>
<li>最后将解析的json发送给后台处理      </li>
</ol>
<p>其余细节在此不做赘述，这个项目需要读者具备：H5、easyUI、jTopo、canvas、JSON等基本知识。至于jTopo只需看看其作者提供的DEMO和很少的API就可以很快上手。最好的学习方法是打断点不同的调试跟踪，查看整个工作机制。这里演示的拓扑编辑也是一个很简单不完整的例子，其实还是有很多可以定制化的东西，比如连线以及连线方式都可以进一步定制。</p>
<h2 id="end"><a href="#end" class="headerlink" title="end"></a>end</h2><p>参考资料：<br><a href="http://www.jtopo.com/" target="_blank" rel="external">http://www.jtopo.com/</a></p>
<p><a href="http://www.jeasyui.com/documentation/" target="_blank" rel="external">http://www.jeasyui.com/documentation/</a></p>
<p><a href="http://www.w3school.com.cn/html5/" target="_blank" rel="external">http://www.w3school.com.cn/html5/</a></p>
]]></content>
      
        <categories>
            
            <category> 工作日志 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> javascript </tag>
            
            <tag> 前端 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[关于ionic1.x打包成APP，输入框调出输入法按返回键造成页面后退的问题解决]]></title>
      <url>/2016/12/06/ionic-keybord-invalidate/</url>
      <content type="html"><![CDATA[<p>本人亲自试用的解决方案，先贴上完整代码：在项目的app.js里配置如下<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">angular.module(<span class="string">'starter'</span>, [<span class="string">'ionic'</span>, <span class="string">'starter.controllers'</span>, <span class="string">'starter.services'</span>, <span class="string">'common'</span>])  </span><br><span class="line">  </span><br><span class="line">  .run(<span class="function"><span class="keyword">function</span> (<span class="params">$ionicPlatform, $ionicHistory, $ionicPopup, $timeout</span>) </span>&#123;  </span><br><span class="line">    $ionicPlatform.ready(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;  </span><br><span class="line">      <span class="comment">// Hide the accessory bar by default (remove this to show the accessory bar above the keyboard  </span></span><br><span class="line">      <span class="comment">// for form inputs)  </span></span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">window</span>.cordova &amp;&amp; <span class="built_in">window</span>.cordova.plugins &amp;&amp; <span class="built_in">window</span>.cordova.plugins.Keyboard) &#123;  </span><br><span class="line">        cordova.plugins.Keyboard.hideKeyboardAccessoryBar(<span class="literal">true</span>);  </span><br><span class="line">        cordova.plugins.Keyboard.disableScroll(<span class="literal">true</span>);  </span><br><span class="line">      &#125;  </span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">window</span>.StatusBar) &#123;  </span><br><span class="line">        <span class="comment">// org.apache.cordova.statusbar required  </span></span><br><span class="line">        StatusBar.styleDefault();  </span><br><span class="line">      &#125;  </span><br><span class="line">      <span class="comment">//延迟设置isVisible为false，防止第三方输入法返回退出当前页面  </span></span><br><span class="line">      <span class="built_in">window</span>.addEventListener(<span class="string">'native.keyboardhide'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;  </span><br><span class="line">        cordova.plugins.Keyboard.isVisible = <span class="literal">true</span>;  </span><br><span class="line">        $timeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;  </span><br><span class="line">          cordova.plugins.Keyboard.isVisible = <span class="literal">false</span>;  </span><br><span class="line">        &#125;, <span class="number">100</span>);  </span><br><span class="line">      &#125;);  </span><br><span class="line">    &#125;);  </span><br><span class="line">  </span><br><span class="line">    $ionicPlatform.registerBackButtonAction(<span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;  </span><br><span class="line">      event.preventDefault();  </span><br><span class="line">      <span class="keyword">if</span> ($ionicHistory.backView()) &#123;  </span><br><span class="line">        <span class="keyword">if</span> (cordova.plugins.Keyboard.isVisible) &#123;  </span><br><span class="line">          cordova.plugins.Keyboard.close();  </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">          $ionicHistory.goBack();  </span><br><span class="line">        &#125;  </span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">        ionic.Platform.exitApp();  </span><br><span class="line">      &#125;  </span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;  </span><br><span class="line">    &#125;, <span class="number">101</span>);  </span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure></p>
<p>我们新建的ionic项目应该默认 引入了键盘插件：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">cordova.plugins.Keyboard </span><br><span class="line"><span class="string">``</span><span class="string">` </span></span><br><span class="line"><span class="string">要解决这个问题，我们需要重新定义按返回键的事件。我们可以在registerBackButtonAction方法中覆盖原来的逻辑。起方法代码如下：</span></span><br><span class="line"><span class="string">`</span><span class="string">``</span>javascript</span><br><span class="line">registerBackButtonAction: <span class="function"><span class="keyword">function</span>(<span class="params">fn, priority, actionId</span>) </span>&#123;  </span><br><span class="line">  </span><br><span class="line">          <span class="keyword">if</span> (!self._hasBackButtonHandler) &#123;  </span><br><span class="line">            <span class="comment">// add a back button listener if one hasn't been setup yet  </span></span><br><span class="line">            self.$backButtonActions = &#123;&#125;;  </span><br><span class="line">            self.onHardwareBackButton(self.hardwareBackButtonClick);  </span><br><span class="line">            self._hasBackButtonHandler = <span class="literal">true</span>;  </span><br><span class="line">          &#125;  </span><br><span class="line">  </span><br><span class="line">          <span class="keyword">var</span> action = &#123;  </span><br><span class="line">            id: (actionId ? actionId : ionic.Utils.nextUid()),  </span><br><span class="line">            priority: (priority ? priority : <span class="number">0</span>),  </span><br><span class="line">            fn: fn  </span><br><span class="line">          &#125;;  </span><br><span class="line">          self.$backButtonActions[action.id] = action;  </span><br><span class="line">  </span><br><span class="line">          <span class="comment">// return a function to de-register this back button action  </span></span><br><span class="line">          <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;  </span><br><span class="line">            <span class="keyword">delete</span> self.$backButtonActions[action.id];  </span><br><span class="line">          &#125;;  </span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure></p>
<p>fn是按返回键回调函数，priority则指定了该回调函数执行的优先级。默认的优先级有：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">*   Return to previous view = 100  </span><br><span class="line">*   Close side menu = 150  </span><br><span class="line">*   Dismiss modal = 200  </span><br><span class="line">*   Close action sheet = 300  </span><br><span class="line">*   Dismiss popup = 400  </span><br><span class="line">*   Dismiss loading overlay = 500</span><br></pre></td></tr></table></figure></p>
<p>priority=100时，即为返回上一个视图的执行条件，因此我们只需要设置一个优先级比100高同时又比其他默认优先级要低，以防止影响其他组件的响应。这里我们可以设置为101。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ionicPlatform.registerBackButtonAction(<span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;  </span><br><span class="line">     event.preventDefault();  </span><br><span class="line">     <span class="keyword">if</span> ($ionicHistory.backView()) &#123;  </span><br><span class="line">       <span class="keyword">if</span> (cordova.plugins.Keyboard.isVisible) &#123;  </span><br><span class="line">         cordova.plugins.Keyboard.close();  </span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">         $ionicHistory.goBack();  </span><br><span class="line">       &#125;  </span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">       ionic.Platform.exitApp();  </span><br><span class="line">     &#125;  </span><br><span class="line">     <span class="keyword">return</span> <span class="literal">false</span>;  </span><br><span class="line">   &#125;, <span class="number">101</span>);</span><br></pre></td></tr></table></figure></p>
<p>上面的方法，首先判断当前视图栈中是否还有历史视图，没有的话调用exitApp直接退出程序。</p>
<p>否则就要判断键盘的显示状态，这里就是问题的关键。如何在键盘打开的情况下，按返回键不触发返回上一个视图呢？</p>
<p>我们可以通过监听键盘隐藏事件，当按返回键键盘隐藏的时候延迟设置键盘可见性，以防在返回键被按下的监听函数里根据isVisible为true直接调用goBack退出取当前视图。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.addEventListener(<span class="string">'native.keyboardhide'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;  </span><br><span class="line">       cordova.plugins.Keyboard.isVisible = <span class="literal">true</span>;  </span><br><span class="line">       $timeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;  </span><br><span class="line">         cordova.plugins.Keyboard.isVisible = <span class="literal">false</span>;  </span><br><span class="line">       &#125;, <span class="number">100</span>);  </span><br><span class="line">     &#125;);</span><br></pre></td></tr></table></figure></p>
<p>上面的代码中，监听到键盘隐藏时先把isVisible设置为true，然后延迟100ms再设置为false，此时在registerBackButtonAction判断isVisible状态为true就不会调用goBack退出当前视图了。</p>
<p>我们可以在这两个监听函数里通过$ionicPopup打印日志来看这个判断过程。</p>
<p>提供一个简单的信息打印方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">showAlert : function (message,title,buttonName) &#123;  </span><br><span class="line">       <span class="comment">//使用原生UI  </span></span><br><span class="line">       <span class="keyword">if</span> (window.cordova &amp;&amp; window.cordova.plugins)  </span><br><span class="line">         $cordovaDialogs.alert(message, title, buttonName);  </span><br><span class="line">       <span class="keyword">else</span>  </span><br><span class="line">         $ionicPopup.alert(&#123;  </span><br><span class="line">           title: title,  </span><br><span class="line">           template: message,  </span><br><span class="line">           okText: buttonName  </span><br><span class="line">         &#125;);</span><br></pre></td></tr></table></figure></p>
]]></content>
      
        <categories>
            
            <category> 随笔 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> ionic </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Angular开发环境搭配]]></title>
      <url>/2016/08/03/angular-env/</url>
      <content type="html"><![CDATA[<p>现在前端的框架很多，为什么选择 Angular？这个问题几年以来一直都有人在争执，网上也有大把的文章在讨论在纠结，甚至在攻击。然而作为一枚开发人员，觉得合适自己上手方便就好。最热门的话题莫过于 Angular和Vue之争。<br>个人认为适合 Angular的使用人群如下：（注：NG==Angular2+）</p>
<ul>
<li>技术偏执狂<br>我们寻求一种一栈式的开发工具链，不管是编译，打包，压缩，单元测试都能在框架内解决。</li>
<li>不喜欢引入大量三方插件<br>典型的比如路由，JS异步加载，UI</li>
<li>大型前端项目<br>NG的模块化和依赖注入，天然支持大型多人协作项目，方便开发和单元测试。</li>
<li>非IE重度用户<br>我们有的项目还是IE8为主，导致我只能使用knockout.js来做视图数据绑定</li>
<li>注开源项目的维护氛围</li>
</ul>
<p>很显然NG是Google花了大价钱的项目，react也是Facebook的大项目，而Vue诚然是靠个人核心人员支撑。不是损谁，在这点上Vue确实劣势很大，虽然目前跟阿里的Wexx项目有了良好的合作。但是阿里的开源项目一般是三而竭的烂尾工程。这里有篇文章：<a href="https://my.oschina.net/mumu/blog/1499815，详细对比了与Vue的方方面面感觉是大陆" target="_blank" rel="external">https://my.oschina.net/mumu/blog/1499815，详细对比了与Vue的方方面面感觉是大陆</a> Angular的勤劳的布道者。</p>
<p>以上其实都是些题外话，国内的程序员就是技术阵营站位太激烈。其实适合自己就好，管别人怎么说。。。</p>
<p>下面开始进入主题<br>只要是Google的技术，因为伟大的GWF我们需要VPN翻墙。如果没有我们可以改hosts文件。</p>
<h2 id="环境准备："><a href="#环境准备：" class="headerlink" title="环境准备："></a>环境准备：</h2><p>本篇不是0入门的指导文章，所以怎么安装自行查询资料。</p>
<h3 id="1，安装Nodejs"><a href="#1，安装Nodejs" class="headerlink" title="1，安装Nodejs"></a>1，安装Nodejs</h3><p><a href="https://nodejs.org/en/download/，选择适合自己OS的版本安装。" target="_blank" rel="external">https://nodejs.org/en/download/，选择适合自己OS的版本安装。</a><br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\gongxufan&gt;node -v  </span><br><span class="line">v6.11.0  </span><br><span class="line">  </span><br><span class="line">C:\Users\gongxufan&gt;npm -v  </span><br><span class="line">3.10.10</span><br></pre></td></tr></table></figure></p>
<h3 id="2，安装cnpm"><a href="#2，安装cnpm" class="headerlink" title="2，安装cnpm"></a>2，安装cnpm</h3><p>墙的存在，还是使用阿里的镜像服务吧，地址：<a href="https://cnpmjs.org/" target="_blank" rel="external">https://cnpmjs.org/</a></p>
<h3 id="3，使用Google的搜索服务，查看NG官方文档"><a href="#3，使用Google的搜索服务，查看NG官方文档" class="headerlink" title="3，使用Google的搜索服务，查看NG官方文档"></a>3，使用Google的搜索服务，查看NG官方文档</h3><p><del>修改本机hosts，地址：<a href="https://coding.net/u/scaffrey/p/hosts/git/blob/master/hosts,这个仓库会持续更新最新可用的IP。" target="_blank" rel="external">https://coding.net/u/scaffrey/p/hosts/git/blob/master/hosts,这个仓库会持续更新最新可用的IP。</a></del></p>
<p>好啦，环境准备好了，我们可以愉快的安装cli啦。<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\gongxufan&gt;cnpm install -g @angular/cli  </span><br><span class="line">Downloading @angular/cli to C:\Users\gongxufan\AppData\Roaming\npm\node_modules\@angular\cli_tmp  </span><br><span class="line">Copying C:\Users\gongxufan\AppData\Roaming\npm\node_modules\@angular\cli_tmp\_@angular_cli@1.2.6@@angular\cli to C:\Users\gongxufan\AppData\Roaming\npm\node_modules\@angular\cli  </span><br><span class="line">Installing @angular/cli's dependencies to C:\Users\gongxufan\AppData\Roaming\npm\node_modules\@angular\cli/node_modules  </span><br><span class="line">[1/61] circular-dependency-plugin@^3.0.0 installed at node_modules\_circular-dependency-plugin@3.0.0@circular-dependency-plugin  </span><br><span class="line">[2/61] denodeify@^1.2.1 installed at node_modules\_denodeify@1.2.1@denodeify  </span><br><span class="line">[3/61] @ngtools/json-schema@1.1.0 installed at node_modules\_@ngtools_json-schema@1.1.0@@ngtools\json-schema  </span><br><span class="line">[4/61] ember-cli-string-utils@^1.0.0 installed at node_modules\_ember-cli-string-utils@1.1.0@ember-cli-string-utils  </span><br><span class="line">[5/61] core-object@^3.1.0 installed at node_modules\_core-object@3.1.3@core-object  </span><br><span class="line">[6/61] chalk@^2.0.1 installed at node_modules\_chalk@2.0.1@chalk  </span><br><span class="line">[7/61] diff@^3.1.0 installed at node_modules\_diff@3.3.0@diff  </span><br><span class="line">[8/61] file-loader@^0.10.0 installed at node_modules\_file-loader@0.10.1@file-loader  </span><br><span class="line">[9/61] ember-cli-normalize-entity-name@^1.0.0 installed at node_modules\_ember-cli-normalize-entity-name@1.0.0@ember-cli-normalize-entity-name  </span><br><span class="line">[10/61] get-caller-file@^1.0.0 installed at node_modules\_get-caller-file@1.0.2@get-caller-file  </span><br><span class="line">[11/61] exports-loader@^0.6.3 installed at node_modules\_exports-loader@0.6.4@exports-loader  </span><br><span class="line">[12/61] heimdalljs-logger@^0.1.9 installed at node_modules\_heimdalljs-logger@0.1.9@heimdalljs-logger  </span><br><span class="line">[13/61] css-loader@^0.28.1 installed at node_modules\_css-loader@0.28.4@css-loader  </span><br><span class="line">[14/61] glob@^7.0.3 installed at node_modules\_glob@7.1.2@glob  </span><br><span class="line">[15/61] inflection@^1.7.0 installed at node_modules\_inflection@1.12.0@inflection  </span><br><span class="line">[16/61] heimdalljs@^0.2.4 installed at node_modules\_heimdalljs@0.2.5@heimdalljs  </span><br><span class="line">[17/61] isbinaryfile@^3.0.0 installed at node_modules\_isbinaryfile@3.0.2@isbinaryfile  </span><br><span class="line">[18/61] fs-extra@^4.0.0 installed at node_modules\_fs-extra@4.0.1@fs-extra  </span><br><span class="line">[19/61] karma-source-map-support@^1.2.0 installed at node_modules\_karma-source-map-support@1.2.0@karma-source-map-support  </span><br><span class="line">[20/61] license-webpack-plugin@^0.4.2 installed at node_modules\_license-webpack-plugin@0.4.3@license-webpack-plugin  </span><br><span class="line">根据你的网速和运气，安装时间都不同，耐心等待哦。</span><br><span class="line">[html] view plain copy</span><br><span class="line">C:\Users\gongxufan&gt;ng -v  </span><br><span class="line">    _                      _                 ____ _     ___  </span><br><span class="line">   / \   _ __   __ _ _   _| | __ _ _ __     / ___| |   |_ _|  </span><br><span class="line">  / △ \ | '_ \ / _` | | | | |/ _` | '__|   | |   | |    | |  </span><br><span class="line"> / ___ \| | | | (_| | |_| | | (_| | |      | |___| |___ | |  </span><br><span class="line">/_/   \_\_| |_|\__, |\__,_|_|\__,_|_|       \____|_____|___|  </span><br><span class="line">               |___/  </span><br><span class="line">@angular/cli: 1.2.6  </span><br><span class="line">node: 6.11.0  </span><br><span class="line">os: win32 x64</span><br></pre></td></tr></table></figure></p>
<p>哈哈，弄好了，还来个非主流的log。</p>
<h2 id="体验NG"><a href="#体验NG" class="headerlink" title="体验NG"></a>体验NG</h2><p>有了脚手架程序，我们可以方便的新建项目，新建组件和单元测试啦。<br><code>D:\code\learn\angualr&gt;ng set --global packageManager=cnpm</code></p>
<p>首先我们设置好NG的全局依赖包管理器为cnpm，否则新建项目的时候默认使用npm导致依赖包下载失败。接着正式创建项目：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">D:\code\learn\angualr&gt;ng new first-ng-prj  </span><br><span class="line">installing ng  </span><br><span class="line">  create .editorconfig  </span><br><span class="line">  create README.md  </span><br><span class="line">  create src\app\app.component.css  </span><br><span class="line">  create src\app\app.component.html  </span><br><span class="line">  create src\app\app.component.spec.ts  </span><br><span class="line">  create src\app\app.component.ts  </span><br><span class="line">  create src\app\app.module.ts  </span><br><span class="line">  create src\assets\.gitkeep  </span><br><span class="line">  create src\environments\environment.prod.ts  </span><br><span class="line">  create src\environments\environment.ts  </span><br><span class="line">  create src\favicon.ico  </span><br><span class="line">  create src\index.html  </span><br><span class="line">  create src\main.ts  </span><br><span class="line">  create src\polyfills.ts  </span><br><span class="line">  create src\styles.css  </span><br><span class="line">  create src\test.ts  </span><br><span class="line">  create src\tsconfig.app.json  </span><br><span class="line">  create src\tsconfig.spec.json  </span><br><span class="line">  create src\typings.d.ts  </span><br><span class="line">  create .angular-cli.json  </span><br><span class="line">  create e2e\app.e2e-spec.ts  </span><br><span class="line">  create e2e\app.po.ts  </span><br><span class="line">  create e2e\tsconfig.e2e.json  </span><br><span class="line">  create .gitignore  </span><br><span class="line">  create karma.conf.js  </span><br><span class="line">  create package.json  </span><br><span class="line">  create protractor.conf.js  </span><br><span class="line">  create tsconfig.json  </span><br><span class="line">  create tslint.json  </span><br><span class="line">Installing packages for tooling via cnpm.  </span><br><span class="line">Installed packages for tooling via cnpm.  </span><br><span class="line">Successfully initialized git.  </span><br><span class="line">Project 'first-ng-prj' successfully created.</span><br></pre></td></tr></table></figure></p>
<p>耐心等待依赖包的下载，如果一切顺利就可以测试啦。开始启动程序测试：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">D:\code\learn\angualr&gt;cd first-ng-prj &amp;&amp; ng serve --open  </span><br><span class="line">** NG Live Development Server is listening on localhost:4200, open your browser on http://localhost:4200 **  </span><br><span class="line"> 10% building modules 8/11 modules 3 active ...ader@0.13.2@style-loader\addStyles.jsHash: bc29b49835d5d651317a  </span><br><span class="line">Time: 10929ms  </span><br><span class="line">chunk    &#123;0&#125; polyfills.bundle.js, polyfills.bundle.js.map (polyfills) 177 kB &#123;4&#125; [initial] [rendered]  </span><br><span class="line">chunk    &#123;1&#125; main.bundle.js, main.bundle.js.map (main) 5.36 kB &#123;3&#125; [initial] [rendered]  </span><br><span class="line">chunk    &#123;2&#125; styles.bundle.js, styles.bundle.js.map (styles) 10.7 kB &#123;4&#125; [initial] [rendered]  </span><br><span class="line">chunk    &#123;3&#125; vendor.bundle.js, vendor.bundle.js.map (vendor) 2.19 MB [initial] [rendered]  </span><br><span class="line">chunk    &#123;4&#125; inline.bundle.js, inline.bundle.js.map (inline) 0 bytes [entry] [rendered]  </span><br><span class="line">webpack: Compiled successfully.</span><br></pre></td></tr></table></figure></p>
<p>如果一切顺利，就会打开系统默认浏览器显示我们的项目,至此NG的环境搭建完毕。</p>
<h2 id="NG代码结构"><a href="#NG代码结构" class="headerlink" title="NG代码结构"></a>NG代码结构</h2><p>通过cli程序，会创建标准的NG的项目文件<br>整个目录结构如下图所示<br><img src="/upload/images/angular/jiegou.png" alt="img"></p>
<h3 id="文件说明"><a href="#文件说明" class="headerlink" title="文件说明"></a>文件说明</h3><p>e2e/<br>在e2e/下是端到端（End-to-End）测试。 它们不在src/下，是因为端到端测试实际上和应用是相互独立的，它只适用于测试你的应用而已。 这也就是为什么它会拥有自己的tsconfig.json。</p>
<p>node_modules/<br>Node.js创建了这个文件夹，并且把package.json中列举的所有第三方模块都放在其中。</p>
<p>.angular-cli.json<br>Angular CLI的配置文件。 在这个文件中，我们可以设置一系列默认值，还可以配置项目编译时要包含的那些文件。 要了解更多，请参阅它的官方文档。</p>
<p>.editorconfig<br>给你的编辑器看的一个简单配置文件，它用来确保参与你项目的每个人都具有基本的编辑器配置。 大多数的编辑器都支持.editorconfig文件，详情参见 <a href="http://editorconfig.org" target="_blank" rel="external">http://editorconfig.org</a> 。</p>
<p>.gitignore<br>一个Git的配置文件，用来确保某些自动生成的文件不会被提交到源码控制系统中。</p>
<p>karma.conf.js<br>给Karma的单元测试配置，当运行ng test时会用到它。</p>
<p>package.json<br>npm配置文件，其中列出了项目使用到的第三方依赖包。 你还可以在这里添加自己的自定义脚本。</p>
<p>protractor.conf.js<br>给Protractor使用的端到端测试配置文件，当运行ng e2e的时候会用到它。</p>
<p>README.md<br>项目的基础文档，预先写入了CLI命令的信息。 别忘了用项目文档改进它，以便每个查看此仓库的人都能据此构建出你的应用。</p>
<p>tsconfig.json<br>TypeScript编译器的配置，你的IDE会借助它来给你提供更好的帮助。</p>
<p>tslint.json<br>给TSLint和Codelyzer用的配置信息，当运行ng lint时会用到。 Lint功能可以帮你保持代码风格的统一。<br>src是我们业务代码文件夹，结构如下</p>
<p>app/app.component.{ts,html,css,spec.ts}<br>使用HTML模板、CSS样式和单元测试定义AppComponent组件。 它是根组件，随着应用的成长它会成为一棵组件树的根节点。</p>
<p>app/app.module.ts<br>定义AppModule，这个根模块会告诉Angular如何组装该应用。 目前，它只声明了AppComponent。 稍后它还会声明更多组件。</p>
<p>assets/*<br>这个文件夹下你可以放图片等任何东西，在构建应用时，它们全都会拷贝到发布包中。</p>
<p>environments/*<br>这个文件夹中包括为各个目标环境准备的文件，它们导出了一些应用中要用到的配置变量。 这些文件会在构建应用时被替换。 比如你可能在产品环境中使用不同的API端点地址，或使用不同的统计Token参数。 甚至使用一些模拟服务。 所有这些，CLI都替你考虑到了。</p>
<p>favicon.ico<br>每个网站都希望自己在书签栏中能好看一点。 请把它换成你自己的图标。</p>
<p>index.html<br>这是别人访问你的网站是看到的主页面的HTML文件。 大多数情况下你都不用编辑它。 在构建应用时，CLI会自动把所有js和css文件添加进去，所以你不必在这里手动添加任何 <script> 或 <link> 标签。</p>
<p>main.ts<br>这是应用的主要入口点。 使用JIT compiler编译器编译本应用，并启动应用的根模块AppModule，使其运行在浏览器中。 你还可以使用AOT compiler编译器，而不用修改任何代码 —— 只要给ng build或 ng serve 传入 –aot 参数就可以了。</p>
<p>polyfills.ts<br>不同的浏览器对Web标准的支持程度也不同。 填充库（polyfill）能帮我们把这些不同点进行标准化。 你只要使用core-js 和 zone.js通常就够了，不过你也可以查看浏览器支持指南以了解更多信息。</p>
<p>styles.css<br>这里是你的全局样式。 大多数情况下，你会希望在组件中使用局部样式，以利于维护，不过那些会影响你整个应用的样式你还是需要集中存放在这里。</p>
<p>test.ts<br>这是单元测试的主要入口点。 它有一些你不熟悉的自定义配置，不过你并不需要编辑这里的任何东西。</p>
<p>tsconfig.{app|spec}.json<br>TypeScript编译器的配置文件。tsconfig.app.json是为Angular应用准备的，而tsconfig.spec.json是为单元测试准备的。</p>
<p>##修改我们的页面<br>编辑./src/app/app.component.ts,修改标题如下：<br><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Component &#125; <span class="keyword">from</span> <span class="string">'@angular/core'</span>;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@Component</span>(&#123;  </span><br><span class="line">  selector: <span class="string">'app-root'</span>,  </span><br><span class="line">  templateUrl: <span class="string">'./app.component.html'</span>,  </span><br><span class="line">  styleUrls: [<span class="string">'./app.component.css'</span>]  </span><br><span class="line">&#125;)  </span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AppComponent &#123;  </span><br><span class="line">  title = <span class="string">'我的第一个NG程序'</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>保存后切换到浏览器发现更改生效了。</p>
<h2 id="end"><a href="#end" class="headerlink" title="end"></a>end</h2></script></p>]]></content>
      
        <categories>
            
            <category> 随笔 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> angular </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[归并排序Java实现]]></title>
      <url>/2016/03/10/merge-sort/</url>
      <content type="html"><![CDATA[<p>具体算法是参考算法导论，这里只是我自己的实现的记录。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> sort;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 归并排序</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auth</span> gongxufan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2017/8/2</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MergeSort</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * p&lt;=q&lt;r,A[p..q]和A[q+1..r]都已排好序</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> A 输入</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> p 待合并数组的下界位置</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> q 分割位置</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> r 待合并数组的上界位置</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">mergeWithGuard</span><span class="params">(<span class="keyword">int</span>[] A, <span class="keyword">int</span> p, <span class="keyword">int</span> q, <span class="keyword">int</span> r)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//A[p..q]的数组长度</span></span><br><span class="line">        <span class="keyword">int</span> n1 = q - p + <span class="number">1</span>;</span><br><span class="line">        <span class="comment">//A[q+1..r]的数组长度</span></span><br><span class="line">        <span class="keyword">int</span> n2 = r - q;</span><br><span class="line">        <span class="comment">//构建两个数组</span></span><br><span class="line">        <span class="keyword">int</span>[] L = <span class="keyword">new</span> <span class="keyword">int</span>[n1 + <span class="number">1</span>];</span><br><span class="line">        <span class="keyword">int</span>[] R = <span class="keyword">new</span> <span class="keyword">int</span>[n2 + <span class="number">1</span>];</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>, j = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">//初始化</span></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; n1; i++)</span><br><span class="line">            L[i] = A[p + i];</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; n2; j++)</span><br><span class="line">            R[j] = A[q + j + <span class="number">1</span>];</span><br><span class="line">        <span class="comment">//设置哨兵,防止越界</span></span><br><span class="line">        L[n1] = Integer.MAX_VALUE;</span><br><span class="line">        R[n2] = Integer.MAX_VALUE;</span><br><span class="line">        <span class="comment">//索引清零</span></span><br><span class="line">        i = j = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">//最多执行执行r-p次,就可以合并完成</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> k = p; k &lt;= r; k++) &#123;</span><br><span class="line">            <span class="comment">//如果L或者R复制完毕，则下一个元素就是哨兵位置,可以避免数组越界访问</span></span><br><span class="line">            <span class="keyword">if</span> (L[i] &lt;= R[j]) &#123;</span><br><span class="line">                A[k] = L[i++];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                A[k] = R[j++];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"L:"</span> + Arrays.toString(L) + <span class="string">",R:"</span> + Arrays.toString(R));</span><br><span class="line">        System.out.println(<span class="string">"Merge Result:"</span> + Arrays.toString(A));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 不使用哨兵</span></span><br><span class="line"><span class="comment">     * p&lt;=q&lt;r,A[p..q]和A[q+1..r]都已排好序</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> A 输入</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> p 待合并数组的下界位置</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> q 分割位置</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> r 待合并数组的上界位置</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">mergeWithoutGuard</span><span class="params">(<span class="keyword">int</span>[] A, <span class="keyword">int</span> p, <span class="keyword">int</span> q, <span class="keyword">int</span> r)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//A[p..q]的数组长度</span></span><br><span class="line">        <span class="keyword">int</span> n1 = q - p + <span class="number">1</span>;</span><br><span class="line">        <span class="comment">//A[q+1..r]的数组长度</span></span><br><span class="line">        <span class="keyword">int</span> n2 = r - q;</span><br><span class="line">        <span class="comment">//构建两个数组</span></span><br><span class="line">        <span class="keyword">int</span>[] L = <span class="keyword">new</span> <span class="keyword">int</span>[n1];</span><br><span class="line">        <span class="keyword">int</span>[] R = <span class="keyword">new</span> <span class="keyword">int</span>[n2];</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>, j = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">//初始化</span></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; n1; i++)</span><br><span class="line">            L[i] = A[p + i];</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; n2; j++)</span><br><span class="line">            R[j] = A[q + j + <span class="number">1</span>];</span><br><span class="line">        <span class="keyword">int</span> k = p;</span><br><span class="line">        i = j = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">//分别复制L R,其中一个复制完成立即结束</span></span><br><span class="line">        <span class="keyword">while</span> (i &lt; n1 &amp;&amp; j &lt; n2)&#123;</span><br><span class="line">            <span class="keyword">if</span> (L[i] &lt;= R[j]) &#123;</span><br><span class="line">                A[k++] = L[i++];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                A[k++] = R[j++];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//L或者R复制完毕，剩下的元素再复制。已经复制完成的会跳过</span></span><br><span class="line">        <span class="keyword">while</span> (i &lt; n1)</span><br><span class="line">            A[k++] = L[i++];</span><br><span class="line">        <span class="keyword">while</span> (j &lt; n2)</span><br><span class="line">            A[k++] = R[j++];</span><br><span class="line">        System.out.println(<span class="string">"L:"</span> + Arrays.toString(L) + <span class="string">",R:"</span> + Arrays.toString(R));</span><br><span class="line">        System.out.println(<span class="string">"Merge Result:"</span> + Arrays.toString(A));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">mergeSort</span><span class="params">(<span class="keyword">int</span>[] A, <span class="keyword">int</span> p, <span class="keyword">int</span> r)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (p &lt; r) &#123;</span><br><span class="line">            System.out.println(<span class="string">"当前排序的数组:"</span> + Arrays.toString(Arrays.copyOfRange(A, p, r)));</span><br><span class="line">            <span class="keyword">int</span> q = (p + r) / <span class="number">2</span>;</span><br><span class="line">            mergeSort(A, p, q);</span><br><span class="line">            mergeSort(A, q + <span class="number">1</span>, r);</span><br><span class="line">            mergeWithoutGuard(A, p, q, r);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testMerge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span>[] A = <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;<span class="number">3</span>&#125;;</span><br><span class="line">        <span class="keyword">int</span> p = <span class="number">0</span>, r = <span class="number">0</span>, q = (p + r) / <span class="number">2</span>;</span><br><span class="line">        mergeWithGuard(A, p, q, r);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testMergeSort</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span>[] A = <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;<span class="number">10</span>, <span class="number">4</span>, <span class="number">1</span>, -<span class="number">1</span>, <span class="number">8</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">0</span>, -<span class="number">5</span>&#125;;</span><br><span class="line">        mergeSort(A, <span class="number">0</span>, A.length - <span class="number">1</span>);</span><br><span class="line">        System.out.println(<span class="string">"Sort Result:"</span> + Arrays.toString(A));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>合并的实现采用了两种方式，一种是使用哨兵，一种是合并分两步。</p>
]]></content>
      
        <categories>
            
            <category> 随笔 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> 算法 </tag>
            
        </tags>
        
    </entry>
    
  
  
</search>
